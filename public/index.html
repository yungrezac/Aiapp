<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI Web App Builder</title>
    
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключение Prism.js для подсветки синтаксиса -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    
    <!-- Подключение Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Подключение Ton Connect UI SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- Подключение MD5 (необходимо для хеширования, т.к. SubtleCrypto его не поддерживает) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

    <!-- Стили приложения -->
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --tg-header-bg: var(--tg-theme-header-bg-color, #ffffff);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .chat-bubble { max-width: 85%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; line-height: 1.4; }
        .user-bubble { background-color: var(--tg-button); color: var(--tg-button-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: var(--tg-secondary-bg); color: var(--tg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .nav-button.active { color: var(--tg-button); }
        .sub-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }
        .tool-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }
        .btn-transition { transition: background-color 0.2s, opacity 0.2s, transform 0.1s; }
        .btn-transition:active { transform: scale(0.95); }
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
        .shake-it { animation: shake 0.3s ease-in-out; }
        pre[class*="language-"] { background: #2d2d2d; margin: 0; border-radius: 0; }
        code[class*="language-"] { font-size: 14px; line-height: 1.5; }
        #history-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 40; }
        #history-modal-overlay.active { opacity: 1; visibility: visible; }
        #history-modal-panel { position: fixed; left: 0; right: 0; bottom: 0; height: 75vh; background-color: var(--tg-bg); border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 50; display: flex; flex-direction: column; padding: 1rem; box-shadow: 0 -10px 25px -5px rgba(0,0,0,0.1), 0 -8px 10px -6px rgba(0,0,0,0.1); }
        #history-modal-panel.active { transform: translateY(0); }
        .tool-content { display: none; }
        .tool-content.active { display: block; animation: fadeIn 0.3s; }
        #color-picker { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 100%; height: 40px; border: none; cursor: pointer; background-color: transparent; }
        #color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        #color-picker::-webkit-color-swatch { border: 1px solid var(--tg-hint); border-radius: 0.5rem; }
        .skeleton { background-color: var(--tg-secondary-bg); border-radius: 0.5rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Глобальный загрузчик -->
    <div id="global-loader" class="absolute inset-0 bg-[var(--tg-bg)] bg-opacity-80 flex flex-col items-center justify-center z-[100]">
        <div class="loader" style="width: 48px; height: 48px;"></div>
        <p id="loader-message" class="mt-4 text-lg font-semibold text-[var(--tg-text)]">Подключаемся...</p>
    </div>

    <!-- Основной контейнер для страниц -->
    <main class="flex-grow overflow-hidden flex flex-col min-h-0">
        <!-- СТРАНИЦА 1: ЧАТ С ИИ -->
        <div id="chat-page" class="page active flex-col h-full">
            <div class="flex-shrink-0 flex justify-between items-center p-2 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button id="history-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="История чатов"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></button>
                <h1 id="chat-title" class="font-bold text-lg truncate px-2">Чат</h1>
                <button id="page-new-chat-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="Новый чат"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
            </div>
            <div id="chat-history" class="flex-grow p-4 flex flex-col space-y-2 overflow-y-auto"></div>
            <div class="flex-shrink-0 flex items-center space-x-2 p-2 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)]">
                <input id="prompt-input" type="text" placeholder="Ваш запрос..." class="w-full p-3 rounded-full focus:outline-none bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] placeholder-[var(--tg-hint)] transition-transform">
                <button id="generate-button" class="p-3 rounded-full transition-opacity btn-transition flex-shrink-0 bg-[var(--tg-button)] text-[var(--tg-button-text)]" aria-label="Сгенерировать"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>

        <!-- СТРАНИЦA 2: СОЗДАНИЕ (КОД + ПРЕВЬЮ) -->
        <div id="creation-page" class="page flex-col h-full">
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button data-view="code" class="sub-nav-button active w-1/2 p-4 text-center text-[var(--tg-hint)]">Код</button>
                <button data-view="preview" class="sub-nav-button w-1/2 p-4 text-center text-[var(--tg-hint)]">Превью</button>
            </div>
            <div id="code-view" class="flex-grow flex flex-col overflow-hidden">
                <div class="p-2 flex-shrink-0 flex justify-end items-center space-x-2 bg-[var(--tg-bg)] border-b border-[var(--tg-secondary-bg)]">
                    <button id="copy-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">Копировать</button>
                </div>
                <div class="flex-grow overflow-auto bg-[#2d2d2d]"><pre><code id="code-output" class="language-html text-sm p-4 block whitespace-pre-wrap font-mono"></code></pre></div>
            </div>
            <div id="preview-view" class="flex-grow hidden bg-white relative">
                <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
            </div>
        </div>

        <!-- СТРАНИЦА 3: ИНСТРУМЕНТЫ -->
        <div id="tools-page" class="page flex-col h-full">
            <div class="flex-shrink-0 p-3 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <h1 class="font-bold text-lg text-center">Инструменты</h1>
            </div>
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)] overflow-x-auto">
                <button data-tool="json" class="tool-nav-button active flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">JSON</button>
                <button data-tool="base64" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">Base64</button>
                <button data-tool="url" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">URL</button>
                <button data-tool="jwt" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">JWT</button>
                <button data-tool="regex" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">AI Regex</button>
                <button data-tool="git" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">AI Git</button>
                <button data-tool="hash" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">Hash</button>
                <button data-tool="color" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">Color</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto space-y-4">
                <!-- JSON Formatter Tool -->
                <div id="tool-json" class="tool-content active">
                    <h2 class="text-xl font-semibold mb-2">JSON Форматтер</h2>
                    <textarea id="json-input" class="w-full h-48 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="Вставьте ваш JSON сюда..."></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="json-format-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">Форматировать</button>
                        <button id="json-clear-btn" class="w-1/3 bg-gray-500 text-white py-2 rounded-lg btn-transition">Очистить</button>
                    </div>
                    <pre id="json-output" class="mt-4 p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono min-h-[5rem]"></pre>
                </div>
                <!-- Base64 Tool -->
                <div id="tool-base64" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">Base64 Кодер/Декодер</h2>
                    <textarea id="base64-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="Текст или Base64..."></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="base64-encode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">Кодировать</button>
                        <button id="base64-decode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">Декодировать</button>
                    </div>
                    <textarea id="base64-output" readonly class="w-full h-32 p-2 mt-4 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="Результат..."></textarea>
                </div>
                <!-- URL Tool -->
                <div id="tool-url" class="tool-content">
                     <h2 class="text-xl font-semibold mb-2">URL Кодер/Декодер</h2>
                    <textarea id="url-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="URL или строка..."></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="url-encode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">Кодировать</button>
                        <button id="url-decode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">Декодировать</button>
                    </div>
                    <textarea id="url-output" readonly class="w-full h-32 p-2 mt-4 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="Результат..."></textarea>
                </div>
                <!-- JWT Decoder Tool -->
                <div id="tool-jwt" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">JWT Декодер</h2>
                    <textarea id="jwt-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="Вставьте ваш JWT сюда..."></textarea>
                    <button id="jwt-decode-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">Декодировать</button>
                    <div id="jwt-output" class="mt-4 space-y-4"></div>
                </div>
                <!-- AI Regex Generator Tool -->
                <div id="tool-regex" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">AI Генератор Regex</h2>
                    <textarea id="regex-prompt" class="w-full h-24 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="Опишите, что должно делать регулярное выражение. Например: 'проверить, что строка является email адресом'"></textarea>
                    <button id="regex-generate-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition flex items-center justify-center">Сгенерировать</button>
                    <div id="regex-output-container" class="mt-4 hidden">
                        <h3 class="font-semibold">Результат:</h3>
                        <pre id="regex-output" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono"></pre>
                        <h3 class="font-semibold mt-4">Тестирование:</h3>
                        <textarea id="regex-test-string" class="w-full p-2 mt-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="Строка для теста..."></textarea>
                        <button id="regex-test-btn" class="w-full mt-2 bg-green-500 text-white py-2 rounded-lg btn-transition">Тестировать</button>
                        <div id="regex-test-result" class="mt-2 text-sm"></div>
                    </div>
                </div>
                <!-- AI Git Command Generator Tool -->
                <div id="tool-git" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">AI Генератор Git Команд</h2>
                    <textarea id="git-prompt" class="w-full h-24 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="Опишите, что вы хотите сделать с Git. Например: 'откатить последний коммит, но оставить изменения в файлах'"></textarea>
                    <button id="git-generate-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition flex items-center justify-center">Сгенерировать</button>
                    <div id="git-output-container" class="mt-4 hidden">
                        <h3 class="font-semibold">Рекомендуемая команда:</h3>
                        <pre id="git-output" class="p-3 rounded-lg bg-gray-800 text-white text-sm whitespace-pre-wrap font-mono relative"><button id="git-copy-btn" class="absolute top-2 right-2 bg-gray-600 hover:bg-gray-500 p-1 rounded-md text-xs">Копировать</button><code></code></pre>
                    </div>
                </div>
                <!-- Hash Generator Tool -->
                <div id="tool-hash" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">Генератор Хешей</h2>
                    <textarea id="hash-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="Введите строку для хеширования..."></textarea>
                    <div id="hash-output" class="mt-4 space-y-2">
                        <div>
                            <label class="font-semibold text-sm">MD5:</label>
                            <pre id="hash-md5" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono break-all"></pre>
                        </div>
                        <div>
                            <label class="font-semibold text-sm">SHA-256:</label>
                            <pre id="hash-sha256" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono break-all"></pre>
                        </div>
                    </div>
                </div>
                <!-- Color Converter Tool -->
                <div id="tool-color" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">Конвертер Цветов</h2>
                    <div class="p-4 rounded-lg bg-[var(--tg-secondary-bg)] space-y-4">
                        <input type="color" id="color-picker" value="#007aff">
                        <div class="space-y-2">
                            <div>
                                <label for="color-hex" class="font-semibold text-sm">HEX:</label>
                                <input type="text" id="color-hex" class="w-full p-2 mt-1 rounded-lg bg-[var(--tg-bg)] focus:outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label for="color-rgb" class="font-semibold text-sm">RGB:</label>
                                <input type="text" id="color-rgb" class="w-full p-2 mt-1 rounded-lg bg-[var(--tg-bg)] focus:outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label for="color-hsl" class="font-semibold text-sm">HSL:</label>
                                <input type="text" id="color-hsl" class="w-full p-2 mt-1 rounded-lg bg-[var(--tg-bg)] focus:outline-none font-mono text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- СТРАНИЦА 4: ПРОФИЛЬ -->
        <div id="profile-page" class="page p-4 overflow-y-auto flex-col h-full space-y-4">
            <div id="user-profile-card" class="flex items-center justify-between space-x-4 p-4 bg-[var(--tg-secondary-bg)] rounded-xl">
                <div class="flex items-center space-x-4 min-w-0">
                    <img id="user-avatar" src="https://placehold.co/64x64/EFEFEF/333333?text=U" class="w-16 h-16 rounded-full object-cover bg-gray-300 flex-shrink-0">
                    <div class="flex-grow min-w-0">
                        <h2 id="user-fullname" class="text-xl font-bold truncate">Имя пользователя</h2>
                        <p id="user-username" class="text-sm text-[var(--tg-hint)] truncate">@username</p>
                    </div>
                </div>
                <div id="ton-connect-container" class="flex-shrink-0"></div>
            </div>

            <div id="subscription-status" class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl"></div>
            
            <div class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl space-y-3">
                <h3 class="text-lg font-bold">Пригласите друзей</h3>
                <p class="text-sm text-[var(--tg-hint)]">Пригласите друга и получите бонус! Вы получите 1 генерацию за каждого нового пользователя и 10 генераций, если он оформит подписку. Ваш друг получит 1 бонусную генерацию сразу после перехода по ссылке.</p>
                <div class="flex items-center space-x-2">
                    <input id="referral-link-input" type="text" readonly class="w-full p-2 rounded-lg focus:outline-none bg-[var(--tg-bg)] text-sm">
                    <button id="copy-referral-link-button" class="p-2 rounded-lg bg-[var(--tg-button)] text-[var(--tg-button-text)] btn-transition flex-shrink-0"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                </div>
                <button id="invite-friend-button" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] font-bold py-2 px-4 rounded-lg btn-transition">Пригласить</button>
            </div>
            <div id="referral-list-section" class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl space-y-3">
                <div class="flex items-center justify-between">
                     <h3 class="text-lg font-bold">Приглашенные вами</h3>
                     <span id="referral-count" class="text-sm font-bold bg-[var(--tg-button)] text-[var(--tg-button-text)] px-2 py-1 rounded-full">0</span>
                </div>
                <div id="referral-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <p class="text-sm text-[var(--tg-hint)]">У вас пока нет рефералов.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- НИЖНЯЯ НАВИГАЦИОННАЯ ПАНЕЛЬ -->
    <footer class="flex-shrink-0 h-20 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)] flex justify-around items-center">
        <button data-page="chat-page" class="nav-button active flex flex-col items-center justify-center p-2 h-full" aria-label="Чат"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="text-xs">Чат</span></button>
        <button data-page="creation-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="Создание"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg><span class="text-xs">Создание</span></button>
        <button data-page="tools-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="Инструменты">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="text-xs">Инструменты</span>
        </button>
        <button data-page="profile-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="Профиль"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="text-xs">Профиль</span></button>
    </footer>

    <!-- Модальное окно истории чатов -->
    <div id="history-modal-overlay"></div>
    <div id="history-modal-panel">
        <div class="flex justify-between items-center mb-4 flex-shrink-0">
            <h3 class="text-xl font-bold">История чатов</h3>
            <button id="close-history-modal-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="Закрыть">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <div id="chat-list" class="space-y-2 overflow-y-auto flex-grow">
            <!-- Skeleton Loader for Chat List -->
            <div class="space-y-2">
                <div class="h-16 w-full skeleton"></div>
                <div class="h-16 w-full skeleton"></div>
                <div class="h-16 w-full skeleton"></div>
            </div>
        </div>
    </div>
    
    <!-- Подключение Prism.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            // --- КОНФИГУРАЦИЯ ---
            config: {
                botUsername: 'yr_dev_bot', // Замените на имя вашего бота
                appName: 'aiyrf', // Имя вашего Mini App
                supabaseUrl: 'https://mhwzgpexajfqqtlgivfc.supabase.co',
                supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1od3pncGV4YWpmcXF0bGdpdmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMzU1ODAsImV4cCI6MjA2OTYxMTU4MH0.jmmkJ2gsfRMVOo3KVTHYS2u8IIoBUH7D5ZemZowwpzE',
                maxDailyGenerations: 3,
                maxMonthlyGenerations: 30,
                maxDailyChats: 5,
                tonRecipientAddress: 'UQA-NjtXmWz0-GFB59p2jSjdBXtq4H9qDo6-N2xvDCsC9NTL', // Адрес для получения платежей TON
                tonSubscriptionPrice: '5000000000', // Цена подписки в нано-TON (5 TON)
                geminiModel: 'gemini-1.5-flash-latest' // Модель Gemini
            },
            // --- СОСТОЯНИЕ ПРИЛОЖЕНИЯ ---
            state: {
                userProfile: null,
                chats: [],
                activeChat: null,
                isGenerating: false,
                isColorUpdating: false,
                isInitialized: false,
                debounceTimer: null,
            },
            // --- ЭЛЕМЕНТЫ DOM ---
            elements: {},
            // --- ИНСТАНСЫ SDK ---
            tg: window.Telegram.WebApp,
            supabase: null,
            tonConnectUI: null,

            // --- ИНИЦИАЛИЗАЦИЯ ПРИЛОЖЕНИЯ ---
            async init() {
                try {
                    this.tg.ready();
                    this.tg.expand();
                    this.cacheDOMElements();
                    this.eventManager.addEventListeners();
                    this.ui.showGlobalLoader('Подключаемся...');

                    this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseAnonKey);
                    
                    if (!this.tg.initDataUnsafe.user?.id) {
                        throw new Error("Не удалось получить данные пользователя Telegram. Пожалуйста, перезапустите приложение.");
                    }

                    this.tonManager.init();
                    this.toolsManager.init();

                    this.ui.showGlobalLoader('Загрузка данных...');
                    await this.dataManager.loadInitialData();
                    
                    await this.ui.showWelcomePopupIfNeeded();
                    await this.referralManager.processNewReferral();

                    this.state.isInitialized = true;
                    this.ui.renderAll();
                    this.ui.hideGlobalLoader();
                    console.log("App Initialized. User:", this.tg.initDataUnsafe.user);

                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.ui.showGlobalLoader(`Ошибка: ${error.message}`, true);
                    this.tg.HapticFeedback.notificationOccurred('error');
                }
            },

            cacheDOMElements() {
                const ids = [
                    'chat-page', 'creation-page', 'profile-page', 'tools-page',
                    'chat-history', 'prompt-input', 'generate-button', 'code-view', 
                    'preview-view', 'code-output', 'preview-iframe', 'copy-button', 
                    'subscription-status', 'chat-list', 'chat-title', 'history-button', 
                    'page-new-chat-button', 'history-modal-overlay', 'history-modal-panel',
                    'user-profile-card', 'user-avatar', 'user-fullname', 'user-username',
                    'copy-referral-link-button', 'referral-link-input', 'invite-friend-button',
                    'referral-list-section', 'referral-list', 'referral-count',
                    'global-loader', 'loader-message', 'ton-connect-container',
                    'tool-json', 'json-input', 'json-format-btn', 'json-clear-btn', 'json-output',
                    'tool-base64', 'base64-input', 'base64-encode-btn', 'base64-decode-btn', 'base64-output',
                    'tool-url', 'url-input', 'url-encode-btn', 'url-decode-btn', 'url-output',
                    'tool-jwt', 'jwt-input', 'jwt-decode-btn', 'jwt-output',
                    'tool-regex', 'regex-prompt', 'regex-generate-btn', 'regex-output-container', 'regex-output', 'regex-test-string', 'regex-test-btn', 'regex-test-result',
                    'tool-git', 'git-prompt', 'git-generate-btn', 'git-output-container', 'git-output', 'git-copy-btn',
                    'tool-hash', 'hash-input', 'hash-output', 'hash-md5', 'hash-sha256',
                    'tool-color', 'color-picker', 'color-hex', 'color-rgb', 'color-hsl',
                    'close-history-modal-button'
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.elements[camelCaseId] = document.getElementById(id);
                });
                this.elements.pages = document.querySelectorAll('.page');
                this.elements.navButtons = document.querySelectorAll('.nav-button');
                this.elements.subNavButtons = document.querySelectorAll('#creation-page .sub-nav-button');
                this.elements.toolNavButtons = document.querySelectorAll('.tool-nav-button');
                this.elements.toolContents = document.querySelectorAll('.tool-content');
            },
            
            // --- МОДУЛЬ УПРАВЛЕНИЯ ДАННЫМИ ---
            dataManager: {
                async loadInitialData() {
                    const user = App.tg.initDataUnsafe.user;
                    let profile = await this.getProfile(user.id);

                    if (!profile) {
                        profile = await this.createNewUserProfile(user);
                    }

                    profile = this.resetLimitsIfNeeded(profile);
                    App.state.userProfile = profile;
                    
                    await this.loadChats(user.id);
                    if (App.state.chats.length > 0) {
                        await this.loadActiveChat(App.state.chats[0].id);
                    } else {
                        await App.chatManager.createNewChat(false); // Создаем первый чат без проверки лимитов
                    }
                },

                async getProfile(userId) {
                    const { data, error } = await App.supabase.from('profiles').select('*').eq('id', userId).single();
                    if (error && error.code !== 'PGRST116') throw new Error(`Ошибка загрузки профиля: ${error.message}`);
                    return data;
                },

                async createNewUserProfile(user) {
                    const { data, error } = await App.supabase.from('profiles').insert({
                        id: user.id,
                        username: user.username,
                        full_name: `${user.first_name || ''} ${user.last_name || ''}`.trim(),
                        photo_url: user.photo_url,
                        updated_at: new Date().toISOString(),
                        bonus_generations: App.tg.initDataUnsafe.start_param ? 1 : 0,
                        has_seen_welcome_popup: false
                    }).select().single();
                    if (error) throw new Error(`Ошибка создания профиля: ${error.message}`);
                    return data;
                },

                resetLimitsIfNeeded(profile) {
                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
                    const currentMonth = now.getMonth();

                    const lastGenReset = profile.daily_generations_last_reset || todayStart;
                    if (new Date(lastGenReset) < new Date(todayStart)) {
                        profile.daily_generations_count = 0;
                        profile.daily_generations_last_reset = todayStart;
                    }

                    const lastChatReset = profile.daily_chats_last_reset || todayStart;
                    if (new Date(lastChatReset) < new Date(todayStart)) {
                        profile.daily_chats_count = 0;
                        profile.daily_chats_last_reset = todayStart;
                    }
                    
                    const lastMonthlyReset = profile.monthly_generations_last_reset || todayStart;
                    if (new Date(lastMonthlyReset).getMonth() !== currentMonth) {
                        profile.monthly_generations_count = 0;
                        profile.monthly_generations_last_reset = now.toISOString();
                    }
                    
                    // Не обновляем в БД сразу, а возвращаем измененный объект. Обновление произойдет при первой необходимости.
                    return profile;
                },
                
                async loadChats(userId) {
                    const { data, error } = await App.supabase.from('chats').select('id, title, created_at').eq('user_id', userId).order('created_at', { ascending: false });
                    if (error) throw new Error(`Ошибка загрузки чатов: ${error.message}`);
                    App.state.chats = data || [];
                },

                async loadActiveChat(chatId) {
                    const { data, error } = await App.supabase.from('chats').select('*').eq('id', chatId).single();
                    if (error) {
                        console.error(`Failed to load chat ${chatId}:`, error);
                        App.ui.showPopup({ title: 'Ошибка', message: 'Не удалось загрузить чат.' });
                        // Если активный чат не загрузился, пытаемся загрузить следующий или создать новый
                        const chatIndex = App.state.chats.findIndex(c => c.id === chatId);
                        App.state.chats.splice(chatIndex, 1);
                        if (App.state.chats.length > 0) {
                           await this.loadActiveChat(App.state.chats[0].id);
                        } else {
                           await App.chatManager.createNewChat(false);
                        }
                        return;
                    }
                    App.state.activeChat = data;
                },

                async saveActiveChat() {
                    if (!App.state.activeChat) return;
                    const { id, title, messages, generated_code } = App.state.activeChat;
                    const { error } = await App.supabase.from('chats').update({ title, messages, generated_code }).eq('id', id);
                    if (error) console.error('Failed to save chat:', error);
                },

                async updateUserProfile(updates) {
                    const { data, error } = await App.supabase.from('profiles').update(updates).eq('id', App.state.userProfile.id).select().single();
                    if (error) {
                        console.error('Failed to update profile:', error);
                        return null;
                    }
                    App.state.userProfile = data; // Обновляем локальное состояние
                    return data;
                },
                
                async deleteChat(chatId) {
                    const { error } = await App.supabase.from('chats').delete().eq('id', chatId);
                    if (error) {
                         console.error('Failed to delete chat:', error);
                         App.ui.showPopup({ title: 'Ошибка', message: 'Не удалось удалить чат.' });
                         return false;
                    }
                    return true;
                }
            },
            
            // --- МОДУЛЬ УПРАВЛЕНИЯ ИНТЕРФЕЙСОМ ---
            ui: {
                renderAll() {
                    if (!App.state.isInitialized) return;
                    this.renderActiveChat();
                    this.renderProfilePage();
                    this.renderChatList();
                },
                renderActiveChat() {
                    const chat = App.state.activeChat;
                    if (!chat) {
                        App.elements.chatTitle.textContent = 'Загрузка...';
                        App.elements.chatHistory.innerHTML = '<div class="h-16 w-3/4 skeleton self-start"></div><div class="h-16 w-3/4 skeleton self-end"></div>';
                        return;
                    };
                    
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.chatHistory.innerHTML = '';
                    chat.messages.forEach(msg => this.addMessageToChat(msg.text, msg.sender));
                    
                    App.elements.codeOutput.textContent = chat.generated_code || "// Код появится здесь после генерации";
                    Prism.highlightElement(App.elements.codeOutput);

                    App.elements.previewIframe.srcdoc = chat.generated_code;
                },
                renderProfilePage() {
                    this.renderUserProfile();
                    this.renderSubscriptionStatus();
                    this.renderReferralSection();
                    this.renderReferralList();
                },
                renderUserProfile() {
                    const user = App.tg.initDataUnsafe.user;
                    if (!user) return;
                    App.elements.userAvatar.src = user.photo_url || `https://placehold.co/64x64/EFEFEF/333333?text=${user.first_name.charAt(0)}`;
                    App.elements.userAvatar.onerror = () => { App.elements.userAvatar.src = `https://placehold.co/64x64/EFEFEF/333333?text=${user.first_name.charAt(0)}` };
                    App.elements.userFullname.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Anonymous';
                    App.elements.userUsername.textContent = user.username ? `@${user.username}` : 'No username';
                },
                renderSubscriptionStatus() {
                    const profile = App.state.userProfile;
                    if (!profile) return;

                    const { subscription_is_active, subscription_end_date } = profile;
                    const el = App.elements.subscriptionStatus;

                    if (subscription_is_active && new Date(subscription_end_date) > new Date()) {
                        el.innerHTML = `
                            <h3 class="text-lg font-bold text-green-500">PRO-доступ активен</h3>
                            <p class="text-sm text-[var(--tg-text)]">Все лимиты сняты. Спасибо за поддержку!</p>
                            <p class="text-xs text-[var(--tg-hint)] mt-2">Истекает: ${new Date(subscription_end_date).toLocaleDateString()}</p>
                        `;
                    } else {
                        const { daily_generations_count, monthly_generations_count, daily_chats_count, bonus_generations } = profile;
                        const { maxDailyGenerations, maxMonthlyGenerations, maxDailyChats } = App.config;
                        
                        const priceInTon = parseInt(App.config.tonSubscriptionPrice) / 1_000_000_000;
                        const checkIcon = `<svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;

                        el.innerHTML = `
                            <div class="grid grid-cols-2 gap-4 text-center mb-4">
                                <div>
                                    <p class="text-sm">Генераций сегодня:</p>
                                    <p class="text-2xl font-bold">${maxDailyGenerations - daily_generations_count} / ${maxDailyGenerations}</p>
                                </div>
                                <div>
                                    <p class="text-sm">Новых чатов сегодня:</p>
                                    <p class="text-2xl font-bold">${maxDailyChats - daily_chats_count} / ${maxDailyChats}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm">Генераций в этом месяце:</p>
                                    <p class="text-lg font-bold">${maxMonthlyGenerations - monthly_generations_count} / ${maxMonthlyGenerations}</p>
                                    ${bonus_generations > 0 ? `<p class="text-sm text-blue-500 mt-1">Бонусных генераций: ${bonus_generations}</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="border-t border-[var(--tg-hint)] opacity-20 my-4"></div>

                            <div>
                                <h3 class="text-lg font-bold text-center mb-3">Получите PRO-доступ</h3>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center space-x-3">${checkIcon}<span><strong>Безлимитные</strong> генерации и чаты</span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>Доступ к самым <strong>продвинутым моделям ИИ</strong></span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span><strong>Приоритетная</strong> обработка запросов</span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>Поддержка и развитие проекта</span></li>
                                </ul>
                            </div>

                            <button id="subscribe-button" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg btn-transition flex items-center justify-center text-base">
                                <svg class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.015 5.912a.647.647 0 01.916-.03L12.99 8.87a.645.645 0 010 1.02l-4.06 2.988a.647.647 0 01-.915-.99l3.14-2.306-3.14-2.305a.647.647 0 01.03-.96z" clip-rule="evenodd" /></svg>
                                Разблокировать PRO за ${priceInTon} TON
                            </button>
                        `;
                        document.getElementById('subscribe-button')?.addEventListener('click', () => App.paymentManager.initiateSubscription());
                    }
                },
                async renderReferralList() {
                    const userId = App.state.userProfile?.id;
                    if (!userId) return;

                    const listEl = App.elements.referralList;
                    const countEl = App.elements.referralCount;
                    listEl.innerHTML = '<div class="h-12 w-full skeleton"></div><div class="h-12 w-full skeleton"></div>'; // Skeleton loader

                    const { data: referrals, error } = await App.supabase.from('referrals').select('referred_id, profiles(id, full_name, username, photo_url)').eq('referrer_id', userId);

                    if (error) {
                        console.error("Failed to load referrals:", error);
                        listEl.innerHTML = `<p class="text-sm text-[var(--tg-hint)]">Ошибка загрузки рефералов.</p>`;
                        return;
                    }
                    
                    listEl.innerHTML = '';
                    countEl.textContent = referrals.length;

                    if (referrals.length === 0) {
                        listEl.innerHTML = `<p class="text-sm text-[var(--tg-hint)]">У вас пока нет рефералов.</p>`;
                        return;
                    }

                    referrals.forEach(ref => {
                        const profile = ref.profiles;
                        const name = profile?.username ? `@${profile.username}` : (profile?.full_name || `Пользователь #${profile.id}`);
                        const avatar = profile?.photo_url || `https://placehold.co/40x40/EFEFEF/333333?text=${(name || 'ID').charAt(0).toUpperCase()}`;
                        
                        const item = document.createElement('div');
                        item.className = 'flex items-center space-x-3 p-2 rounded-lg';
                        item.innerHTML = `
                            <img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-300" onerror="this.src='https://placehold.co/40x40/EFEFEF/333333?text=U'">
                            <div class="flex-grow">
                                <p class="font-semibold">${name}</p>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });
                },
                renderReferralSection() {
                    const link = App.referralManager.generateReferralLink();
                    App.elements.referralLinkInput.value = link;
                },
                renderChatList() {
                    const { chats } = App.state;
                    const activeChatId = App.state.activeChat?.id;
                    const el = App.elements.chatList;
                    el.innerHTML = '';
                    
                    if (chats.length === 0) {
                        el.innerHTML = '<p class="text-sm text-center text-[var(--tg-hint)] p-4">История чатов пуста.</p>';
                        return;
                    }

                    chats.forEach(chat => {
                        const isActive = chat.id === activeChatId;
                        const item = document.createElement('div');
                        item.className = `flex items-center justify-between p-3 rounded-lg cursor-pointer ${isActive ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)]' : 'bg-[var(--tg-secondary-bg)] hover:bg-opacity-75'}`;
                        item.innerHTML = `
                            <div class="flex-grow min-w-0">
                                <h4 class="font-semibold truncate">${chat.title}</h4>
                                <p class="text-xs opacity-70">${new Date(chat.created_at).toLocaleString()}</p>
                            </div>
                            <button data-chat-id="${chat.id}" class="delete-chat-btn flex-shrink-0 p-2 rounded-full hover:bg-red-500/50 text-red-500 hover:text-white">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        `;
                        
                        item.addEventListener('click', async (e) => {
                            if (e.target.closest('.delete-chat-btn')) return; // Не переключать чат при нажатии на удаление
                            if (chat.id === App.state.activeChat?.id) {
                                this.closeHistoryModal();
                                return;
                            }
                            await App.dataManager.loadActiveChat(chat.id);
                            this.renderAll();
                            this.closeHistoryModal();
                        });
                        
                        el.appendChild(item);
                    });
                     // Добавляем обработчики событий для кнопок удаления после рендеринга
                    App.eventManager.addDeleteChatButtonListeners();
                },
                addMessageToChat(text, sender, isTyping = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-bubble ${sender}-bubble flex items-center`;
                    
                    if (isTyping) {
                        messageDiv.innerHTML = `<span class="loader"></span><span class="ml-2">${text}</span>`;
                        messageDiv.id = 'typing-indicator';
                    } else {
                        // Простая защита от вставки HTML
                        messageDiv.textContent = text;
                    }
                    
                    App.elements.chatHistory.appendChild(messageDiv);
                    App.elements.chatHistory.scrollTop = App.elements.chatHistory.scrollHeight;
                    return messageDiv;
                },
                navigateToPage(pageId) {
                    App.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                    App.elements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
                    if (pageId === 'profile-page') {
                        this.renderProfilePage();
                    }
                },
                toggleCodePreview(view) {
                    App.elements.subNavButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
                    App.elements.codeView.classList.toggle('hidden', view !== 'code');
                    App.elements.previewView.classList.toggle('hidden', view !== 'preview');
                },
                toggleButtonLoading(button, isLoading, originalContent) {
                    if (isLoading) {
                        button.dataset.original = button.innerHTML;
                        button.innerHTML = `<span class="loader"></span>`;
                        button.disabled = true;
                    } else {
                        button.innerHTML = originalContent || button.dataset.original;
                        button.disabled = false;
                    }
                },
                showPopup(options, callback) {
                    App.tg.showPopup(options, callback);
                },
                async showWelcomePopupIfNeeded() {
                    if (App.state.userProfile && !App.state.userProfile.has_seen_welcome_popup) {
                        return new Promise(resolve => {
                            App.ui.showPopup({
                                title: 'Добро пожаловать!',
                                message: 'Привет я fullstack разработчик YR, а это мой ИИ для создания HTML приложений, блоков, компонетов и тд. Кстати ты можешь его купить за 150 т.р',
                                buttons: [
                                    { id: 'buy', type: 'default', text: 'Купить' },
                                    { id: 'chat', type: 'default', text: 'Чат' },
                                    { type: 'close' }
                                ]
                            }, async (buttonId) => {
                                if (buttonId === 'buy') App.tg.openTelegramLink('https://t.me/yung_rezac');
                                else if (buttonId === 'chat') App.tg.openTelegramLink('https://t.me/+2_hEfzuqRIpjYTEy');
                                await App.dataManager.updateUserProfile({ has_seen_welcome_popup: true });
                                resolve(); 
                            });
                        });
                    }
                    return Promise.resolve();
                },
                typeCode(code, element) {
                    return new Promise(resolve => {
                        element.textContent = '';
                        let i = 0;
                        const codeContainer = element.parentElement;

                        function type() {
                            if (i < code.length) {
                                const chunk = code.substring(i, i + 10); // Увеличим чанк для скорости
                                element.textContent += chunk;
                                i += 10;
                                if (i > code.length) i = code.length;
                                
                                Prism.highlightElement(element);
                                codeContainer.scrollTop = codeContainer.scrollHeight;
                                
                                requestAnimationFrame(type);
                            } else {
                                Prism.highlightElement(element);
                                resolve();
                            }
                        }
                        type();
                    });
                },
                openHistoryModal() {
                    this.renderChatList();
                    App.elements.historyModalOverlay.classList.add('active');
                    App.elements.historyModalPanel.classList.add('active');
                },
                closeHistoryModal() {
                    App.elements.historyModalOverlay.classList.remove('active');
                    App.elements.historyModalPanel.classList.remove('active');
                },
                showGlobalLoader(message, isError = false) {
                    App.elements.loaderMessage.textContent = message;
                    App.elements.globalLoader.style.display = 'flex';
                    if (isError) {
                       App.elements.globalLoader.querySelector('.loader').style.display = 'none';
                    } else {
                       App.elements.globalLoader.querySelector('.loader').style.display = 'inline-block';
                    }
                },
                hideGlobalLoader() {
                    App.elements.globalLoader.style.display = 'none';
                }
            },

            // --- МОДУЛЬ ОБРАБОТКИ СОБЫТИЙ ---
            eventManager: {
                addEventListeners() {
                    App.elements.navButtons.forEach(button => button.addEventListener('click', () => App.ui.navigateToPage(button.dataset.page)));
                    App.elements.subNavButtons.forEach(button => button.addEventListener('click', () => App.ui.toggleCodePreview(button.dataset.view)));
                    App.elements.generateButton.addEventListener('click', () => App.generationManager.handleGeneration());
                    App.elements.promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') App.generationManager.handleGeneration(); });
                    App.elements.copyButton.addEventListener('click', () => App.chatManager.copyCode());
                    
                    App.elements.historyButton.addEventListener('click', () => App.ui.openHistoryModal());
                    App.elements.historyModalOverlay.addEventListener('click', () => App.ui.closeHistoryModal());
                    App.elements.closeHistoryModalButton.addEventListener('click', () => App.ui.closeHistoryModal());
                    App.elements.pageNewChatButton.addEventListener('click', () => App.chatManager.createNewChat(true));
                    
                    App.elements.copyReferralLinkButton.addEventListener('click', () => App.referralManager.copyReferralLink());
                    App.elements.inviteFriendButton.addEventListener('click', () => App.referralManager.shareReferralLink());
                },
                addDeleteChatButtonListeners() {
                    document.querySelectorAll('.delete-chat-btn').forEach(button => {
                        // Удаляем старый обработчик, чтобы избежать дублирования
                        button.replaceWith(button.cloneNode(true));
                    });
                    document.querySelectorAll('.delete-chat-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const chatId = e.currentTarget.dataset.chatId;
                            App.chatManager.deleteChat(chatId);
                        });
                    });
                }
            },

            // --- МОДУЛЬ УПРАВЛЕНИЯ ЧАТОМ ---
            chatManager: {
                async createNewChat(checkLimits = true) {
                    const profile = App.state.userProfile;
                    if (checkLimits && !profile.subscription_is_active && profile.daily_chats_count >= App.config.maxDailyChats) {
                        App.generationManager.showLimitPopup('Вы достигли дневного лимита на создание новых чатов.');
                        return;
                    }

                    const { data: newChat, error } = await App.supabase.from('chats').insert({
                        user_id: profile.id,
                        title: 'Новый чат',
                        messages: [{ sender: 'ai', text: 'Привет! 👋 Опиши, какое веб-приложение ты хочешь создать.' }],
                        generated_code: '',
                    }).select().single();
                    
                    if (error) {
                        console.error('Failed to create new chat:', error);
                        App.ui.showPopup({title: 'Ошибка', message: 'Не удалось создать новый чат.'});
                        return;
                    }
                    
                    if (checkLimits && !profile.subscription_is_active) {
                        await App.dataManager.updateUserProfile({ daily_chats_count: profile.daily_chats_count + 1 });
                    }

                    App.state.chats.unshift(newChat);
                    App.state.activeChat = newChat;
                    App.ui.renderAll();
                    App.ui.closeHistoryModal();
                },
                
                deleteChat(chatId) {
                    const chatToDelete = App.state.chats.find(c => c.id === chatId);
                    if (!chatToDelete) return;
                    
                    App.ui.showPopup({
                        title: 'Удалить чат?',
                        message: `Вы уверены, что хотите удалить чат "${chatToDelete.title}"? Это действие необратимо.`,
                        buttons: [
                            { id: 'delete', type: 'destructive', text: 'Удалить' },
                            { type: 'cancel' }
                        ]
                    }, async (buttonId) => {
                        if (buttonId === 'delete') {
                            const success = await App.dataManager.deleteChat(chatId);
                            if (success) {
                                App.state.chats = App.state.chats.filter(c => c.id !== chatId);
                                // Если удалили активный чат, переключаемся на другой или создаем новый
                                if (App.state.activeChat?.id === chatId) {
                                    if (App.state.chats.length > 0) {
                                        await App.dataManager.loadActiveChat(App.state.chats[0].id);
                                    } else {
                                        await this.createNewChat(false);
                                    }
                                }
                                App.ui.renderAll();
                                App.tg.HapticFeedback.notificationOccurred('success');
                            }
                        }
                    });
                },

                copyCode(textToCopy) {
                    const text = textToCopy || App.state.activeChat?.generated_code;
                    if (!text) return;
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(text).then(() => {
                            App.tg.HapticFeedback.notificationOccurred('success');
                        }).catch(err => {
                             this._fallbackCopy(text);
                        });
                    } else {
                        this._fallbackCopy(text);
                    }
                },
                _fallbackCopy(text) {
                     const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        App.tg.HapticFeedback.notificationOccurred('success');
                    } catch (err) {
                        App.tg.HapticFeedback.notificationOccurred('error');
                        App.ui.showPopup({ title: 'Ошибка', message: 'Не удалось скопировать.' });
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            },
            
            // --- МОДУЛЬ УПРАВЛЕНИЯ РЕФЕРАЛАМИ ---
            referralManager: {
                async processNewReferral() {
                    const referrerId = App.tg.initDataUnsafe.start_param;
                    const currentUser = App.state.userProfile;
                    if (referrerId && !currentUser.referrer_id && currentUser.id.toString() !== referrerId) {
                        console.log(`New user ${currentUser.id} referred by ${referrerId}`);
                        try {
                             // Используем RPC для безопасной обработки реферала
                            const { error } = await App.supabase.rpc('handle_referral', {
                                p_referrer_id: referrerId,
                                p_referred_id: currentUser.id
                            });
                            if (error) throw error;
                            
                            App.state.userProfile.referrer_id = referrerId;
                            App.state.userProfile.bonus_generations += 1;
                            App.ui.showPopup({ title: 'Бонус!', message: 'Вы перешли по приглашению и получили 1 бонусную генерацию! Ваш друг также получил бонус.' });
                            App.ui.renderSubscriptionStatus();

                        } catch (error) {
                            console.error("Failed to process referral:", error);
                        }
                    }
                },
                generateReferralLink() {
                    const userId = App.state.userProfile?.id;
                    if (!userId) return 'Не удалось сгенерировать ссылку.';
                    return `https://t.me/${App.config.botUsername}/${App.config.appName}?startapp=${userId}`;
                },
                copyReferralLink() {
                    const link = App.elements.referralLinkInput.value;
                    App.chatManager.copyCode(link);
                    App.ui.showPopup({ title: 'Успешно', message: 'Реферальная ссылка скопирована!' });
                },
                shareReferralLink() {
                    const link = App.elements.referralLinkInput.value;
                    const text = `Привет! Попробуй этого ИИ-бота для создания веб-приложений и получи бонусную генерацию по моей ссылке!`;
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
                    App.tg.openTelegramLink(shareUrl);
                }
            },
            
            // --- МОДУЛЬ УПРАВЛЕНИЯ TON ---
            tonManager: {
                init() {
                    App.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                        manifestUrl: new URL('tonconnect-manifest.json', window.location.href).toString(),
                        buttonRootId: 'ton-connect-container'
                    });
                },
                async sendTransaction() {
                    try {
                        const transaction = {
                            validUntil: Math.floor(Date.now() / 1000) + 600,
                            messages: [{
                                address: App.config.tonRecipientAddress,
                                amount: App.config.tonSubscriptionPrice,
                            }]
                        };
                        const result = await App.tonConnectUI.sendTransaction(transaction);
                        console.log("Transaction sent. BOC:", result.boc);
                        return true;
                    } catch (error) {
                        console.error('TON Transaction Error:', error);
                        App.ui.showPopup({ title: 'Ошибка транзакции', message: error.message || 'Не удалось отправить перевод.' });
                        return false;
                    }
                }
            },

            // --- МОДУЛЬ УПРАВЛЕНИЯ ПЛАТЕЖАМИ ---
            paymentManager: {
                async initiateSubscription() {
                    if (!App.tonConnectUI.connected) {
                        await App.tonConnectUI.openModal();
                        // После подключения/отклонения модального окна, пользователь должен будет нажать кнопку снова.
                        return;
                    }
                    const success = await App.tonManager.sendTransaction();
                    if (success) {
                        // ВАЖНО: В реальном приложении здесь должна быть проверка транзакции на бэкенде.
                        // Для демонстрации, мы симулируем проверку и активируем подписку.
                        App.ui.showGlobalLoader('Проверяем платеж...');
                        await new Promise(res => setTimeout(res, 3000)); // Симуляция задержки проверки
                        await this.activateSubscription();
                        App.ui.hideGlobalLoader();
                    }
                },
                async activateSubscription() {
                    const subscriptionEndDate = new Date();
                    subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + 1);

                    const updatedProfile = await App.dataManager.updateUserProfile({
                        subscription_is_active: true,
                        subscription_end_date: subscriptionEndDate.toISOString(),
                    });

                    if (updatedProfile) {
                        App.ui.showPopup({ title: 'Успешно!', message: 'Подписка PRO активирована на 1 месяц.'});
                        App.tg.HapticFeedback.notificationOccurred('success');
                        
                        // Если у пользователя есть referrer, начисляем ему бонус
                        if (updatedProfile.referrer_id) {
                            const { error } = await App.supabase.rpc('add_subscription_bonus', { p_referrer_id: updatedProfile.referrer_id });
                            if (error) console.error("Failed to add subscription bonus to referrer:", error);
                        }
                        
                    } else {
                         App.ui.showPopup({ title: 'Ошибка', message: 'Платеж прошел, но не удалось обновить профиль. Свяжитесь с поддержкой.'});
                         App.tg.HapticFeedback.notificationOccurred('error');
                    }
                    App.ui.renderSubscriptionStatus();
                }
            },

            // --- МОДУЛЬ ГЕНЕРАЦИИ ---
            generationManager: {
                async handleGeneration() {
                    if (App.state.isGenerating) return;
                    const prompt = App.elements.promptInput.value.trim();
                    if (!prompt) {
                        App.tg.HapticFeedback.notificationOccurred('error');
                        App.elements.promptInput.classList.add('shake-it');
                        setTimeout(() => App.elements.promptInput.classList.remove('shake-it'), 300);
                        return;
                    }
                    
                    const profile = App.state.userProfile;
                    const hasBonus = profile.bonus_generations > 0;

                    if (!profile.subscription_is_active && !hasBonus) {
                        if (profile.daily_generations_count >= App.config.maxDailyGenerations) {
                            this.showLimitPopup('Вы достигли дневного лимита на генерации.'); return;
                        }
                        if (profile.monthly_generations_count >= App.config.maxMonthlyGenerations) {
                            this.showLimitPopup('Вы достигли месячного лимита на генерации.'); return;
                        }
                    }

                    App.ui.toggleButtonLoading(App.elements.generateButton, true);
                    App.state.isGenerating = true;

                    // Списываем генерацию
                    if (!profile.subscription_is_active) {
                        const updates = hasBonus 
                            ? { bonus_generations: profile.bonus_generations - 1 }
                            : { daily_generations_count: profile.daily_generations_count + 1, monthly_generations_count: profile.monthly_generations_count + 1 };
                        await App.dataManager.updateUserProfile(updates);
                    }

                    const chat = App.state.activeChat;
                    chat.messages.push({ sender: 'user', text: prompt });
                    if (chat.title === 'Новый чат') {
                        chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                    }
                    
                    App.ui.addMessageToChat(prompt, 'user');
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.promptInput.value = '';
                    
                    const indicator = App.ui.addMessageToChat('Пишу код...', 'ai', true);

                    try {
                        const systemPrompt = App.api.createCodeGenerationPrompt(prompt, chat.generated_code);
                        const newCode = await App.api.callGemini(systemPrompt);
                        const codeMatch = newCode.match(/```(?:html|css|javascript|)\n([\s\S]*?)\n```/s);
                        const finalCode = codeMatch ? codeMatch[1] : newCode;

                        indicator.remove();
                        App.ui.navigateToPage('creation-page');
                        
                        await App.ui.typeCode(finalCode, App.elements.codeOutput);

                        App.elements.previewIframe.srcdoc = finalCode;
                        App.ui.toggleCodePreview('preview');

                        const aiResponseText = 'Готово! Код обновлен, вот превью.';
                        App.ui.addMessageToChat(aiResponseText, 'ai');
                        chat.messages.push({ sender: 'ai', text: aiResponseText });
                        
                        chat.generated_code = finalCode;
                        
                        await App.dataManager.saveActiveChat();
                        App.tg.HapticFeedback.notificationOccurred('success');

                    } catch (error) {
                        console.error('Generation Error:', error);
                        indicator.remove();
                        const errorMessage = error.message.includes('User location is not supported')
                            ? "Похоже YR://DEV не доступен в вашем регионе, попробуйте включить VPN и перезагрузить приложение"
                            : `Произошла ошибка: ${error.message}.`;
                        App.ui.addMessageToChat(errorMessage, 'ai');
                        chat.messages.push({ sender: 'ai', text: errorMessage });
                        await App.dataManager.saveActiveChat();
                        App.tg.HapticFeedback.notificationOccurred('error');
                    } finally {
                        App.ui.toggleButtonLoading(App.elements.generateButton, false, '<svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>');
                        App.state.isGenerating = false;
                    }
                },
                showLimitPopup(message) {
                    App.ui.showPopup({
                        title: 'Лимит исчерпан',
                        message: `${message} Оформите PRO-подписку для неограниченного доступа!`,
                        buttons: [{ id: 'subscribe', type: 'default', text: 'Подписаться' }, { type: 'cancel' }]
                    }, (buttonId) => {
                        if (buttonId === 'subscribe') {
                            App.ui.navigateToPage('profile-page');
                            App.paymentManager.initiateSubscription();
                        }
                    });
                }
            },

            // --- МОДУЛЬ ИНСТРУМЕНТОВ ---
            toolsManager: {
                init() {
                    App.elements.toolNavButtons.forEach(button => button.addEventListener('click', () => this.switchTool(button.dataset.tool)));
                    // JSON
                    App.elements.jsonFormatBtn.addEventListener('click', () => this.formatJSON());
                    App.elements.jsonClearBtn.addEventListener('click', () => this.clearJSON());
                    // Base64
                    App.elements.base64EncodeBtn.addEventListener('click', () => this.encodeBase64());
                    App.elements.base64DecodeBtn.addEventListener('click', () => this.decodeBase64());
                    // URL
                    App.elements.urlEncodeBtn.addEventListener('click', () => this.encodeURL());
                    App.elements.urlDecodeBtn.addEventListener('click', () => this.decodeURL());
                    // JWT
                    App.elements.jwtDecodeBtn.addEventListener('click', () => this.decodeJWT());
                    // Regex
                    App.elements.regexGenerateBtn.addEventListener('click', () => this.generateRegex());
                    App.elements.regexTestBtn.addEventListener('click', () => this.testRegex());
                    // Git
                    App.elements.gitGenerateBtn.addEventListener('click', () => this.generateGitCommand());
                    App.elements.gitCopyBtn.addEventListener('click', () => this.copyGitCommand());
                    // Hash
                    App.elements.hashInput.addEventListener('input', () => this.debounce(() => this.calculateHashes(), 300));
                    // Color
                    ['color-picker', 'color-hex', 'color-rgb', 'color-hsl'].forEach(id => {
                        const el = document.getElementById(id);
                        el.addEventListener('input', (e) => this.debounce(() => this.updateColors(e.target.id), 200));
                    });
                    this.updateColors('color-picker'); // Initial setup
                },
                debounce(func, delay) {
                    clearTimeout(App.state.debounceTimer);
                    App.state.debounceTimer = setTimeout(func, delay);
                },
                switchTool(toolName) {
                    App.elements.toolContents.forEach(content => content.classList.toggle('active', content.id === `tool-${toolName}`));
                    App.elements.toolNavButtons.forEach(button => button.classList.toggle('active', button.dataset.tool === toolName));
                },
                formatJSON() { /* ... */ },
                clearJSON() { /* ... */ },
                encodeBase64() { /* ... */ },
                decodeBase64() { /* ... */ },
                encodeURL() { /* ... */ },
                decodeURL() { /* ... */ },
                decodeJWT() { /* ... */ },
                async generateRegex() { /* ... */ },
                testRegex() { /* ... */ },
                async generateGitCommand() { /* ... */ },
                copyGitCommand() { /* ... */ },
                async calculateHashes() { /* ... */ },
                updateColors(source) { /* ... */ },
            },

            // --- МОДУЛЬ API ---
            api: {
                createCodeGenerationPrompt(userPrompt, existingCode) {
                    const baseInstruction = `Твоя задача - быть экспертом по созданию html блоков, компонентов, приложений. Ты должен вернуть ТОЛЬКО HTML-код в одном блоке \`\`\`html ... \`\`\`. Без лишних слов, объяснений или комментариев вне кода. Код должен быть полным и самодостаточным (включая HTML, CSS в <style> и JS в <script>). Используй Tailwind CSS для стилизации.`;
                    return existingCode
                        ? `${baseInstruction}\nВот существующий код:\n\n${existingCode}\n\nЗапрос пользователя: "${userPrompt}".\nИзмени код и верни новую полную версию.`
                        : `${baseInstruction}\nЗапрос пользователя: "${userPrompt}".\nСоздай код с нуля.`;
                },
                createRegexGenerationPrompt(userPrompt) {
                    return `Ты - эксперт по регулярным выражениям. По запросу пользователя создай регулярное выражение. Верни ТОЛЬКО само выражение в формате /pattern/flags, без объяснений, примеров или блоков кода. Например, если пользователь просит найти email, верни просто /\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\b/i. Запрос пользователя: "${userPrompt}"`;
                },
                createGitCommandPrompt(userPrompt) {
                    return `Ты - эксперт по Git. По запросу пользователя создай ОДНУ наиболее подходящую команду Git. Верни ТОЛЬКО саму команду, без объяснений, примеров или блоков кода. Например, если пользователь просит 'откатить последний коммит, но оставить изменения', верни просто 'git reset --soft HEAD~1'. Запрос пользователя: "${userPrompt}"`;
                },
                async callGemini(prompt, retries = 3, delay = 1000) {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${App.config.geminiModel}:generateContent?key=`; // API ключ не нужен, он будет предоставлен средой выполнения
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    for (let i = 0; i < retries; i++) {
                        try {
                            const response = await fetch(API_URL, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(payload)
                            });
                            if (!response.ok) {
                                if (response.status >= 500 || response.status === 429) {
                                    throw new Error(`Server error: ${response.status}`); // Будет повторная попытка
                                }
                                const errorData = await response.json();
                                throw new Error(errorData.error?.message || `HTTP ошибка: ${response.status}`); // Не будет повторной попытки
                            }
                            const data = await response.json();
                            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                            if (!text) throw new Error('Получен неверный или пустой ответ от API.');
                            return text;
                        } catch (error) {
                            console.warn(`Attempt ${i+1} failed. Retrying... Error: ${error.message}`);
                            if (i === retries - 1) throw error; // Пробрасываем ошибку после последней попытки
                            await new Promise(res => setTimeout(res, delay * (i + 1)));
                        }
                    }
                }
            }
        };

        // --- Заполнение методов toolsManager, которые остались без изменений для краткости ---
        Object.assign(App.toolsManager, {
            formatJSON() {
                const input = App.elements.jsonInput.value.trim();
                const outputEl = App.elements.jsonOutput;
                if (!input) { outputEl.textContent = ''; return; }
                try {
                    const parsed = JSON.parse(input);
                    outputEl.textContent = JSON.stringify(parsed, null, 4);
                    outputEl.style.color = 'var(--tg-text)';
                } catch (e) {
                    outputEl.textContent = `Невалидный JSON: ${e.message}`;
                    outputEl.style.color = 'red';
                }
            },
            clearJSON() {
                App.elements.jsonInput.value = '';
                App.elements.jsonOutput.textContent = '';
                App.elements.jsonOutput.style.color = 'inherit';
            },
            encodeBase64() {
                const input = App.elements.base64Input.value;
                try {
                    App.elements.base64Output.value = btoa(unescape(encodeURIComponent(input)));
                } catch (e) { App.elements.base64Output.value = `Ошибка: ${e.message}`; }
            },
            decodeBase64() {
                const input = App.elements.base64Input.value;
                try {
                    App.elements.base64Output.value = decodeURIComponent(escape(atob(input)));
                } catch (e) { App.elements.base64Output.value = `Ошибка: ${e.message}`; }
            },
            encodeURL() { App.elements.urlOutput.value = encodeURIComponent(App.elements.urlInput.value); },
            decodeURL() {
                try { App.elements.urlOutput.value = decodeURIComponent(App.elements.urlInput.value); } 
                catch (e) { App.elements.urlOutput.value = `Ошибка: ${e.message}`; }
            },
            decodeJWT() {
                const token = App.elements.jwtInput.value.trim();
                const outputEl = App.elements.jwtOutput;
                outputEl.innerHTML = '';
                if (!token) return;
                try {
                    const [headerB64, payloadB64, signature] = token.split('.');
                    if (!headerB64 || !payloadB64 || !signature) throw new Error('Неверная структура JWT.');
                    const header = JSON.parse(atob(headerB64.replace(/-/g, '+').replace(/_/g, '/')));
                    const payload = JSON.parse(atob(payloadB64.replace(/-/g, '+').replace(/_/g, '/')));
                    outputEl.innerHTML = `
                        <div><h3 class="font-semibold text-pink-400">Header:</h3><pre class="p-2 mt-1 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono">${JSON.stringify(header, null, 2)}</pre></div>
                        <div><h3 class="font-semibold text-purple-400 mt-2">Payload:</h3><pre class="p-2 mt-1 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono">${JSON.stringify(payload, null, 2)}</pre></div>
                    `;
                } catch (e) { outputEl.innerHTML = `<p class="text-red-500">Ошибка декодирования: ${e.message}</p>`; }
            },
            async generateRegex() {
                const prompt = App.elements.regexPrompt.value.trim();
                if (!prompt) return;
                const btn = App.elements.regexGenerateBtn;
                App.ui.toggleButtonLoading(btn, true);
                try {
                    const systemPrompt = App.api.createRegexGenerationPrompt(prompt);
                    const response = await App.api.callGemini(systemPrompt);
                    const regexMatch = response.match(/\/(.*?)\/([gimyus]*)/);
                    if (!regexMatch || !regexMatch[1]) throw new Error("Не удалось извлечь Regex из ответа ИИ.");
                    App.elements.regexOutput.textContent = regexMatch[0];
                    App.elements.regexOutputContainer.classList.remove('hidden');
                } catch (error) { App.ui.showPopup({title: 'Ошибка генерации', message: error.message}); } 
                finally { App.ui.toggleButtonLoading(btn, false, 'Сгенерировать'); }
            },
            testRegex() {
                const regexString = App.elements.regexOutput.textContent.trim();
                const testString = App.elements.regexTestString.value;
                const resultEl = App.elements.regexTestResult;
                if (!regexString) return;
                try {
                    const match = regexString.match(/\/(.*?)\/([gimyus]*)/);
                    const regex = new RegExp(match[1], match[2]);
                    const matches = testString.match(regex);
                    if (matches) {
                        let highlightedString = testString.replace(regex, (m) => `<span class="bg-yellow-300 text-black px-1 rounded">${m}</span>`);
                        resultEl.innerHTML = `<p class="text-green-500 font-bold">Найдено совпадений: ${matches.length}</p><div class="mt-2 p-2 bg-[var(--tg-secondary-bg)] rounded">${highlightedString}</div>`;
                    } else { resultEl.innerHTML = `<p class="text-red-500">Совпадений не найдено.</p>`; }
                } catch (e) { resultEl.innerHTML = `<p class="text-red-500">Ошибка Regex: ${e.message}</p>`; }
            },
            async generateGitCommand() {
                const prompt = App.elements.gitPrompt.value.trim();
                if (!prompt) return;
                const btn = App.elements.gitGenerateBtn;
                App.ui.toggleButtonLoading(btn, true);
                try {
                    const systemPrompt = App.api.createGitCommandPrompt(prompt);
                    const response = await App.api.callGemini(systemPrompt);
                    const commandMatch = response.match(/```(?:bash|sh|git)?\n([\s\S]*?)\n```/s) || response.match(/`([^`]+)`/);
                    const command = commandMatch ? commandMatch[1].trim() : response.trim();
                    App.elements.gitOutput.querySelector('code').textContent = command;
                    App.elements.gitOutputContainer.classList.remove('hidden');
                } catch (error) { App.ui.showPopup({title: 'Ошибка генерации', message: error.message}); } 
                finally { App.ui.toggleButtonLoading(btn, false, 'Сгенерировать'); }
            },
            copyGitCommand() {
                const code = App.elements.gitOutput.querySelector('code').textContent;
                App.chatManager.copyCode(code);
                App.elements.gitCopyBtn.textContent = 'OK!';
                setTimeout(() => { App.elements.gitCopyBtn.textContent = 'Копировать'; }, 1500);
            },
            async calculateHashes() {
                const input = App.elements.hashInput.value;
                App.elements.hashMd5.textContent = md5(input);
                try {
                    const encoder = new TextEncoder();
                    const data = encoder.encode(input);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    App.elements.hashSha256.textContent = hashHex;
                } catch (e) { App.elements.hashSha256.textContent = 'Ошибка'; }
            },
            updateColors(source) {
                if (App.state.isColorUpdating) return;
                App.state.isColorUpdating = true;
                const picker = App.elements.colorPicker, hexInput = App.elements.colorHex, rgbInput = App.elements.colorRgb, hslInput = App.elements.colorHsl;
                let hex, rgb, hsl;
                try {
                    if (source === 'color-picker') { hex = picker.value; rgb = this.hexToRgb(hex); hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b); }
                    else if (source === 'color-hex') { hex = hexInput.value; if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(hex)) throw new Error(); rgb = this.hexToRgb(hex); hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b); }
                    else if (source === 'color-rgb') { const m = rgbInput.value.match(/(\d+),\s*(\d+),\s*(\d+)/); if (!m) throw new Error(); rgb = { r: +m[1], g: +m[2], b: +m[3] }; if (rgb.r > 255 || rgb.g > 255 || rgb.b > 255) throw new Error(); hex = this.rgbToHex(rgb.r, rgb.g, rgb.b); hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b); }
                    else if (source === 'color-hsl') { const m = hslInput.value.match(/(\d+),\s*(\d+)%?,\s*(\d+)%?/); if (!m) throw new Error(); hsl = { h: +m[1], s: +m[2], l: +m[3] }; if (hsl.h > 360 || hsl.s > 100 || hsl.l > 100) throw new Error(); rgb = this.hslToRgb(hsl.h, hsl.s, hsl.l); hex = this.rgbToHex(rgb.r, rgb.g, rgb.b); }
                    if (source !== 'color-picker') picker.value = hex;
                    if (source !== 'color-hex') hexInput.value = hex;
                    if (source !== 'color-rgb') rgbInput.value = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
                    if (source !== 'color-hsl') hslInput.value = `${hsl.h}, ${hsl.s}%, ${hsl.l}%`;
                    [hexInput, rgbInput, hslInput].forEach(el => el.style.borderColor = 'transparent');
                } catch (e) { document.getElementById(source).style.borderColor = 'red'; } 
                finally { App.state.isColorUpdating = false; }
            },
            hexToRgb(h) { let r = 0, g = 0, b = 0; if (h.length == 4) { r = "0x" + h[1] + h[1]; g = "0x" + h[2] + h[2]; b = "0x" + h[3] + h[3]; } else if (h.length == 7) { r = "0x" + h[1] + h[2]; g = "0x" + h[3] + h[4]; b = "0x" + h[5] + h[6]; } return { r: +r, g: +g, b: +b }; },
            rgbToHex(r, g, b) { return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toLowerCase(); },
            rgbToHsl(r, g, b) { r /= 255; g /= 255; b /= 255; let max = Math.max(r, g, b), min = Math.min(r, g, b); let h, s, l = (max + min) / 2; if (max == min) { h = s = 0; } else { let d = max - min; s = l > 0.5 ? d / (2 - max - min) : d / (max + min); switch(max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; } h /= 6; } return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) }; },
            hslToRgb(h, s, l) { h /= 360; s /= 100; l /= 100; let r, g, b; if (s == 0) { r = g = b = l; } else { const hue2rgb = (p, q, t) => { if (t < 0) t += 1; if (t > 1) t -= 1; if (t < 1/6) return p + (q - p) * 6 * t; if (t < 1/2) return q; if (t < 2/3) return p + (q - p) * (2/3 - t) * 6; return p; }; let q = l < 0.5 ? l * (1 + s) : l + s - l * s; let p = 2 * l - q; r = hue2rgb(p, q, h + 1/3); g = hue2rgb(p, q, h); b = hue2rgb(p, q, h - 1/3); } return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) }; }
        });

        // --- ЗАПУСК ПРИЛОЖЕНИЯ ---
        App.init();
    });
    </script>
</body>
</html>
