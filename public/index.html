<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI Web App Builder</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Prism.js –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Ton Connect UI SDK -->
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    
    <!-- –°—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --tg-header-bg: var(--tg-theme-header-bg-color, #ffffff);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .chat-bubble { max-width: 85%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; line-height: 1.4; }
        .user-bubble { background-color: var(--tg-button); color: var(--tg-button-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: var(--tg-secondary-bg); color: var(--tg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .nav-button.active { color: var(--tg-button); }
        .sub-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }
        .tool-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }
        .btn-transition { transition: background-color 0.2s, opacity 0.2s, transform 0.1s; }
        .btn-transition:active { transform: scale(0.95); }
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid currentColor;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
        .shake-it { animation: shake 0.3s ease-in-out; }
        pre[class*="language-"] { background: #2d2d2d; margin: 0; border-radius: 0; }
        code[class*="language-"] { font-size: 14px; line-height: 1.5; }
        #history-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 40; }
        #history-modal-overlay.active { opacity: 1; visibility: visible; }
        #history-modal-panel { position: fixed; left: 0; right: 0; bottom: 0; height: 75vh; background-color: var(--tg-bg); border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 50; display: flex; flex-direction: column; padding: 1rem; box-shadow: 0 -10px 25px -5px rgba(0,0,0,0.1), 0 -8px 10px -6px rgba(0,0,0,0.1); }
        #history-modal-panel.active { transform: translateY(0); }
        .tool-content { display: none; }
        .tool-content.active { display: block; animation: fadeIn 0.3s; }
        /* –°—Ç–∏–ª–∏ –¥–ª—è color picker */
        #color-picker {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 100%;
            height: 40px;
            border: none;
            cursor: pointer;
            background-color: transparent;
        }
        #color-picker::-webkit-color-swatch-wrapper { padding: 0; }
        #color-picker::-webkit-color-swatch { border: 1px solid var(--tg-hint); border-radius: 0.5rem; }
        .pro-badge {
            background-color: #ffd700;
            color: #333;
            font-size: 0.6rem;
            font-weight: bold;
            padding: 1px 4px;
            border-radius: 4px;
            margin-left: 6px;
            vertical-align: middle;
        }
        .lock-icon {
            width: 1em;
            height: 1em;
            margin-right: 4px;
            vertical-align: text-bottom;
            opacity: 0.6;
        }
        .tool-nav-button.locked {
            opacity: 0.6;
            cursor: not-allowed;
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —è–∑—ã–∫–æ–≤ */
        .language-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }
        .language-button {
            padding: 6px 12px;
            border-radius: 16px;
            background-color: var(--tg-secondary-bg);
            color: var(--tg-text);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .language-button.active {
            background-color: var(--tg-button);
            color: var(--tg-button-text);
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ */
        .directory-item {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 4px;
            background-color: var(--tg-secondary-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .directory-item-name {
            font-weight: 500;
        }
        .directory-item-actions {
            display: flex;
            gap: 8px;
        }
        .directory-item-action {
            padding: 2px 6px;
            border-radius: 4px;
            background-color: var(--tg-bg);
            font-size: 12px;
            cursor: pointer;
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∑–∞–≥—Ä—É–∑—á–∏–∫ -->
    <div id="global-loader" class="absolute inset-0 bg-[var(--tg-bg)] bg-opacity-80 flex flex-col items-center justify-center z-[100]">
        <div class="loader" style="width: 48px; height: 48px;"></div>
        <p id="loader-message" class="mt-4 text-lg font-semibold text-[var(--tg-text)]">–ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...</p>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <main class="flex-grow overflow-hidden flex flex-col min-h-0">
        <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ß–ê–¢ –° –ò–ò -->
        <div id="chat-page" class="page active flex-col h-full">
            <div class="flex-shrink-0 flex justify-between items-center p-2 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button id="history-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></button>
                <h1 id="chat-title" class="font-bold text-lg truncate px-2">–ß–∞—Ç</h1>
                <button id="page-new-chat-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="–ù–æ–≤—ã–π —á–∞—Ç"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
            </div>
            <div id="chat-history" class="flex-grow p-4 flex flex-col space-y-2 overflow-y-auto"></div>
            <div class="flex-shrink-0 flex flex-col p-2 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)]">
                <div id="language-buttons" class="language-buttons">
                    <button class="language-button active" data-lang="html">HTML</button>
                    <button class="language-button" data-lang="javascript">JavaScript</button>
                    <button class="language-button" data-lang="python">Python</button>
                    <button class="language-button" data-lang="java">Java</button>
                    <button class="language-button" data-lang="php">PHP</button>
                    <button class="language-button" data-lang="ruby">Ruby</button>
                    <button class="language-button" data-lang="csharp">C#</button>
                    <button class="language-button" data-lang="cpp">C++</button>
                    <button class="language-button" data-lang="go">Go</button>
                    <button class="language-button" data-lang="rust">Rust</button>
                    <button class="language-button" data-lang="swift">Swift</button>
                    <button class="language-button" data-lang="kotlin">Kotlin</button>
                </div>
                <div class="flex items-center space-x-2">
                    <input id="prompt-input" type="text" placeholder="–í–∞—à –∑–∞–ø—Ä–æ—Å..." class="w-full p-3 rounded-full focus:outline-none bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] placeholder-[var(--tg-hint)] transition-transform">
                    <button id="generate-button" class="p-3 rounded-full transition-opacity btn-transition flex-shrink-0 bg-[var(--tg-button)] text-[var(--tg-button-text)]" aria-label="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                </div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶A 2: –°–û–ó–î–ê–ù–ò–ï (–ö–û–î + –ü–†–ï–í–¨–Æ + –î–ò–†–ï–ö–¢–û–†–ò–Ø) -->
        <div id="creation-page" class="page flex-col h-full">
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button data-view="code" class="sub-nav-button active w-1/3 p-4 text-center text-[var(--tg-hint)]">–ö–æ–¥</button>
                <button data-view="preview" class="sub-nav-button w-1/3 p-4 text-center text-[var(--tg-hint)]">–ü—Ä–µ–≤—å—é</button>
                <button data-view="directory" class="sub-nav-button w-1/3 p-4 text-center text-[var(--tg-hint)]">–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è</button>
            </div>
            <div id="code-view" class="flex-grow flex flex-col overflow-hidden">
                <div class="p-2 flex-shrink-0 flex justify-end items-center space-x-2 bg-[var(--tg-bg)] border-b border-[var(--tg-secondary-bg)]">
                    <button id="copy-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button id="download-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">–°–∫–∞—á–∞—Ç—å</button>
                </div>
                <div class="flex-grow overflow-auto bg-[#2d2d2d]"><pre><code id="code-output" class="language-html text-sm p-4 block whitespace-pre-wrap font-mono"></code></pre></div>
            </div>
            <div id="preview-view" class="flex-grow hidden bg-white relative">
                <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
            </div>
            <div id="directory-view" class="flex-grow hidden p-4 overflow-y-auto">
                <div class="mb-4">
                    <h3 class="text-lg font-bold mb-2">–°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h3>
                    <div id="directory-list" class="space-y-2">
                        <!-- –§–∞–π–ª—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-2">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ñ–∞–π–ª</h3>
                    <div class="flex space-x-2 mb-2">
                        <input id="new-filename-input" type="text" placeholder="–ò–º—è —Ñ–∞–π–ª–∞" class="flex-grow p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none">
                        <select id="new-filetype-select" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none">
                            <option value="html">HTML</option>
                            <option value="js">JavaScript</option>
                            <option value="css">CSS</option>
                            <option value="py">Python</option>
                            <option value="java">Java</option>
                            <option value="php">PHP</option>
                            <option value="rb">Ruby</option>
                            <option value="cs">C#</option>
                            <option value="cpp">C++</option>
                            <option value="go">Go</option>
                            <option value="rs">Rust</option>
                            <option value="swift">Swift</option>
                            <option value="kt">Kotlin</option>
                        </select>
                    </div>
                    <button id="add-file-button" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 px-4 rounded-lg btn-transition">–î–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª</button>
                </div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ò–ù–°–¢–†–£–ú–ï–ù–¢–´ -->
        <div id="tools-page" class="page flex-col h-full">
            <div class="flex-shrink-0 p-3 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <h1 class="font-bold text-lg text-center">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</h1>
            </div>
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)] overflow-x-auto">
                <!-- FREE TOOLS -->
                <button data-tool="json" class="tool-nav-button active flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">JSON</button>
                <button data-tool="base64" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">Base64</button>
                <button data-tool="url" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm">URL</button>
                <!-- PRO TOOLS -->
                <button data-tool="jwt" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">JWT</button>
                <button data-tool="regex" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">AI Regex</button>
                <button data-tool="git" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">AI Git</button>
                <button data-tool="hash" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">Hash</button>
                <button data-tool="color" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">Color</button>
                <button data-tool="image-generator" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">AI –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</button>
                <button data-tool="code-doctor" data-pro="true" class="tool-nav-button flex-shrink-0 p-3 text-center text-[var(--tg-hint)] text-sm items-center">AI Code Doctor</button>
            </div>
            <div class="flex-grow p-4 overflow-y-auto space-y-4">
                <!-- JSON Formatter Tool -->
                <div id="tool-json" class="tool-content active">
                    <h2 class="text-xl font-semibold mb-2">JSON –§–æ—Ä–º–∞—Ç—Ç–µ—Ä</h2>
                    <textarea id="json-input" class="w-full h-48 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à JSON —Å—é–¥–∞..."></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="json-format-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button id="json-clear-btn" class="w-1/3 bg-gray-500 text-white py-2 rounded-lg btn-transition">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    <pre id="json-output" class="mt-4 p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono min-h-[5rem]"></pre>
                </div>
                <!-- Base64 Tool -->
                <div id="tool-base64" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2">Base64 –ö–æ–¥–µ—Ä/–î–µ–∫–æ–¥–µ—Ä</h2>
                    <textarea id="base64-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–¢–µ–∫—Å—Ç –∏–ª–∏ Base64..."></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="base64-encode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">–ö–æ–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button id="base64-decode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <textarea id="base64-output" readonly class="w-full h-32 p-2 mt-4 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç..."></textarea>
                </div>
                <!-- URL Tool -->
                <div id="tool-url" class="tool-content">
                     <h2 class="text-xl font-semibold mb-2">URL –ö–æ–¥–µ—Ä/–î–µ–∫–æ–¥–µ—Ä</h2>
                    <textarea id="url-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="URL –∏–ª–∏ —Å—Ç—Ä–æ–∫–∞..."></textarea>
                    <div class="flex space-x-2 mt-2">
                        <button id="url-encode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">–ö–æ–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button id="url-decode-btn" class="w-full bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                    <textarea id="url-output" readonly class="w-full h-32 p-2 mt-4 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç..."></textarea>
                </div>
                <!-- JWT Decoder Tool -->
                <div id="tool-jwt" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">JWT –î–µ–∫–æ–¥–µ—Ä<span class="pro-badge">PRO</span></h2>
                    <textarea id="jwt-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à JWT —Å—é–¥–∞..."></textarea>
                    <button id="jwt-decode-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition">–î–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                    <div id="jwt-output" class="mt-4 space-y-4"></div>
                </div>
                <!-- AI Regex Generator Tool -->
                <div id="tool-regex" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Regex<span class="pro-badge">PRO</span></h2>
                    <textarea id="regex-prompt" class="w-full h-24 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: '–ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Å—Ç—Ä–æ–∫–∞ —è–≤–ª—è–µ—Ç—Å—è email –∞–¥—Ä–µ—Å–æ–º'"></textarea>
                    <button id="regex-generate-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition flex items-center justify-center">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    <div id="regex-output-container" class="mt-4 hidden">
                        <h3 class="font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
                        <pre id="regex-output" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono"></pre>
                        <h3 class="font-semibold mt-4">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:</h3>
                        <textarea id="regex-test-string" class="w-full p-2 mt-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="–°—Ç—Ä–æ–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞..."></textarea>
                        <button id="regex-test-btn" class="w-full mt-2 bg-green-500 text-white py-2 rounded-lg btn-transition">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <div id="regex-test-result" class="mt-2 text-sm"></div>
                    </div>
                </div>
                <!-- AI Git Command Generator Tool -->
                <div id="tool-git" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Git –ö–æ–º–∞–Ω–¥<span class="pro-badge">PRO</span></h2>
                    <textarea id="git-prompt" class="w-full h-24 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å —Å Git. –ù–∞–ø—Ä–∏–º–µ—Ä: '–æ—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö'"></textarea>
                    <button id="git-generate-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition flex items-center justify-center">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    <div id="git-output-container" class="mt-4 hidden">
                        <h3 class="font-semibold">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–º–∞–Ω–¥–∞:</h3>
                        <pre id="git-output" class="p-3 rounded-lg bg-gray-800 text-white text-sm whitespace-pre-wrap font-mono relative"><button id="git-copy-btn" class="absolute top-2 right-2 bg-gray-600 hover:bg-gray-500 p-1 rounded-md text-xs">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button><code></code></pre>
                    </div>
                </div>
                <!-- Hash Generator Tool -->
                <div id="tool-hash" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –•–µ—à–µ–π<span class="pro-badge">PRO</span></h2>
                    <textarea id="hash-input" class="w-full h-32 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç—Ä–æ–∫—É –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è..."></textarea>
                    <div id="hash-output" class="mt-4 space-y-2">
                        <div>
                            <label class="font-semibold text-sm">MD5:</label>
                            <pre id="hash-md5" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono break-all"></pre>
                        </div>
                        <div>
                            <label class="font-semibold text-sm">SHA-256:</label>
                            <pre id="hash-sha256" class="p-2 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono break-all"></pre>
                        </div>
                    </div>
                </div>
                <!-- Color Converter Tool -->
                <div id="tool-color" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">–ö–æ–Ω–≤–µ—Ä—Ç–µ—Ä –¶–≤–µ—Ç–æ–≤<span class="pro-badge">PRO</span></h2>
                    <div class="p-4 rounded-lg bg-[var(--tg-secondary-bg)] space-y-4">
                        <input type="color" id="color-picker" value="#007aff">
                        <div class="space-y-2">
                            <div>
                                <label for="color-hex" class="font-semibold text-sm">HEX:</label>
                                <input type="text" id="color-hex" class="w-full p-2 mt-1 rounded-lg bg-[var(--tg-bg)] focus:outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label for="color-rgb" class="font-semibold text-sm">RGB:</label>
                                <input type="text" id="color-rgb" class="w-full p-2 mt-1 rounded-lg bg-[var(--tg-bg)] focus:outline-none font-mono text-sm">
                            </div>
                            <div>
                                <label for="color-hsl" class="font-semibold text-sm">HSL:</label>
                                <input type="text" id="color-hsl" class="w-full p-2 mt-1 rounded-lg bg-[var(--tg-bg)] focus:outline-none font-mono text-sm">
                            </div>
                        </div>
                    </div>
                </div>
                 <!-- PRO: AI Image Generator Tool -->
                <div id="tool-image-generator" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π <span class="pro-badge">PRO</span></h2>
                    <textarea id="image-prompt" class="w-full h-24 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none text-sm" placeholder="–û–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–æ–∑–¥–∞—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä: 'a cute cat wearing a wizard hat'"></textarea>
                    <button id="image-generate-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition flex items-center justify-center">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
                    <div id="image-output-container" class="mt-4">
                        <div id="image-loader" class="hidden flex-col items-center justify-center p-4">
                            <div class="loader" style="width: 32px; height: 32px;"></div>
                            <p class="mt-2 text-sm text-[var(--tg-hint)]">–ú–∞–≥–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...</p>
                        </div>
                        <img id="image-output" src="" class="w-full rounded-lg hidden" alt="Generated Image"/>
                    </div>
                </div>
                <!-- PRO: AI Code Doctor Tool -->
                <div id="tool-code-doctor" class="tool-content">
                    <h2 class="text-xl font-semibold mb-2 flex items-center">–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ö–æ–¥–∞ <span class="pro-badge">PRO</span></h2>
                    <textarea id="code-doctor-input" class="w-full h-48 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none font-mono text-sm" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–¥ —Å—é–¥–∞..."></textarea>
                    <select id="code-doctor-action" class="w-full mt-2 p-2 rounded-lg bg-[var(--tg-secondary-bg)] focus:outline-none">
                        <option value="explain">–û–±—ä—è—Å–Ω–∏—Ç—å –∫–æ–¥</option>
                        <option value="refactor">–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥</option>
                        <option value="debug">–ù–∞–π—Ç–∏ –±–∞–≥–∏</option>
                    </select>
                    <button id="code-doctor-run-btn" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] py-2 rounded-lg btn-transition flex items-center justify-center">–í—ã–ø–æ–ª–Ω–∏—Ç—å</button>
                    <div id="code-doctor-output-container" class="mt-4 hidden">
                        <h3 class="font-semibold">–†–µ–∑—É–ª—å—Ç–∞—Ç:</h3>
                        <pre class="p-3 rounded-lg bg-[#2d2d2d] text-white text-sm whitespace-pre-wrap font-mono relative"><code id="code-doctor-output" class="language-markdown"></code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 4: –ü–†–û–§–ò–õ–¨ -->
        <div id="profile-page" class="page p-4 overflow-y-auto flex-col h-full space-y-4">
            <div id="user-profile-card" class="flex items-center justify-between space-x-4 p-4 bg-[var(--tg-secondary-bg)] rounded-xl">
                <div class="flex items-center space-x-4 min-w-0">
                    <img id="user-avatar" src="https://placehold.co/64x64/EFEFEF/333333?text=User" class="w-16 h-16 rounded-full object-cover bg-gray-300 flex-shrink-0">
                    <div class="flex-grow min-w-0">
                        <h2 id="user-fullname" class="text-xl font-bold truncate">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
                        <p id="user-username" class="text-sm text-[var(--tg-hint)] truncate">@username</p>
                    </div>
                </div>
                <div id="ton-connect-container" class="flex-shrink-0"></div>
            </div>

            <div id="subscription-status" class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl"></div>
            
            <div class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl space-y-3">
                <h3 class="text-lg font-bold">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–∑–µ–π</h3>
                <p class="text-sm text-[var(--tg-hint)]">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ –¥—Ä—É–≥–∞ –∏ –ø–æ–ª—É—á–∏—Ç–µ –±–æ–Ω—É—Å! –í—ã –ø–æ–ª—É—á–∏—Ç–µ 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –∑–∞ –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ 10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π, –µ—Å–ª–∏ –æ–Ω –æ—Ñ–æ—Ä–º–∏—Ç –ø–æ–¥–ø–∏—Å–∫—É. –í–∞—à –¥—Ä—É–≥ –ø–æ–ª—É—á–∏—Ç 1 –±–æ–Ω—É—Å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ.</p>
                <div class="flex items-center space-x-2">
                    <input id="referral-link-input" type="text" readonly class="w-full p-2 rounded-lg focus:outline-none bg-[var(--tg-bg)] text-sm">
                    <button id="copy-referral-link-button" class="p-2 rounded-lg bg-[var(--tg-button)] text-[var(--tg-button-text)] btn-transition flex-shrink-0"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                </div>
                <button id="invite-friend-button" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] font-bold py-2 px-4 rounded-lg btn-transition">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å</button>
            </div>
            <div id="referral-list-section" class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl space-y-3">
                <div class="flex items-center justify-between">
                     <h3 class="text-lg font-bold">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ –≤–∞–º–∏</h3>
                     <span id="referral-count" class="text-sm font-bold bg-[var(--tg-button)] text-[var(--tg-button-text)] px-2 py-1 rounded-full">0</span>
                </div>
                <div id="referral-list" class="space-y-2 max-h-150 overflow-y-auto">
                    <p class="text-sm text-[var(--tg-hint)]">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <footer class="flex-shrink-0 h-20 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)] flex justify-around items-center">
        <button data-page="chat-page" class="nav-button active flex flex-col items-center justify-center p-2 h-full" aria-label="–ß–∞—Ç"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="text-xs">–ß–∞—Ç</span></button>
        <button data-page="creation-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="–°–æ–∑–¥–∞–Ω–∏–µ"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg><span class="text-xs">–°–æ–∑–¥–∞–Ω–∏–µ</span></button>
        <button data-page="tools-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span class="text-xs">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>
        </button>
        <button data-page="profile-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="–ü—Ä–æ—Ñ–∏–ª—å"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </footer>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–æ–≤ -->
    <div id="history-modal-overlay"></div>
    <div id="history-modal-panel">
        <h3 class="text-xl font-bold mb-4 flex-shrink-0">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h3>
        <div id="chat-list" class="space-y-2 overflow-y-auto flex-grow"></div>
    </div>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Prism.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ MD5 (–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, —Ç.–∫. SubtleCrypto –µ–≥–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            config: {
                apiKey: 'AIzaSyAg2oUJsSrbo2N9d4S5A0PVUuY9NEcXXRo', // –í–ê–ñ–ù–û: –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à API –∫–ª—é—á Gemini
                botUsername: 'yr_dev_bot',
                appName: 'aiyrf',
                supabaseUrl: 'https://mhwzgpexajfqqtlgivfc.supabase.co',
                supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1od3pncGV4YWpmcXF0bGdpdmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMzU1ODAsImV4cCI6MjA2OTYxMTU4MH0.jmmkJ2gsfRMVOo3KVTHYS2u8IIoBUH7D5ZemZowwpzE',
                maxDailyGenerations: 3,
                maxMonthlyGenerations: 30,
                maxDailyChats: 5,
                tonRecipientAddress: 'UQA-NjtXmWz0-GFB59p2jSjdBXtq4H9qDo6-N2xvDCsC9NTL',
                tonSubscriptionPrice: '5000000000', // 5 TON in nanoTONs
                proModelName: 'gemini-2.5-pro',
                freeModelName: 'gemini-2.5-flash',
                imageModelName: 'imagen-3.0'
            },
            state: {
                userProfile: null,
                chats: [],
                activeChat: null,
                myReferrals: [],
                isGenerating: false,
                isColorUpdating: false, // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Ü–≤–µ—Ç–∞
                selectedLanguage: 'html',
                projectFiles: [
                    { name: 'index.html', type: 'html', content: '<!DOCTYPE html>\n<html>\n<head>\n  <title>My App</title>\n</head>\n<body>\n  <h1>Hello World!</h1>\n</body>\n</html>' },
                    { name: 'style.css', type: 'css', content: 'body {\n  font-family: Arial, sans-serif;\n  margin: 0;\n  padding: 20px;\n}' },
                    { name: 'app.js', type: 'js', content: 'console.log("App loaded");' }
                ],
                activeFileIndex: 0
            },
            elements: {},
            tg: window.Telegram.WebApp,
            supabase: null,
            tonConnectUI: null,

            async init() {
                try {
                    this.tg.ready();
                    this.tg.expand();
                    this.cacheDOMElements();
                    this.eventManager.addEventListeners();

                    this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseAnonKey);
                    
                    if (!this.tg.initDataUnsafe.user?.id) {
                        throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.");
                    }

                    this.tonManager.init();
                    this.toolsManager.init();

                    this.elements.loaderMessage.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...';
                    await this.dataManager.loadInitialDataAndChats();
                    
                    await this.ui.showWelcomePopupIfNeeded();
                    await this.referralManager.processNewReferral();

                    this.ui.renderAll();
                    this.elements.globalLoader.style.display = 'none';
                    console.log("App Initialized. User:", this.tg.initDataUnsafe.user);

                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.elements.loaderMessage.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                    this.tg.HapticFeedback.notificationOccurred('error');
                    this.ui.showPopup({ title: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞', message: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. ' + error.message });
                }
            },

            cacheDOMElements() {
                const ids = [
                    'chat-page', 'creation-page', 'profile-page', 'tools-page',
                    'chat-history', 'prompt-input', 'language-buttons',
                    'generate-button', 'code-view', 'preview-view', 'directory-view', 
                    'code-output', 'preview-iframe', 'directory-list',
                    'copy-button', 'download-button', 'subscription-status', 'chat-list', 'chat-title',
                    'history-button', 'page-new-chat-button',
                    'history-modal-overlay', 'history-modal-panel',
                    'user-profile-card', 'user-avatar', 'user-fullname', 'user-username',
                    'copy-referral-link-button', 'referral-link-input', 'invite-friend-button',
                    'referral-list-section', 'referral-list', 'referral-count',
                    'global-loader', 'loader-message',
                    'ton-connect-container',
                    'tool-json', 'json-input', 'json-format-btn', 'json-clear-btn', 'json-output',
                    'tool-base64', 'base64-input', 'base64-encode-btn', 'base64-decode-btn', 'base64-output',
                    'tool-url', 'url-input', 'url-encode-btn', 'url-decode-btn', 'url-output',
                    'tool-jwt', 'jwt-input', 'jwt-decode-btn', 'jwt-output',
                    'tool-regex', 'regex-prompt', 'regex-generate-btn', 'regex-output-container', 'regex-output', 'regex-test-string', 'regex-test-btn', 'regex-test-result',
                    'tool-git', 'git-prompt', 'git-generate-btn', 'git-output-container', 'git-output', 'git-copy-btn',
                    'tool-hash', 'hash-input', 'hash-output', 'hash-md5', 'hash-sha256',
                    'tool-color', 'color-picker', 'color-hex', 'color-rgb', 'color-hsl',
                    // PRO Tools
                    'tool-image-generator', 'image-prompt', 'image-generate-btn', 'image-output-container', 'image-loader', 'image-output',
                    'tool-code-doctor', 'code-doctor-input', 'code-doctor-action', 'code-doctor-run-btn', 'code-doctor-output-container', 'code-doctor-output',
                    // Directory
                    'new-filename-input', 'new-filetype-select', 'add-file-button'
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.elements[camelCaseId] = document.getElementById(id);
                });
                this.elements.pages = document.querySelectorAll('.page');
                this.elements.navButtons = document.querySelectorAll('.nav-button');
                this.elements.subNavButtons = document.querySelectorAll('#creation-page .sub-nav-button');
                this.elements.toolNavButtons = document.querySelectorAll('.tool-nav-button');
                this.elements.toolContents = document.querySelectorAll('.tool-content');
                this.elements.languageButtons = document.querySelectorAll('.language-button');
            },
            
            dataManager: {
                async loadInitialDataAndChats() {
                    const user = App.tg.initDataUnsafe.user;
                    const userId = user.id;

                    let { data: profile, error: profileError } = await App.supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();

                    if (profileError && profileError.code !== 'PGRST116') {
                        throw new Error(`Failed to load profile: ${profileError.message}`);
                    }
                    
                    if (!profile) {
                        profile = await this.createNewUserProfile(user);
                    }

                    const now = new Date();
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
                    const currentMonth = now.getMonth();
                    
                    const updates = {};
                    let needsUpdate = false;

                    const lastGenReset = profile.daily_generations_last_reset ? new Date(profile.daily_generations_last_reset).getTime() : 0;
                    if (lastGenReset < todayStart) {
                        updates.daily_generations_count = 0;
                        updates.daily_generations_last_reset = now.toISOString();
                        needsUpdate = true;
                    }

                    const lastChatReset = profile.daily_chats_last_reset ? new Date(profile.daily_chats_last_reset).getTime() : 0;
                    if (lastChatReset < todayStart) {
                        updates.daily_chats_count = 0;
                        updates.daily_chats_last_reset = now.toISOString();
                        needsUpdate = true;
                    }

                    const lastMonthlyResetMonth = profile.monthly_generations_last_reset ? new Date(profile.monthly_generations_last_reset).getMonth() : -1;
                    if (lastMonthlyResetMonth !== currentMonth) {
                        updates.monthly_generations_count = 0;
                        updates.monthly_generations_last_reset = now.toISOString();
                        needsUpdate = true;
                    }
                    
                    if (needsUpdate) {
                        const { data: updatedProfile, error: updateError } = await App.supabase
                            .from('profiles')
                            .update(updates)
                            .eq('id', userId)
                            .select()
                            .single();
                        if (updateError) console.error("Failed to reset limits:", updateError);
                        else profile = updatedProfile;
                    }

                    App.state.userProfile = profile;

                    const { data: chats, error: chatsError } = await App.supabase
                        .from('chats')
                        .select('id, title, created_at')
                        .eq('user_id', userId)
                        .order('created_at', { ascending: false });

                    if (chatsError) throw new Error(`Failed to load chats: ${chatsError.message}`);
                    App.state.chats = chats || [];

                    if (App.state.chats.length === 0) {
                        const newChat = await this.createNewChatInDB(userId, false); 
                        App.state.chats.unshift(newChat);
                    }

                    const activeChatId = App.state.chats[0].id;
                    await this.loadActiveChat(activeChatId);
                },

                async createNewUserProfile(user) {
                    const { data, error } = await App.supabase
                        .from('profiles')
                        .insert({
                            id: user.id,
                            username: user.username,
                            full_name: `${user.first_name || ''} ${user.last_name || ''}`.trim(),
                            photo_url: user.photo_url,
                            updated_at: new Date().toISOString(),
                            bonus_generations: App.tg.initDataUnsafe.start_param ? 1 : 0,
                            has_seen_welcome_popup: false
                        })
                        .select()
                        .single();

                    if (error) throw new Error(`Failed to create profile: ${error.message}`);
                    return data;
                },

                async loadActiveChat(chatId) {
                    const { data, error } = await App.supabase
                        .from('chats')
                        .select('*')
                        .eq('id', chatId)
                        .single();

                    if (error) {
                        console.error(`Failed to load chat ${chatId}:`, error);
                        App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —á–∞—Ç.' });
                        return;
                    }
                    App.state.activeChat = data;
                },

                async createNewChatInDB(userId) {
                    const { data, error } = await App.supabase
                        .from('chats')
                        .insert({
                            user_id: userId,
                            title: '–ù–æ–≤—ã–π —á–∞—Ç',
                            messages: [{ sender: 'ai', text: '–ü—Ä–∏–≤–µ—Ç! üëã –û–ø–∏—à–∏, –∫–∞–∫–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç—ã —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å.' }],
                            generated_code: '',
                        })
                        .select('id, title, created_at')
                        .single();
                    
                    if (error) {
                         console.error('Failed to create new chat:', error);
                         throw error;
                    }
                    return data;
                },
                
                async saveActiveChat() {
                    if (!App.state.activeChat) return;
                    const { id, title, messages, generated_code } = App.state.activeChat;
                    const { error } = await App.supabase
                        .from('chats')
                        .update({ title, messages, generated_code })
                        .eq('id', id);
                    
                    if (error) console.error('Failed to save chat:', error);
                },

                async updateUserProfile(updates) {
                    const { data, error } = await App.supabase
                        .from('profiles')
                        .update(updates)
                        .eq('id', App.state.userProfile.id)
                        .select()
                        .single();

                    if (error) {
                        console.error('Failed to update profile:', error);
                        return null;
                    }
                    App.state.userProfile = data;
                    App.ui.renderProfilePage();
                    return data;
                }
            },
            
            ui: {
                renderAll() {
                    this.renderActiveChat();
                    this.renderProfilePage();
                    this.renderChatList();
                    this.updateToolButtonsLockState();
                    this.renderDirectory();
                },
                renderActiveChat() {
                    const chat = App.state.activeChat;
                    if (!chat) {
                        App.elements.chatTitle.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                        App.elements.chatHistory.innerHTML = '';
                        return;
                    };
                    
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.chatHistory.innerHTML = '';
                    chat.messages.forEach(msg => this.addMessageToChat(msg.text, msg.sender));
                    
                    App.elements.codeOutput.textContent = chat.generated_code || "// –ö–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
                    Prism.highlightElement(App.elements.codeOutput);

                    App.elements.previewIframe.srcdoc = chat.generated_code;
                },
                renderProfilePage() {
                    this.renderUserProfile();
                    this.renderSubscriptionStatus();
                    this.renderReferralSection();
                    this.renderReferralList();
                },
                renderUserProfile() {
                    const user = App.tg.initDataUnsafe.user;
                    if (!user) return;

                    App.elements.userAvatar.src = user.photo_url || `https://placehold.co/64x64/EFEFEF/333333?text=${user.first_name.charAt(0)}`;
                    App.elements.userFullname.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Anonymous';
                    App.elements.userUsername.textContent = user.username ? `@${user.username}` : 'No username';
                },
                renderSubscriptionStatus() {
                    const profile = App.state.userProfile;
                    if (!profile) return;

                    const { subscription_is_active, subscription_end_date } = profile;
                    const el = App.elements.subscriptionStatus;

                    if (subscription_is_active && new Date(subscription_end_date) > new Date()) {
                        el.innerHTML = `
                            <h3 class="text-lg font-bold text-green-500">PRO-–¥–æ—Å—Ç—É–ø –∞–∫—Ç–∏–≤–µ–Ω</h3>
                            <p class="text-sm text-[var(--tg-text)]">–í—Å–µ –ª–∏–º–∏—Ç—ã —Å–Ω—è—Ç—ã. –°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É!</p>
                            <p class="text-xs text-[var(--tg-hint)] mt-2">–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(subscription_end_date).toLocaleDateString()}</p>
                        `;
                    } else {
                        const { daily_generations_count, monthly_generations_count, daily_chats_count, bonus_generations } = profile;
                        const { maxDailyGenerations, maxMonthlyGenerations, maxDailyChats } = App.config;
                        
                        const priceInTon = parseInt(App.config.tonSubscriptionPrice) / 1_000_000_000;
                        const checkIcon = `<svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;
                        const proIcon = `<svg class="w-5 h-5 text-yellow-500 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;

                        el.innerHTML = `
                            <div class="grid grid-cols-2 gap-4 text-center mb-4">
                                <div>
                                    <p class="text-sm">–ì–µ–Ω–µ—Ä–∞—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è:</p>
                                    <p class="text-2xl font-bold">${maxDailyGenerations - daily_generations_count} / ${maxDailyGenerations}</p>
                                </div>
                                <div>
                                    <p class="text-sm">–ù–æ–≤—ã—Ö —á–∞—Ç–æ–≤ —Å–µ–≥–æ–¥–Ω—è:</p>
                                    <p class="text-2xl font-bold">${maxDailyChats - daily_chats_count} / ${maxDailyChats}</p>
                                </div>
                                <div class="col-span-2">
                                    <p class="text-sm">–ì–µ–Ω–µ—Ä–∞—Ü–∏–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ:</p>
                                    <p class="text-lg font-bold">${maxMonthlyGenerations - monthly_generations_count} / ${maxMonthlyGenerations}</p>
                                    ${bonus_generations > 0 ? `<p class="text-sm text-blue-500 mt-1">–ë–æ–Ω—É—Å–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π: ${bonus_generations}</p>` : ''}
                                </div>
                            </div>
                            
                            <div class="border-t border-[var(--tg-hint)] opacity-20 my-4"></div>

                            <div>
                                <h3 class="text-lg font-bold text-center mb-3">–ü–æ–ª—É—á–∏—Ç–µ PRO-–¥–æ—Å—Ç—É–ø</h3>
                                <ul class="space-y-2 text-sm">
                                    <li class="flex items-center space-x-3">${checkIcon}<span><strong>–ë–µ–∑–ª–∏–º–∏—Ç–Ω—ã–µ</strong> –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ —á–∞—Ç—ã</span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>–î–æ—Å—Ç—É–ø –∫ –º–æ–¥–µ–ª–∏ <strong>YR/AI Pro</strong></span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>–ù–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: <strong>AI –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</strong></span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>–ù–æ–≤—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç: <strong>AI –ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ö–æ–¥–∞</strong></span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</span></li>
                                    <li class="flex items-center space-x-3">${checkIcon}<span>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</span></li>
                                </ul>
                            </div>

                            <button id="subscribe-button" class="w-full mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg btn-transition flex items-center justify-center text-base">
                                <svg class="w-5 h-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.015 5.912a.647.647 0 01.916-.03L12.99 8.87a.645.645 0 010 1.02l-4.06 2.988a.647.647 0 01-.915-.99l3.14-2.306-3.14-2.305a.647.647 0 01.03-.96z" clip-rule="evenodd" /></svg>
                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å PRO –∑–∞ ${priceInTon} TON
                            </button>
                        `;
                        document.getElementById('subscribe-button')?.addEventListener('click', () => App.paymentManager.initiateSubscription());
                    }
                },
                async renderReferralList() {
                    const userId = App.state.userProfile?.id;
                    if (!userId) return;

                    const { data: referrals, error: referralsError } = await App.supabase
                        .from('referrals')
                        .select('referred_id')
                        .eq('referrer_id', userId);

                    if (referralsError) {
                        console.error("Failed to load referral IDs:", referralsError);
                        return;
                    }

                    const listEl = App.elements.referralList;
                    const countEl = App.elements.referralCount;
                    listEl.innerHTML = '';
                    countEl.textContent = referrals.length;

                    if (referrals.length === 0) {
                        listEl.innerHTML = `<p class="text-sm text-[var(--tg-hint)]">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤.</p>`;
                        return;
                    }

                    const referredIds = referrals.map(r => r.referred_id);

                    const { data: profiles, error: profilesError } = await App.supabase
                        .from('profiles')
                        .select('id, full_name, username, photo_url')
                        .in('id', referredIds);

                    if (profilesError) {
                        console.error("Failed to load referred profiles:", profilesError);
                    }

                    const profilesMap = new Map(profiles?.map(p => [p.id, p]));

                    referrals.forEach(ref => {
                        const profile = profilesMap.get(ref.referred_id);
                        const referredId = ref.referred_id;

                        const item = document.createElement('div');
                        item.className = 'flex items-center space-x-3 p-2 rounded-lg';
                        
                        const name = profile?.username ? `@${profile.username}` : (profile?.full_name || `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${referredId}`);
                        const subtext = profile?.username ? (profile.full_name || `ID: ${referredId}`) : `ID: ${referredId}`;
                        const avatar = profile?.photo_url || `https://placehold.co/40x40/EFEFEF/333333?text=${(name || 'ID').charAt(0).toUpperCase()}`;
                        
                        item.innerHTML = `
                            <img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-300">
                            <div class="flex-grow">
                                <p class="font-semibold">${name}</p>
                                <p class="text-xs text-[var(--tg-hint)]">${subtext}</p>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });
                },
                renderReferralSection() {
                    const link = App.referralManager.generateReferralLink();
                    App.elements.referralLinkInput.value = link;
                },
                renderChatList() {
                    const { chats } = App.state;
                    const activeChatId = App.state.activeChat?.id;
                    const el = App.elements.chatList;
                    el.innerHTML = '';
                    
                    chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        const isActive = chat.id === activeChatId;
                        chatItem.className = `p-3 rounded-lg cursor-pointer ${isActive ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)]' : 'bg-[var(--tg-secondary-bg)]'}`;
                        chatItem.innerHTML = `<h4 class="font-semibold truncate">${chat.title}</h4><p class="text-xs opacity-70">${new Date(chat.created_at).toLocaleString()}</p>`;
                        chatItem.addEventListener('click', async () => {
                            if (chat.id === App.state.activeChat?.id) {
                                this.closeHistoryModal();
                                return;
                            }
                            await App.dataManager.loadActiveChat(chat.id);
                            this.renderAll();
                            this.closeHistoryModal();
                        });
                        el.appendChild(chatItem);
                    });
                },
                renderDirectory() {
                    const listEl = App.elements.directoryList;
                    listEl.innerHTML = '';
                    
                    App.state.projectFiles.forEach((file, index) => {
                        const item = document.createElement('div');
                        item.className = 'directory-item';
                        item.innerHTML = `
                            <div class="directory-item-name">${file.name}</div>
                            <div class="directory-item-actions">
                                <button class="directory-item-action edit-file" data-index="${index}">Edit</button>
                                <button class="directory-item-action delete-file" data-index="${index}">Delete</button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });
                    
                    // Add event listeners for directory actions
                    document.querySelectorAll('.edit-file').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            App.state.activeFileIndex = index;
                            App.elements.codeOutput.textContent = App.state.projectFiles[index].content;
                            Prism.highlightElement(App.elements.codeOutput);
                            App.ui.toggleCodePreview('code');
                        });
                    });
                    
                    document.querySelectorAll('.delete-file').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            if (App.state.projectFiles.length > 1) {
                                App.state.projectFiles.splice(index, 1);
                                if (App.state.activeFileIndex >= index) {
                                    App.state.activeFileIndex = Math.max(0, App.state.activeFileIndex - 1);
                                }
                                this.renderDirectory();
                            } else {
                                App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ñ–∞–π–ª –≤ –ø—Ä–æ–µ–∫—Ç–µ.' });
                            }
                        });
                    });
                },
                addMessageToChat(text, sender, isTyping = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-bubble ${sender}-bubble flex items-center`;
                    
                    if (isTyping) {
                        messageDiv.innerHTML = `<span class="loader"></span><span class="ml-2">${text}</span>`;
                        messageDiv.id = 'typing-indicator';
                    } else {
                        const textNode = document.createTextNode(text);
                        messageDiv.appendChild(textNode);
                    }
                    
                    App.elements.chatHistory.appendChild(messageDiv);
                    App.elements.chatHistory.scrollTop = App.elements.chatHistory.scrollHeight;
                    return messageDiv;
                },
                navigateToPage(pageId) {
                    App.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                    App.elements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
                    if (pageId === 'profile-page') {
                        this.renderProfilePage();
                    }
                     if (pageId === 'tools-page') {
                        this.updateToolButtonsLockState();
                    }
                },
                updateToolButtonsLockState() {
                    const isPro = App.state.userProfile?.subscription_is_active;
                    const lockIconSvg = `<svg class="lock-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 8a6 6 0 01-7.743 5.743L10 14l-1 1-1 1H6v2H2v-4l4.257-4.257A6 6 0 1118 8zm-6-4a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd"></path></svg>`;

                    App.elements.toolNavButtons.forEach(button => {
                        if (button.dataset.pro === 'true') {
                            // Clear previous state
                            button.classList.remove('locked');
                            const existingBadge = button.querySelector('.pro-badge');
                            if (existingBadge) existingBadge.remove();
                            const existingIcon = button.querySelector('.lock-icon');
                            if (existingIcon) existingIcon.remove();

                            if (isPro) {
                                button.insertAdjacentHTML('beforeend', '<span class="pro-badge">PRO</span>');
                            } else {
                                button.classList.add('locked');
                                button.insertAdjacentHTML('afterbegin', lockIconSvg);
                            }
                        }
                    });
                },
                toggleCodePreview(view) {
                    App.elements.subNavButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
                    App.elements.codeView.classList.toggle('hidden', view !== 'code');
                    App.elements.previewView.classList.toggle('hidden', view !== 'preview');
                    App.elements.directoryView.classList.toggle('hidden', view !== 'directory');
                },
                toggleGenerationButton(disabled) {
                    App.state.isGenerating = disabled;
                    App.elements.generateButton.disabled = disabled;
                    App.elements.generateButton.style.opacity = disabled ? '0.7' : '1';
                    App.elements.generateButton.style.cursor = disabled ? 'not-allowed' : 'pointer';
                },
                showPopup(options, callback) {
                    App.tg.showPopup(options, callback);
                },
                async showWelcomePopupIfNeeded() {
                    if (App.state.userProfile && !App.state.userProfile.has_seen_welcome_popup) {
                        return new Promise(resolve => {
                            App.ui.showPopup({
                                title: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!',
                                message: '–ü—Ä–∏–≤–µ—Ç —è fullstack —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ YR, –∞ —ç—Ç–æ –º–æ–π –ò–ò –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, –±–ª–æ–∫–æ–≤, –∫–æ–º–ø–æ–Ω–µ—Ç–æ–≤ –∏ —Ç–¥. –ö—Å—Ç–∞—Ç–∏ —Ç—ã –º–æ–∂–µ—à—å –µ–≥–æ –∫—É–ø–∏—Ç—å –∑–∞ 150 —Ç.—Ä',
                                buttons: [
                                    { id: 'buy', type: 'default', text: '–ö—É–ø–∏—Ç—å' },
                                    { id: 'chat', type: 'default', text: '–ß–∞—Ç' },
                                    { type: 'close' }
                                ]
                            }, async (buttonId) => {
                                if (buttonId === 'buy') {
                                    App.tg.openTelegramLink('https://t.me/yung_rezac');
                                } else if (buttonId === 'chat') {
                                    App.tg.openTelegramLink('https://t.me/+2_hEfzuqRIpjYTEy');
                                }
                                await App.dataManager.updateUserProfile({ has_seen_welcome_popup: true });
                                App.state.userProfile.has_seen_welcome_popup = true;
                                resolve(); 
                            });
                        });
                    }
                    return Promise.resolve();
                },
                typeCode(code, element) {
                    return new Promise(resolve => {
                        element.textContent = '';
                        let i = 0;
                        const codeContainer = element.parentElement;

                        function type() {
                            if (i < code.length) {
                                const chunk = code.substring(i, i + 5);
                                element.textContent += chunk;
                                i += 5;
                                if (i > code.length) i = code.length;
                                
                                Prism.highlightElement(element);
                                codeContainer.scrollTop = codeContainer.scrollHeight;
                                
                                requestAnimationFrame(type);
                            } else {
                                resolve();
                            }
                        }
                        type();
                    });
                },
                openHistoryModal() {
                    this.renderChatList();
                    App.elements.historyModalOverlay.classList.add('active');
                    App.elements.historyModalPanel.classList.add('active');
                },
                closeHistoryModal() {
                    App.elements.historyModalOverlay.classList.remove('active');
                    App.elements.historyModalPanel.classList.remove('active');
                },
            },

            eventManager: {
                addEventListeners() {
                    App.elements.navButtons.forEach(button => button.addEventListener('click', () => App.ui.navigateToPage(button.dataset.page)));
                    App.elements.subNavButtons.forEach(button => button.addEventListener('click', () => App.ui.toggleCodePreview(button.dataset.view)));
                    App.elements.generateButton.addEventListener('click', () => App.generationManager.handleGeneration());
                    App.elements.promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') App.generationManager.handleGeneration(); });
                    App.elements.copyButton.addEventListener('click', () => App.chatManager.copyCode());
                    App.elements.downloadButton.addEventListener('click', () => App.chatManager.downloadCode());
                    
                    App.elements.historyButton.addEventListener('click', () => App.ui.openHistoryModal());
                    App.elements.historyModalOverlay.addEventListener('click', () => App.ui.closeHistoryModal());
                    App.elements.pageNewChatButton.addEventListener('click', () => App.chatManager.createNewChat());
                    
                    App.elements.copyReferralLinkButton.addEventListener('click', () => App.referralManager.copyReferralLink());
                    App.elements.inviteFriendButton.addEventListener('click', () => App.referralManager.shareReferralLink());

                    // Language buttons
                    App.elements.languageButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            App.elements.languageButtons.forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                            App.state.selectedLanguage = button.dataset.lang;
                        });
                    });

                    // Directory actions
                    App.elements.addFileButton.addEventListener('click', () => {
                        const filename = App.elements.newFilenameInput.value.trim();
                        const filetype = App.elements.newFiletypeSelect.value;
                        
                        if (!filename) {
                            App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞' });
                            return;
                        }
                        
                        const extension = filetype === 'html' ? '.html' : 
                                         filetype === 'js' ? '.js' : 
                                         filetype === 'css' ? '.css' : 
                                         filetype === 'py' ? '.py' : 
                                         filetype === 'java' ? '.java' : 
                                         filetype === 'php' ? '.php' : 
                                         filetype === 'rb' ? '.rb' : 
                                         filetype === 'cs' ? '.cs' : 
                                         filetype === 'cpp' ? '.cpp' : 
                                         filetype === 'go' ? '.go' : 
                                         filetype === 'rs' ? '.rs' : 
                                         filetype === 'swift' ? '.swift' : 
                                         filetype === 'kt' ? '.kt' : '';
                        
                        const newFile = {
                            name: filename.endsWith(extension) ? filename : `${filename}${extension}`,
                            type: filetype,
                            content: filetype === 'html' ? '<!DOCTYPE html>\n<html>\n<head>\n  <title>New Page</title>\n</head>\n<body>\n  \n</body>\n</html>' :
                                   filetype === 'js' ? '// JavaScript file\n\n' :
                                   filetype === 'css' ? '/* CSS file */\n\n' :
                                   filetype === 'py' ? '# Python file\n\n' :
                                   filetype === 'java' ? '// Java file\n\n' :
                                   filetype === 'php' ? '<?php\n// PHP file\n\n' :
                                   filetype === 'rb' ? '# Ruby file\n\n' :
                                   filetype === 'cs' ? '// C# file\n\n' :
                                   filetype === 'cpp' ? '// C++ file\n\n' :
                                   filetype === 'go' ? '// Go file\n\n' :
                                   filetype === 'rs' ? '// Rust file\n\n' :
                                   filetype === 'swift' ? '// Swift file\n\n' :
                                   filetype === 'kt' ? '// Kotlin file\n\n' : ''
                        };
                        
                        App.state.projectFiles.push(newFile);
                        App.ui.renderDirectory();
                        App.elements.newFilenameInput.value = '';
                    });

                    // PRO Tools Listeners
                    App.elements.imageGenerateBtn.addEventListener('click', () => App.toolsManager.generateImage());
                    App.elements.codeDoctorRunBtn.addEventListener('click', () => App.toolsManager.runCodeDoctor());
                }
            },

            chatManager: {
                async createNewChat() {
                    const profile = App.state.userProfile;
                    if (!profile.subscription_is_active && profile.daily_chats_count >= App.config.maxDailyChats) {
                        App.generationManager.showLimitPopup('–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —á–∞—Ç–æ–≤.');
                        return;
                    }

                    const newChatInfo = await App.dataManager.createNewChatInDB(profile.id);
                    App.state.chats.unshift(newChatInfo);
                    await App.dataManager.loadActiveChat(newChatInfo.id);

                    if (!profile.subscription_is_active) {
                        await App.dataManager.updateUserProfile({ daily_chats_count: profile.daily_chats_count + 1 });
                    }

                    App.ui.renderAll();
                    App.ui.closeHistoryModal();
                },
                copyCode(textToCopy) {
                    const text = textToCopy || App.state.activeChat?.generated_code;
                    if (!text) return;
                    const textarea = document.createElement('textarea');
                    textarea.value = text;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        App.tg.HapticFeedback.notificationOccurred('success');
                        return true;
                    } catch (err) {
                        App.tg.HapticFeedback.notificationOccurred('error');
                        App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å.' });
                        return false;
                    } finally {
                        document.body.removeChild(textarea);
                    }
                },
                downloadCode() {
                    const code = App.state.activeChat?.generated_code || '';
                    const blob = new Blob([code], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'index.html';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            },
            
            referralManager: {
                async processNewReferral() {
                    const referrerId = App.tg.initDataUnsafe.start_param;
                    const currentUser = App.state.userProfile;

                    if (referrerId && !currentUser.referrer_id && currentUser.id.toString() !== referrerId) {
                        console.log(`New user ${currentUser.id} referred by ${referrerId}`);
                        try {
                            const { data: referrerProfile, error: referrerError } = await App.supabase
                                .from('profiles')
                                .select('bonus_generations')
                                .eq('id', referrerId)
                                .single();

                            if (referrerError) throw new Error(`Could not find referrer: ${referrerError.message}`);

                            const { error: updateReferrerError } = await App.supabase
                                .from('profiles')
                                .update({ bonus_generations: (referrerProfile.bonus_generations || 0) + 1 })
                                .eq('id', referrerId);

                            if (updateReferrerError) throw new Error(`Could not update referrer bonus: ${updateReferrerError.message}`);

                            const { error: updateNewUserError } = await App.supabase
                                .from('profiles')
                                .update({ referrer_id: referrerId })
                                .eq('id', currentUser.id);

                            if (updateNewUserError) throw new Error(`Could not update new user's referrer: ${updateNewUserError.message}`);

                            const { error: insertReferralError } = await App.supabase
                                .from('referrals')
                                .insert({ referrer_id: referrerId, referred_id: currentUser.id });

                            if (insertReferralError) throw new Error(`Could not log referral connection: ${insertReferralError.message}`);
                            
                            App.state.userProfile.referrer_id = referrerId;
                            App.ui.showPopup({ title: '–ë–æ–Ω—É—Å!', message: '–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é –∏ –ø–æ–ª—É—á–∏–ª–∏ 1 –±–æ–Ω—É—Å–Ω—É—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é! –í–∞—à –¥—Ä—É–≥ —Ç–∞–∫–∂–µ –ø–æ–ª—É—á–∏–ª –±–æ–Ω—É—Å.' });

                        } catch (error) {
                            console.error("Failed to process referral on client-side:", error);
                            App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ.' });
                        }
                    }
                },
                generateReferralLink() {
                    const userId = App.state.userProfile?.id;
                    if (!userId) return '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É.';
                    return `https://t.me/${App.config.botUsername}/${App.config.appName}?startapp=${userId}`;
                },
                copyReferralLink() {
                    const link = App.elements.referralLinkInput.value;
                    if (App.chatManager.copyCode(link)) {
                        App.ui.showPopup({ title: '–£—Å–ø–µ—à–Ω–æ', message: '–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!' });
                    }
                },
                shareReferralLink() {
                    const link = App.elements.referralLinkInput.value;
                    if (!link) {
                        App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É.' });
                        return;
                    }
                    const text = `–ü—Ä–∏–≤–µ—Ç –ø–æ–ª—É—á–∏ 1 –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –≤–µ–± –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Ç –º–µ–Ω—è –≤ YR://DEV`;
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`;
                    App.tg.openTelegramLink(shareUrl);
                }
            },
            
            tonManager: {
                init() {
                    App.tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                        manifestUrl: new URL('tonconnect-manifest.json', window.location.href).toString(),
                        buttonRootId: 'ton-connect-container'
                    });
                },

                async sendTransaction() {
                    try {
                        const transaction = {
                            validUntil: Math.floor(Date.now() / 1000) + 600,
                            messages: [
                                {
                                    address: App.config.tonRecipientAddress,
                                    amount: App.config.tonSubscriptionPrice,
                                }
                            ]
                        };

                        const result = await App.tonConnectUI.sendTransaction(transaction);
                        console.log("Transaction sent:", result.boc);
                        return true;

                    } catch (error) {
                        console.error('TON Transaction Error:', error);
                        App.ui.showPopup({ title: '–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', message: error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥.' });
                        return false;
                    }
                }
            },

            paymentManager: {
                async initiateSubscription() {
                    if (!App.tonConnectUI.connected) {
                        await App.tonConnectUI.openModal();
                        return;
                    }
                    const success = await App.tonManager.sendTransaction();

                    if (success) {
                        await this.activateSubscription();
                    }
                },

                async activateSubscription() {
                    const subscriptionEndDate = new Date();
                    subscriptionEndDate.setMonth(subscriptionEndDate.getMonth() + 1);

                    const updatedProfile = await App.dataManager.updateUserProfile({
                        subscription_is_active: true,
                        subscription_end_date: subscriptionEndDate.toISOString(),
                    });

                    if (updatedProfile) {
                        App.ui.showPopup({ title: '–£—Å–ø–µ—à–Ω–æ!', message: '–ü–æ–¥–ø–∏—Å–∫–∞ PRO –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞ –Ω–∞ 1 –º–µ—Å—è—Ü.'});
                        App.tg.HapticFeedback.notificationOccurred('success');
                        App.ui.renderSubscriptionStatus();
                        App.ui.updateToolButtonsLockState(); // Update locks immediately
                    } else {
                         App.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.'});
                         App.tg.HapticFeedback.notificationOccurred('error');
                    }
                }
            },

            generationManager: {
                async handleGeneration() {
                    if (App.state.isGenerating) return;

                    const prompt = App.elements.promptInput.value.trim();
                    if (!prompt) {
                        App.tg.HapticFeedback.notificationOccurred('error');
                        App.elements.promptInput.classList.add('shake-it');
                        setTimeout(() => App.elements.promptInput.classList.remove('shake-it'), 300);
                        return;
                    }
                    
                    if (!this.checkLimits()) return;

                    App.ui.toggleGenerationButton(true);

                    await this.deductGeneration();

                    const chat = App.state.activeChat;
                    chat.messages.push({ sender: 'user', text: prompt });
                    if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç' || chat.title.trim() === '') {
                        chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                    }
                    
                    App.ui.addMessageToChat(prompt, 'user');
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.promptInput.value = '';
                    
                    const indicator = App.ui.addMessageToChat('–ü–∏—à—É –∫–æ–¥...', 'ai', true);

                    try {
                        // –î–æ–±–∞–≤–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫ –≤ –ø—Ä–æ–º–ø—Ç
                        const fullPrompt = `–Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è: ${App.state.selectedLanguage}\n\n${prompt}`;
                        const systemPrompt = App.api.createCodeGenerationPrompt(fullPrompt, chat.generated_code);
                        const newCode = await App.api.callGemini(systemPrompt);
                        const codeMatch = newCode.match(/```(?:html|javascript|python|java|php|ruby|csharp|cpp|go|rust|swift|kotlin|)\n([\s\S]*?)\n```/s);
                        const finalCode = codeMatch ? codeMatch[1] : newCode;

                        indicator.remove();
                        App.ui.navigateToPage('creation-page');
                        
                        await App.ui.typeCode(finalCode, App.elements.codeOutput);

                        App.elements.previewIframe.srcdoc = finalCode;
                        App.ui.toggleCodePreview('preview');

                        const aiResponseText = '–ì–æ—Ç–æ–≤–æ! –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω, –≤–æ—Ç –ø—Ä–µ–≤—å—é.';
                        App.ui.addMessageToChat(aiResponseText, 'ai');
                        chat.messages.push({ sender: 'ai', text: aiResponseText });
                        
                        chat.generated_code = finalCode;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
                        if (App.state.projectFiles.length > 0) {
                            App.state.projectFiles[App.state.activeFileIndex].content = finalCode;
                        }
                        
                        await App.dataManager.saveActiveChat();
                        App.tg.HapticFeedback.notificationOccurred('success');

                    } catch (error) {
                        console.error('Generation Error:', error);
                        indicator.remove();
                        let errorMessage;
                        if (error.message.includes('User location is not supported')) {
                            errorMessage = "–ü–æ—Ö–æ–∂–µ YR://DEV –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –≤–∞—à–µ–º —Ä–µ–≥–∏–æ–Ω–µ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–∫–ª—é—á–∏—Ç—å VPN –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ";
                        } else {
                            errorMessage = `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —É–∫–∞–∑–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API-–∫–ª—é—á.`;
                        }
                        App.ui.addMessageToChat(errorMessage, 'ai');
                        chat.messages.push({ sender: 'ai', text: errorMessage });
                        await App.dataManager.saveActiveChat();
                        App.tg.HapticFeedback.notificationOccurred('error');
                    } finally {
                        App.ui.toggleGenerationButton(false);
                    }
                },
                checkLimits() {
                    const profile = App.state.userProfile;
                    const hasBonusGenerations = profile.bonus_generations > 0;

                    if (!profile.subscription_is_active && !hasBonusGenerations) {
                        if (profile.daily_generations_count >= App.config.maxDailyGenerations) {
                            this.showLimitPopup('–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –¥–Ω–µ–≤–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.');
                            return false;
                        }
                        if (profile.monthly_generations_count >= App.config.maxMonthlyGenerations) {
                            this.showLimitPopup('–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –º–µ—Å—è—á–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞ –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.');
                            return false;
                        }
                    }
                    return true;
                },
                async deductGeneration() {
                    const profile = App.state.userProfile;
                    if (profile.subscription_is_active) return; // Pro users have no limits

                    if (profile.bonus_generations > 0) {
                        await App.dataManager.updateUserProfile({ bonus_generations: profile.bonus_generations - 1 });
                    } else {
                        await App.dataManager.updateUserProfile({ 
                            daily_generations_count: profile.daily_generations_count + 1,
                            monthly_generations_count: profile.monthly_generations_count + 1 
                        });
                    }
                },
                showLimitPopup(message) {
                    App.ui.showPopup({
                        title: '–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω',
                        message: `${message} –û—Ñ–æ—Ä–º–∏—Ç–µ PRO-–ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!`,
                        buttons: [{ id: 'subscribe', type: 'default', text: '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è' }, { type: 'cancel' }]
                    }, (buttonId) => {
                        if (buttonId === 'subscribe') {
                            App.ui.navigateToPage('profile-page');
                            App.paymentManager.initiateSubscription();
                        }
                    });
                }
            },

            toolsManager: {
                init() {
                    App.elements.toolNavButtons.forEach(button => {
                        button.addEventListener('click', () => this.switchTool(button.dataset.tool));
                    });

                    // JSON
                    App.elements.jsonFormatBtn.addEventListener('click', () => this.formatJSON());
                    App.elements.jsonClearBtn.addEventListener('click', () => this.clearJSON());

                    // Base64
                    App.elements.base64EncodeBtn.addEventListener('click', () => this.encodeBase64());
                    App.elements.base64DecodeBtn.addEventListener('click', () => this.decodeBase64());

                    // URL
                    App.elements.urlEncodeBtn.addEventListener('click', () => this.encodeURL());
                    App.elements.urlDecodeBtn.addEventListener('click', () => this.decodeURL());
                    
                    // JWT
                    App.elements.jwtDecodeBtn.addEventListener('click', () => this.decodeJWT());

                    // Regex
                    App.elements.regexGenerateBtn.addEventListener('click', () => this.generateRegex());
                    App.elements.regexTestBtn.addEventListener('click', () => this.testRegex());
                    
                    // Git
                    App.elements.gitGenerateBtn.addEventListener('click', () => this.generateGitCommand());
                    App.elements.gitCopyBtn.addEventListener('click', () => {
                        const code = App.elements.gitOutput.querySelector('code').textContent;
                        if(App.chatManager.copyCode(code)) {
                           App.elements.gitCopyBtn.textContent = 'OK!';
                           setTimeout(() => { App.elements.gitCopyBtn.textContent = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; }, 1500);
                        }
                    });

                    // Hash
                    App.elements.hashInput.addEventListener('input', () => this.calculateHashes());

                    // Color
                    ['color-picker', 'color-hex', 'color-rgb', 'color-hsl'].forEach(id => {
                        App.elements[id.replace(/-(\w)/g, (_, c) => c.toUpperCase())].addEventListener('input', (e) => this.updateColors(e.target.id));
                    });
                    this.updateColors('color-picker'); // Initial setup
                },

                switchTool(toolName) {
                    const button = document.querySelector(`.tool-nav-button[data-tool="${toolName}"]`);
                    if (button.dataset.pro === 'true' && !App.state.userProfile.subscription_is_active) {
                        App.generationManager.showLimitPopup(`–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç "${button.textContent.trim().replace('PRO','').trim()}" –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è PRO-–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.`);
                        return;
                    }

                    App.elements.toolContents.forEach(content => content.classList.toggle('active', content.id === `tool-${toolName}`));
                    App.elements.toolNavButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tool === toolName));
                },

                formatJSON() {
                    const input = App.elements.jsonInput.value.trim();
                    const outputEl = App.elements.jsonOutput;
                    if (!input) {
                        outputEl.textContent = '–û—à–∏–±–∫–∞: –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ.';
                        outputEl.style.color = 'red';
                        return;
                    }
                    try {
                        const parsed = JSON.parse(input);
                        outputEl.textContent = JSON.stringify(parsed, null, 4);
                        outputEl.style.color = 'green';
                    } catch (e) {
                        outputEl.textContent = `–ù–µ–≤–∞–ª–∏–¥–Ω—ã–π JSON: ${e.message}`;
                        outputEl.style.color = 'red';
                    }
                },
                
                clearJSON() {
                    App.elements.jsonInput.value = '';
                    App.elements.jsonOutput.textContent = '';
                    App.elements.jsonOutput.style.color = 'inherit';
                },

                encodeBase64() {
                    const input = App.elements.base64Input.value;
                    try {
                        App.elements.base64Output.value = btoa(unescape(encodeURIComponent(input)));
                    } catch (e) {
                        App.elements.base64Output.value = `–û—à–∏–±–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è: ${e.message}`;
                    }
                },

                decodeBase64() {
                    const input = App.elements.base64Input.value;
                    try {
                        App.elements.base64Output.value = decodeURIComponent(escape(atob(input)));
                    } catch (e) {
                        App.elements.base64Output.value = `–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è: ${e.message}`;
                    }
                },

                encodeURL() {
                    App.elements.urlOutput.value = encodeURIComponent(App.elements.urlInput.value);
                },

                decodeURL() {
                    try {
                        App.elements.urlOutput.value = decodeURIComponent(App.elements.urlInput.value);
                    } catch (e) {
                        App.elements.urlOutput.value = `–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è: ${e.message}`;
                    }
                },
                
                decodeJWT() {
                    const token = App.elements.jwtInput.value.trim();
                    const outputEl = App.elements.jwtOutput;
                    outputEl.innerHTML = '';

                    if (!token) {
                        outputEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞: –ü–æ–ª–µ –≤–≤–æ–¥–∞ –ø—É—Å—Ç–æ–µ.</p>`;
                        return;
                    }

                    try {
                        const [headerB64, payloadB64, signature] = token.split('.');
                        if (!headerB64 || !payloadB64 || !signature) {
                            throw new Error('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ JWT.');
                        }

                        const header = JSON.parse(atob(headerB64.replace(/-/g, '+').replace(/_/g, '/')));
                        const payload = JSON.parse(atob(payloadB64.replace(/-/g, '+').replace(/_/g, '/')));

                        outputEl.innerHTML = `
                            <div>
                                <h3 class="font-semibold text-pink-400">Header:</h3>
                                <pre class="p-2 mt-1 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono">${JSON.stringify(header, null, 2)}</pre>
                            </div>
                            <div>
                                <h3 class="font-semibold text-purple-400">Payload:</h3>
                                <pre class="p-2 mt-1 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono">${JSON.stringify(payload, null, 2)}</pre>
                            </div>
                             <div>
                                <h3 class="font-semibold text-cyan-400">Signature:</h3>
                                <div class="p-2 mt-1 rounded-lg bg-[var(--tg-secondary-bg)] text-sm whitespace-pre-wrap font-mono break-all">${signature}</div>
                            </div>
                        `;
                    } catch (e) {
                        outputEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è: ${e.message}</p>`;
                    }
                },

                async generateRegex() {
                    const prompt = App.elements.regexPrompt.value.trim();
                    if (!prompt) {
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞', message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –¥–æ–ª–∂–Ω–æ –¥–µ–ª–∞—Ç—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ.'});
                        return;
                    }
                    
                    const btn = App.elements.regexGenerateBtn;
                    btn.innerHTML = `<span class="loader"></span><span class="ml-2">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>`;
                    btn.disabled = true;

                    try {
                        const systemPrompt = App.api.createRegexGenerationPrompt(prompt);
                        const response = await App.api.callGemini(systemPrompt);
                        
                        const regexMatch = response.match(/\/(.*?)\/([gimyus]*)/) || response.match(/```(?:regex|)\n\/(.*?)\/([gimyus]*)\n```/s) || response.match(/```(?:regex|)\n(.*?)\n```/s);

                        if (!regexMatch || !regexMatch[1]) {
                           throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ –æ—Ç–≤–µ—Ç–∞ –ò–ò.");
                        }
                        
                        const regexPattern = regexMatch[1];
                        
                        App.elements.regexOutput.textContent = `/${regexPattern}/`;
                        App.elements.regexOutputContainer.classList.remove('hidden');
                        App.elements.regexTestResult.innerHTML = '';
                        
                    } catch (error) {
                        console.error('Regex Generation Error:', error);
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', message: error.message});
                    } finally {
                        btn.innerHTML = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å';
                        btn.disabled = false;
                    }
                },
                
                testRegex() {
                    const regexString = App.elements.regexOutput.textContent.trim();
                    const testString = App.elements.regexTestString.value;
                    const resultEl = App.elements.regexTestResult;

                    if (!regexString) {
                        resultEl.innerHTML = `<p class="text-yellow-500">–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ Regex.</p>`;
                        return;
                    }

                    try {
                        const match = regexString.match(/\/(.*?)\/([gimyus]*)/);
                        const regex = new RegExp(match[1], match[2]);
                        const matches = testString.match(regex);

                        if (matches) {
                            let highlightedString = testString.replace(regex, (m) => `<span class="bg-yellow-300 text-black px-1 rounded">${m}</span>`);
                            resultEl.innerHTML = `<p class="text-green-500 font-bold">–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: ${matches.length}</p><div class="mt-2 p-2 bg-[var(--tg-secondary-bg)] rounded">${highlightedString}</div>`;
                        } else {
                            resultEl.innerHTML = `<p class="text-red-500">–°–æ–≤–ø–∞–¥–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>`;
                        }
                    } catch (e) {
                         resultEl.innerHTML = `<p class="text-red-500">–û—à–∏–±–∫–∞ Regex: ${e.message}</p>`;
                    }
                },
                
                async generateGitCommand() {
                    const prompt = App.elements.gitPrompt.value.trim();
                    if (!prompt) {
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞', message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å.'});
                        return;
                    }
                    const btn = App.elements.gitGenerateBtn;
                    btn.innerHTML = `<span class="loader"></span><span class="ml-2">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>`;
                    btn.disabled = true;

                    try {
                        const systemPrompt = App.api.createGitCommandPrompt(prompt);
                        const response = await App.api.callGemini(systemPrompt);
                        const commandMatch = response.match(/```(?:bash|sh|git)?\n([\s\S]*?)\n```/s) || response.match(/`([^`]+)`/);
                        const command = commandMatch ? commandMatch[1].trim() : response.trim();

                        App.elements.gitOutput.querySelector('code').textContent = command;
                        App.elements.gitOutputContainer.classList.remove('hidden');
                    } catch (error) {
                        console.error('Git Command Generation Error:', error);
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', message: error.message});
                    } finally {
                        btn.innerHTML = '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å';
                        btn.disabled = false;
                    }
                },

                async calculateHashes() {
                    const input = App.elements.hashInput.value;
                    
                    // MD5 (using external library)
                    App.elements.hashMd5.textContent = md5(input);

                    // SHA-256 (using Web Crypto API)
                    try {
                        const encoder = new TextEncoder();
                        const data = encoder.encode(input);
                        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                        App.elements.hashSha256.textContent = hashHex;
                    } catch (e) {
                        App.elements.hashSha256.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏–∏ SHA-256';
                        console.error(e);
                    }
                },

                updateColors(source) {
                    if (App.state.isColorUpdating) return;
                    App.state.isColorUpdating = true;

                    const picker = App.elements.colorPicker;
                    const hexInput = App.elements.colorHex;
                    const rgbInput = App.elements.colorRgb;
                    const hslInput = App.elements.colorHsl;

                    let hex, rgb, hsl;

                    try {
                        if (source === 'color-picker') {
                            hex = picker.value;
                            rgb = this.hexToRgb(hex);
                            hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b);
                        } else if (source === 'color-hex') {
                            hex = hexInput.value;
                            if (!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(hex)) throw new Error();
                            rgb = this.hexToRgb(hex);
                            hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b);
                        } else if (source === 'color-rgb') {
                            const match = rgbInput.value.match(/(\d+),\s*(\d+),\s*(\d+)/);
                            if (!match) throw new Error();
                            rgb = { r: parseInt(match[1]), g: parseInt(match[2]), b: parseInt(match[3]) };
                            if (rgb.r > 255 || rgb.g > 255 || rgb.b > 255) throw new Error();
                            hex = this.rgbToHex(rgb.r, rgb.g, rgb.b);
                            hsl = this.rgbToHsl(rgb.r, rgb.g, rgb.b);
                        } else if (source === 'color-hsl') {
                            const match = hslInput.value.match(/(\d+),\s*(\d+)%?,\s*(\d+)%?/);
                            if (!match) throw new Error();
                            hsl = { h: parseInt(match[1]), s: parseInt(match[2]), l: parseInt(match[3]) };
                            if (hsl.h > 360 || hsl.s > 100 || hsl.l > 100) throw new Error();
                            rgb = this.hslToRgb(hsl.h, hsl.s, hsl.l);
                            hex = this.rgbToHex(rgb.r, rgb.g, rgb.b);
                        }

                        if (source !== 'color-picker') picker.value = hex;
                        if (source !== 'color-hex') hexInput.value = hex;
                        if (source !== 'color-rgb') rgbInput.value = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
                        if (source !== 'color-hsl') hslInput.value = `${hsl.h}, ${hsl.s}%, ${hsl.l}%`;
                        
                        [hexInput, rgbInput, hslInput].forEach(el => el.style.borderColor = 'transparent');

                    } catch (e) {
                        document.getElementById(source).style.borderColor = 'red';
                    } finally {
                        App.state.isColorUpdating = false;
                    }
                },

                hexToRgb(hex) {
                    let r = 0, g = 0, b = 0;
                    if (hex.length == 4) {
                        r = "0x" + hex[1] + hex[1];
                        g = "0x" + hex[2] + hex[2];
                        b = "0x" + hex[3] + hex[3];
                    } else if (hex.length == 7) {
                        r = "0x" + hex[1] + hex[2];
                        g = "0x" + hex[3] + hex[4];
                        b = "0x" + hex[5] + hex[6];
                    }
                    return { r: +r, g: +g, b: +b };
                },

                rgbToHex(r, g, b) {
                    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toLowerCase();
                },
                
                rgbToHsl(r, g, b) {
                    r /= 255; g /= 255; b /= 255;
                    let max = Math.max(r, g, b), min = Math.min(r, g, b);
                    let h, s, l = (max + min) / 2;
                    if (max == min) {
                        h = s = 0;
                    } else {
                        let d = max - min;
                        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                        switch(max) {
                            case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                            case g: h = (b - r) / d + 2; break;
                            case b: h = (r - g) / d + 4; break;
                        }
                        h /= 6;
                    }
                    return { h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100) };
                },

                hslToRgb(h, s, l) {
                    h /= 360; s /= 100; l /= 100;
                    let r, g, b;
                    if (s == 0) {
                        r = g = b = l;
                    } else {
                        const hue2rgb = (p, q, t) => {
                            if (t < 0) t += 1;
                            if (t > 1) t -= 1;
                            if (t < 1/6) return p + (q - p) * 6 * t;
                            if (t < 1/2) return q;
                            if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                            return p;
                        }
                        let q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                        let p = 2 * l - q;
                        r = hue2rgb(p, q, h + 1/3);
                        g = hue2rgb(p, q, h);
                        b = hue2rgb(p, q, h - 1/3);
                    }
                    return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
                },
                
                // PRO Tool Functions
                async generateImage() {
                    const prompt = App.elements.imagePrompt.value.trim();
                    if (!prompt) {
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞', message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.'});
                        return;
                    }
                    
                    if (!App.generationManager.checkLimits()) return;
                    
                    const btn = App.elements.imageGenerateBtn;
                    const loader = App.elements.imageLoader;
                    const outputImg = App.elements.imageOutput;

                    btn.disabled = true;
                    loader.classList.remove('hidden');
                    loader.classList.add('flex');
                    outputImg.classList.add('hidden');

                    try {
                        await App.generationManager.deductGeneration();
                        const imageData = await App.api.callImagen(prompt);
                        outputImg.src = `data:image/png;base64,${imageData}`;
                        outputImg.classList.remove('hidden');
                    } catch (error) {
                        console.error('Image Generation Error:', error);
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', message: error.message});
                    } finally {
                        btn.disabled = false;
                        loader.classList.add('hidden');
                        loader.classList.remove('flex');
                    }
                },

                async runCodeDoctor() {
                    const code = App.elements.codeDoctorInput.value.trim();
                    if (!code) {
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞', message: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—Å—Ç–∞–≤—å—Ç–µ –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.'});
                        return;
                    }
                    
                    if (!App.generationManager.checkLimits()) return;

                    const action = App.elements.codeDoctorAction.value;
                    const btn = App.elements.codeDoctorRunBtn;
                    const outputContainer = App.elements.codeDoctorOutputContainer;
                    const outputEl = App.elements.codeDoctorOutput;

                    btn.innerHTML = `<span class="loader"></span><span class="ml-2">–ê–Ω–∞–ª–∏–∑...</span>`;
                    btn.disabled = true;
                    outputContainer.classList.add('hidden');

                    try {
                        await App.generationManager.deductGeneration();
                        const systemPrompt = App.api.createCodeDoctorPrompt(code, action);
                        const response = await App.api.callGemini(systemPrompt);
                        
                        outputEl.textContent = response;
                        Prism.highlightElement(outputEl);
                        outputContainer.classList.remove('hidden');

                    } catch (error) {
                        console.error('Code Doctor Error:', error);
                        App.ui.showPopup({title: '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–∞', message: error.message});
                    } finally {
                        btn.innerHTML = '–í—ã–ø–æ–ª–Ω–∏—Ç—å';
                        btn.disabled = false;
                    }
                }
            },


            api: {
                createCodeGenerationPrompt(userPrompt, existingCode) {
                    const isPro = App.state.userProfile?.subscription_is_active;
                    const modelUsed = isPro ? 'Gemini 1.5 Pro' : 'Gemini 1.5 Flash';
                    const baseInstruction = `–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –±—ã—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –Ω–∞ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è. –¢—ã –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –¢–û–õ–¨–ö–û –∫–æ–¥ –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ \`\`\`...\`\`\`. –ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤–Ω–µ –∫–æ–¥–∞. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–º –∏ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º. –ò—Å–ø–æ–ª—å–∑—É–π Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏, –µ—Å–ª–∏ —ç—Ç–æ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –¢—ã —Ä–∞–±–æ—Ç–∞–µ—à—å –Ω–∞ –º–æ–¥–µ–ª–∏ ${modelUsed}.`;
                    return existingCode
                        ? `${baseInstruction}\n–í–æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:\n\n${existingCode}\n\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}".\n–ò–∑–º–µ–Ω–∏ –∫–æ–¥ –∏ –≤–µ—Ä–Ω–∏ –Ω–æ–≤—É—é –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é.`
                        : `${baseInstruction}\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}".\n–°–æ–∑–¥–∞–π –∫–æ–¥ —Å –Ω—É–ª—è.`;
                },
                createRegexGenerationPrompt(userPrompt) {
                    return `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏—è–º. –ü–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–π —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–∞–º–æ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ /pattern/flags, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–ª–∏ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –Ω–∞–π—Ç–∏ email, –≤–µ—Ä–Ω–∏ –ø—Ä–æ—Å—Ç–æ /\\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\\.[A-Z]{2,}\\b/i. –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}"`;
                },
                createGitCommandPrompt(userPrompt) {
                    return `–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Git. –ü–æ –∑–∞–ø—Ä–æ—Å—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å–æ–∑–¥–∞–π –û–î–ù–£ –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∫–æ–º–∞–Ω–¥—É Git. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û —Å–∞–º—É –∫–æ–º–∞–Ω–¥—É, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –ø—Ä–∏–º–µ—Ä–æ–≤ –∏–ª–∏ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç '–æ—Ç–∫–∞—Ç–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è', –≤–µ—Ä–Ω–∏ –ø—Ä–æ—Å—Ç–æ 'git reset --soft HEAD~1'. –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}"`;
                },
                createCodeDoctorPrompt(code, action) {
                    let actionText = '';
                    switch (action) {
                        case 'explain':
                            actionText = '–ü–æ–¥—Ä–æ–±–Ω–æ –æ–±—ä—è—Å–Ω–∏ —ç—Ç–æ—Ç –∫–æ–¥. –û–ø–∏—à–∏ –µ–≥–æ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏. –û—Ç–≤–µ—Ç –¥–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.';
                            break;
                        case 'refactor':
                            actionText = '–í—ã–ø–æ–ª–Ω–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —ç—Ç–æ–≥–æ –∫–æ–¥–∞. –£–ª—É—á—à–∏ –µ–≥–æ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É. –í–µ—Ä–Ω–∏ —Ç–æ–ª—å–∫–æ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –∫–æ–¥ –≤ –±–ª–æ–∫–µ ```...``` —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞.';
                            break;
                        case 'debug':
                            actionText = '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫, –±–∞–≥–æ–≤ –∏–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º. –£–∫–∞–∂–∏ –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –û—Ç–≤–µ—Ç –¥–∞–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ Markdown.';
                            break;
                    }
                    return `–¢—ã - –æ–ø—ã—Ç–Ω—ã–π –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫. –¢–µ–±–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω —Ñ—Ä–∞–≥–º–µ–Ω—Ç –∫–æ–¥–∞. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: ${actionText}\n\n–í–æ—Ç –∫–æ–¥ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:\n\`\`\`\n${code}\n\`\`\``;
                },
                async callGemini(prompt, retries = 3, delay = 1000) {
                    const isPro = App.state.userProfile?.subscription_is_active;
                    const model = isPro ? App.config.proModelName : App.config.freeModelName;
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${App.config.apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            if (response.status < 500 && response.status !== 429) {
                                const errorData = await response.json();
                                throw new Error(errorData.error?.message || `HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
                            }
                            throw new Error(`Server error: ${response.status}`);
                        }
                        const data = await response.json();
                        if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                           throw new Error('–ü–æ–ª—É—á–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–ª–∏ –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç API.');
                        }
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        if (retries > 0) {
                            console.warn(`Retrying... (${retries} left). Error: ${error.message}`);
                            await new Promise(res => setTimeout(res, delay));
                            return this.callGemini(prompt, retries - 1, delay * 2);
                        } else {
                            throw error;
                        }
                    }
                },
                 async callImagen(prompt, retries = 3, delay = 1000) {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${App.config.imageModelName}:predict?key=${App.config.apiKey}`;
                    const payload = { 
                        instances: [{ prompt: prompt }],
                        parameters: { "sampleCount": 1 }
                    };

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error?.message || `HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
                        }
                        const data = await response.json();
                        if (!data.predictions?.[0]?.bytesBase64Encoded) {
                           throw new Error('API –Ω–µ –≤–µ—Ä–Ω—É–ª–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.');
                        }
                        return data.predictions[0].bytesBase64Encoded;
                    } catch (error) {
                        if (retries > 0) {
                            console.warn(`Retrying image generation... (${retries} left). Error: ${error.message}`);
                            await new Promise(res => setTimeout(res, delay));
                            return this.callImagen(prompt, retries - 1, delay * 2);
                        } else {
                            throw error;
                        }
                    }
                }
            }
        };
        App.init();
    });
    </script>
</body>
</html>
