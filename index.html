<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI Web App Builder</title>
    
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключение Prism.js для подсветки синтаксиса -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    
    <!-- Стили приложения -->
    <style>
        :root {
            /* Переменные темы Telegram для светлой и темной темы */
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --tg-header-bg: var(--tg-theme-header-bg-color, #ffffff);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; /* Отключает "потягивание" для обновления страницы */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* Анимация появления страниц */
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* Стили для сообщений в чате */
        .chat-bubble { max-width: 85%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; line-height: 1.4; }
        .user-bubble { background-color: var(--tg-button); color: var(--tg-button-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: var(--tg-secondary-bg); color: var(--tg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        
        /* Стили для активных кнопок навигации */
        .nav-button.active { color: var(--tg-button); }
        .sub-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }

        /* Плавные переходы для кнопок */
        .btn-transition { transition: background-color 0.2s, opacity 0.2s, transform 0.1s; }
        .btn-transition:active { transform: scale(0.95); }

        /* Индикатор загрузки */
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-text);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Стили для блока кода, совместимые с Prism.js */
        pre[class*="language-"] {
            background: #2d2d2d;
            margin: 0;
            border-radius: 0;
        }
        code[class*="language-"] {
            font-size: 14px;
            line-height: 1.5;
        }

        /* Стили для модального окна истории */
        #history-modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            z-index: 40;
        }
        #history-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #history-modal-panel {
            position: fixed;
            left: 0; right: 0; bottom: 0;
            height: 75vh;
            background-color: var(--tg-bg);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            z-index: 50;
            display: flex;
            flex-direction: column;
            padding: 1rem;
            box-shadow: 0 -10px 25px -5px rgba(0,0,0,0.1), 0 -8px 10px -6px rgba(0,0,0,0.1);
        }
        #history-modal-panel.active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- Основной контейнер для страниц -->
    <main class="flex-grow overflow-hidden flex flex-col">
        <!-- СТРАНИЦА 1: ЧАТ С ИИ -->
        <div id="chat-page" class="page active flex-col h-full">
             <!-- Шапка чата -->
            <div class="flex-shrink-0 flex justify-between items-center p-2 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button id="history-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="История чатов">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                </button>
                <h1 id="chat-title" class="font-bold text-lg truncate px-2">Чат</h1>
                <button id="page-new-chat-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="Новый чат">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                </button>
            </div>
            <div id="chat-history" class="flex-grow p-4 flex flex-col space-y-2 overflow-y-auto"></div>
            <div class="flex-shrink-0 flex items-center space-x-2 p-2 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)]">
                <input id="prompt-input" type="text" placeholder="Ваш запрос..." class="w-full p-3 rounded-full focus:outline-none bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] placeholder-[var(--tg-hint)]">
                <button id="generate-button" class="p-3 rounded-full transition-opacity btn-transition flex-shrink-0 bg-[var(--tg-button)] text-[var(--tg-button-text)]" aria-label="Сгенерировать">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                </button>
            </div>
        </div>

        <!-- СТРАНИЦA 2: СОЗДАНИЕ (КОД + ПРЕВЬЮ) -->
        <div id="creation-page" class="page flex-col h-full">
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button data-view="code" class="sub-nav-button active w-1/2 p-4 text-center text-[var(--tg-hint)]">Код</button>
                <button data-view="preview" class="sub-nav-button w-1/2 p-4 text-center text-[var(--tg-hint)]">Превью</button>
            </div>
            <div id="code-view" class="flex-grow flex flex-col overflow-hidden">
                <div class="p-2 flex-shrink-0 flex justify-end items-center space-x-2 bg-[var(--tg-bg)] border-b border-[var(--tg-secondary-bg)]">
                    <button id="copy-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">Копировать</button>
                </div>
                <div class="flex-grow overflow-auto bg-[#2d2d2d]">
                    <pre><code id="code-output" class="language-html text-sm p-4 block whitespace-pre-wrap font-mono"></code></pre>
                </div>
            </div>
            <div id="preview-view" class="flex-grow hidden bg-white relative">
                <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
                <button id="refresh-preview-button" class="absolute top-4 right-4 p-2 rounded-full bg-[var(--tg-button)] text-[var(--tg-button-text)] shadow-lg btn-transition" aria-label="Обновить превью">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5" /></svg>
                </button>
            </div>
        </div>

        <!-- СТРАНИЦА 3: ПРОФИЛЬ -->
        <div id="profile-page" class="page p-4 overflow-y-auto flex-col h-full">
            <h2 class="text-2xl font-bold mb-4 flex-shrink-0">Профиль</h2>
            <div id="subscription-status" class="bg-[var(--tg-secondary-bg)] p-4 rounded-lg mb-6 flex-shrink-0"></div>
            <!-- История чатов была перенесена в модальное окно -->
        </div>
    </main>

    <!-- НИЖНЯЯ НАВИГАЦИОННАЯ ПАНЕЛЬ -->
    <footer class="flex-shrink-0 h-20 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)] flex justify-around items-center">
        <button data-page="chat-page" class="nav-button active flex flex-col items-center justify-center w-full h-full" aria-label="Чат">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
            <span class="text-xs">Чат</span>
        </button>
        <button data-page="creation-page" class="nav-button flex flex-col items-center justify-center w-full h-full" aria-label="Создание">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
            <span class="text-xs">Создание</span>
        </button>
        <button data-page="profile-page" class="nav-button flex flex-col items-center justify-center w-full h-full" aria-label="Профиль">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            <span class="text-xs">Профиль</span>
        </button>
    </footer>

    <!-- Модальное окно истории чатов -->
    <div id="history-modal-overlay"></div>
    <div id="history-modal-panel">
        <h3 class="text-xl font-bold mb-4 flex-shrink-0">История чатов</h3>
        <div id="chat-list" class="space-y-2 overflow-y-auto flex-grow"></div>
    </div>

    <!-- Подключение Prism.js JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            config: {
                apiKey: 'AIzaSyAg2oUJsSrbo2N9d4S5A0PVUuY9NEcXXRo',
                botToken: '8414348285:AAHpTtd6v3wbYVj2yq5DCTD0UKB1eBM9rnI',
                maxFreeGenerations: 5,
                storageKey: 'aiWebAppBuilderState_v6', // Версия изменена
                serverUrl: 'https://aiapp-rosy.vercel.app' // Ваш сервер
            },
            state: {
                activeChatId: null,
                chats: [],
                dailyGenerations: { count: 0, lastReset: 0 },
                subscription: { isActive: false, endDate: null },
                isGenerating: false,
                isPaying: false,
            },
            elements: {},
            tg: window.Telegram.WebApp,

            init() {
                this.tg.ready();
                this.tg.expand();
                this.cacheDOMElements();
                this.stateManager.load();
                this.ui.renderAll();
                this.eventManager.addEventListeners();
                console.log("App Initialized");
            },

            cacheDOMElements() {
                const ids = [
                    'chat-page', 'creation-page', 'profile-page', 'chat-history', 'prompt-input', 
                    'generate-button', 'code-view', 'preview-view', 'code-output', 'preview-iframe', 
                    'copy-button', 'subscription-status', 'chat-list', 'chat-title',
                    'history-button', 'page-new-chat-button', 'refresh-preview-button',
                    'history-modal-overlay', 'history-modal-panel'
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.elements[camelCaseId] = document.getElementById(id);
                });
                this.elements.pages = document.querySelectorAll('.page');
                this.elements.navButtons = document.querySelectorAll('.nav-button');
                this.elements.subNavButtons = document.querySelectorAll('.sub-nav-button');
            },

            stateManager: {
                load() {
                    const savedState = localStorage.getItem(App.config.storageKey);
                    if (savedState) {
                        Object.assign(App.state, JSON.parse(savedState));
                    } else {
                        this.setDefaultState();
                    }
                    this.checkDateBasedState();
                    this.save();
                },
                save() {
                    localStorage.setItem(App.config.storageKey, JSON.stringify(App.state));
                },
                setDefaultState() {
                    const initialChatId = `chat-${Date.now()}`;
                    App.state.activeChatId = initialChatId;
                    App.state.chats = [{ 
                        id: initialChatId, 
                        title: 'Новый чат', 
                        createdAt: new Date().toISOString(), 
                        messages: [{ sender: 'ai', text: 'Привет! 👋 Опиши, какое веб-приложение ты хочешь создать.' }], 
                        generatedCode: '' 
                    }];
                },
                checkDateBasedState() {
                    const todayStart = new Date().setHours(0, 0, 0, 0);
                    if (App.state.dailyGenerations.lastReset < todayStart) {
                        App.state.dailyGenerations = { count: 0, lastReset: todayStart };
                    }
                    if (App.state.subscription.isActive && new Date(App.state.subscription.endDate) < new Date()) {
                        App.state.subscription = { isActive: false, endDate: null };
                    }
                },
                getActiveChat() {
                    return App.state.chats.find(chat => chat.id === App.state.activeChatId);
                }
            },

            ui: {
                renderAll() {
                    this.renderActiveChat();
                    this.renderProfilePage();
                    this.renderChatList();
                },
                renderActiveChat() {
                    const chat = App.stateManager.getActiveChat();
                    if (!chat) return;
                    
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.chatHistory.innerHTML = '';
                    chat.messages.forEach(msg => this.addMessageToChat(msg.text, msg.sender));
                    
                    App.elements.codeOutput.textContent = chat.generatedCode || "// Код появится здесь после генерации";
                    Prism.highlightElement(App.elements.codeOutput);

                    App.elements.previewIframe.srcdoc = chat.generatedCode;
                },
                renderProfilePage() {
                    this.renderSubscriptionStatus();
                },
                renderSubscriptionStatus() {
                    const { subscription, dailyGenerations } = App.state;
                    const { maxFreeGenerations } = App.config;
                    const el = App.elements.subscriptionStatus;

                    if (subscription.isActive) {
                        el.innerHTML = `<p class="text-sm text-green-500 font-semibold">PRO Подписка активна</p><p class="text-lg font-bold">Неограниченно генераций</p><p class="text-xs opacity-70 mt-1">Истекает: ${new Date(subscription.endDate).toLocaleDateString()}</p>`;
                    } else {
                        el.innerHTML = `<p class="text-sm">Бесплатных генераций сегодня:</p><p class="text-2xl font-bold">${maxFreeGenerations - dailyGenerations.count} / ${maxFreeGenerations}</p><button id="subscribe-button" class="w-full mt-4 bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg btn-transition">Подписаться за 999 ★</button>`;
                        document.getElementById('subscribe-button').addEventListener('click', () => App.paymentManager.initiateSubscription());
                    }
                },
                renderChatList() {
                    const { chats, activeChatId } = App.state;
                    const el = App.elements.chatList;
                    el.innerHTML = '';
                    
                    chats.slice().reverse().forEach(chat => {
                        const chatItem = document.createElement('div');
                        const isActive = chat.id === activeChatId;
                        chatItem.className = `p-3 rounded-lg cursor-pointer ${isActive ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)]' : 'bg-[var(--tg-secondary-bg)]'}`;
                        chatItem.innerHTML = `<h4 class="font-semibold truncate">${chat.title}</h4><p class="text-xs opacity-70">${new Date(chat.createdAt).toLocaleString()}</p>`;
                        chatItem.addEventListener('click', () => {
                            App.state.activeChatId = chat.id;
                            App.stateManager.save();
                            this.renderAll();
                            this.closeHistoryModal();
                        });
                        el.appendChild(chatItem);
                    });
                },
                addMessageToChat(text, sender, isTyping = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-bubble ${sender}-bubble flex items-center`;
                    
                    if (isTyping) {
                        messageDiv.innerHTML = `<span class="loader mr-2"></span><span>${text}</span>`;
                        messageDiv.id = 'typing-indicator';
                    } else {
                        const textNode = document.createTextNode(text);
                        messageDiv.appendChild(textNode);
                    }
                    
                    App.elements.chatHistory.appendChild(messageDiv);
                    App.elements.chatHistory.scrollTop = App.elements.chatHistory.scrollHeight;
                    return messageDiv;
                },
                navigateToPage(pageId) {
                    App.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                    App.elements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
                },
                toggleCodePreview(view) {
                    App.elements.subNavButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
                    App.elements.codeView.classList.toggle('hidden', view !== 'code');
                    App.elements.previewView.classList.toggle('hidden', view !== 'preview');
                },
                toggleGenerationButton(disabled) {
                    App.state.isGenerating = disabled;
                    App.elements.generateButton.disabled = disabled;
                    App.elements.generateButton.style.opacity = disabled ? '0.7' : '1';
                    App.elements.generateButton.style.cursor = disabled ? 'not-allowed' : 'pointer';
                },
                showPopup(options) {
                    App.tg.showPopup(options);
                },
                typeCode(code, element) {
                    return new Promise(resolve => {
                        element.textContent = '';
                        let i = 0;
                        const codeContainer = element.parentElement;

                        function type() {
                            if (i < code.length) {
                                const chunk = code.substring(i, i + 5);
                                element.textContent += chunk;
                                i += 5;
                                if (i > code.length) i = code.length;
                                
                                Prism.highlightElement(element);
                                codeContainer.scrollTop = codeContainer.scrollHeight;
                                
                                requestAnimationFrame(type);
                            } else {
                                resolve();
                            }
                        }
                        type();
                    });
                },
                openHistoryModal() {
                    App.elements.historyModalOverlay.classList.add('active');
                    App.elements.historyModalPanel.classList.add('active');
                },
                closeHistoryModal() {
                    App.elements.historyModalOverlay.classList.remove('active');
                    App.elements.historyModalPanel.classList.remove('active');
                }
            },

            eventManager: {
                addEventListeners() {
                    App.elements.navButtons.forEach(button => button.addEventListener('click', () => App.ui.navigateToPage(button.dataset.page)));
                    App.elements.subNavButtons.forEach(button => button.addEventListener('click', () => App.ui.toggleCodePreview(button.dataset.view)));
                    App.elements.generateButton.addEventListener('click', () => App.generationManager.handleGeneration());
                    App.elements.promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') App.generationManager.handleGeneration(); });
                    App.elements.copyButton.addEventListener('click', () => App.chatManager.copyCode());
                    
                    App.elements.historyButton.addEventListener('click', App.ui.openHistoryModal);
                    App.elements.historyModalOverlay.addEventListener('click', App.ui.closeHistoryModal);
                    App.elements.pageNewChatButton.addEventListener('click', () => App.chatManager.createNewChat());
                    App.elements.refreshPreviewButton.addEventListener('click', () => {
                        const chat = App.stateManager.getActiveChat();
                        if (chat) App.elements.previewIframe.srcdoc = chat.generatedCode;
                        App.tg.HapticFeedback.notificationOccurred('success');
                    });
                }
            },

            chatManager: {
                createNewChat() {
                    const newId = `chat-${Date.now()}`;
                    App.state.chats.push({ 
                        id: newId, 
                        title: 'Новый чат', 
                        createdAt: new Date().toISOString(), 
                        messages: [{ sender: 'ai', text: 'Новый чат создан. Что будем делать?' }], 
                        generatedCode: '' 
                    });
                    App.state.activeChatId = newId;
                    App.stateManager.save();
                    App.ui.renderAll();
                    App.ui.closeHistoryModal();
                },
                copyCode() {
                    const code = App.stateManager.getActiveChat().generatedCode;
                    if (!code) return;
                    const textarea = document.createElement('textarea');
                    textarea.value = code;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        App.tg.HapticFeedback.notificationOccurred('success');
                        const originalText = App.elements.copyButton.textContent;
                        App.elements.copyButton.textContent = 'Скопировано!';
                        setTimeout(() => { App.elements.copyButton.textContent = originalText; }, 2000);
                    } catch (err) {
                        App.tg.HapticFeedback.notificationOccurred('error');
                        App.ui.showPopup({ title: 'Ошибка', message: 'Не удалось скопировать код.' });
                    }
                    document.body.removeChild(textarea);
                }
            },
            
            paymentManager: {
                async initiateSubscription() {
                    if (App.state.isPaying) return;
                    App.state.isPaying = true;
                    App.tg.MainButton.showProgress();

                    try {
                        // 1. Клиент запрашивает ссылку на инвойс у своего сервера
                        const response = await fetch(`${App.config.serverUrl}/api/create-invoice`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ initData: App.tg.initData })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            throw new Error(errorData.error || 'Не удалось создать счет.');
                        }

                        const { invoice_slug } = await response.json();

                        // 2. Клиент открывает окно оплаты с полученной ссылкой
                        App.tg.openInvoice(invoice_slug, (status) => {
                            if (status === 'paid') {
                                // 3. Пользователь видит успех. Реальная активация происходит на сервере через webhook.
                                // Мы можем обновить статус здесь для немедленного отклика UI,
                                // но это должно быть подтверждено с сервера.
                                this.activateSubscription();
                                App.ui.showPopup({
                                    title: 'Успешно!',
                                    message: 'Подписка PRO активирована на 30 дней. Обновление может занять до минуты.'
                                });
                                App.tg.HapticFeedback.notificationOccurred('success');
                            } else if (status === 'cancelled') {
                                App.ui.showPopup({ title: 'Отменено', message: 'Оплата была отменена.' });
                                App.tg.HapticFeedback.notificationOccurred('warning');
                            } else {
                                App.ui.showPopup({ title: 'Ошибка', message: `Статус платежа: ${status}. Попробуйте снова.` });
                                App.tg.HapticFeedback.notificationOccurred('error');
                            }
                        });

                    } catch (error) {
                        console.error('Payment initiation error:', error);
                        App.ui.showPopup({ title: 'Ошибка сервера', message: error.message });
                    } finally {
                        App.state.isPaying = false;
                        App.tg.MainButton.hideProgress();
                    }
                },
                activateSubscription() {
                    // Этот метод вызывается для немедленного обновления UI.
                    // Основная логика должна быть на сервере.
                    const now = new Date();
                    App.state.subscription.isActive = true;
                    App.state.subscription.endDate = new Date(now.setDate(now.getDate() + 30)).toISOString();
                    App.stateManager.save();
                    App.ui.renderSubscriptionStatus(); 
                }
            },

            generationManager: {
                async handleGeneration() {
                    if (App.state.isGenerating) return;

                    if (!App.state.subscription.isActive && App.state.dailyGenerations.count >= App.config.maxFreeGenerations) {
                        App.ui.showPopup({
                            title: 'Лимит исчерпан',
                            message: 'Вы использовали все бесплатные генерации. Оформите PRO подписку для неограниченного доступа!',
                            buttons: [{ id: 'subscribe', type: 'default', text: 'Подписаться' }, { type: 'cancel' }]
                        }, (buttonId) => {
                            if (buttonId === 'subscribe') {
                                App.ui.navigateToPage('profile-page');
                                App.paymentManager.initiateSubscription();
                            }
                        });
                        return;
                    }

                    const prompt = App.elements.promptInput.value.trim();
                    if (!prompt) return;

                    App.ui.toggleGenerationButton(true);
                    const chat = App.stateManager.getActiveChat();
                    chat.messages.push({ sender: 'user', text: prompt });
                    if (chat.title === 'Новый чат' || chat.title.trim() === '') {
                        chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                    }
                    
                    App.ui.addMessageToChat(prompt, 'user');
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.promptInput.value = '';
                    
                    const indicator = App.ui.addMessageToChat('Пишу код...', 'ai', true);

                    try {
                        const systemPrompt = App.api.createCodeGenerationPrompt(prompt, chat.generatedCode);
                        const newCode = await App.api.callGemini(systemPrompt);
                        const codeMatch = newCode.match(/```(?:html|css|javascript)\n([\s\S]*?)\n```/s);
                        const finalCode = codeMatch ? codeMatch[1] : newCode;

                        indicator.remove();
                        App.ui.navigateToPage('creation-page');
                        App.ui.toggleCodePreview('code');

                        await App.ui.typeCode(finalCode, App.elements.codeOutput);

                        chat.generatedCode = finalCode;
                        chat.messages.push({ sender: 'ai', text: 'Готово! Код обновлен.' });
                        if (!App.state.subscription.isActive) {
                            App.state.dailyGenerations.count++;
                        }
                        App.stateManager.save();
                        App.ui.renderProfilePage();
                        App.tg.HapticFeedback.notificationOccurred('success');

                    } catch (error) {
                        console.error('Generation Error:', error);
                        indicator.remove();
                        chat.messages.push({ sender: 'ai', text: `Произошла ошибка: ${error.message}.` });
                        App.tg.HapticFeedback.notificationOccurred('error');
                        App.stateManager.save();
                        App.ui.renderAll();
                    } finally {
                        App.ui.toggleGenerationButton(false);
                    }
                }
            },

            api: {
                createCodeGenerationPrompt(userPrompt, existingCode) {
                    const baseInstruction = `Твоя задача - быть экспертом по созданию веб-страниц. Ты должен вернуть ТОЛЬКО HTML-код в одном блоке \`\`\`html ... \`\`\`. Без лишних слов, объяснений или комментариев вне кода. Код должен быть полным и самодостаточным (включая HTML, CSS в <style> и JS в <script>). Используй Tailwind CSS для стилизации.`;
                    return existingCode
                        ? `${baseInstruction}\nВот существующий код:\n\n${existingCode}\n\nЗапрос пользователя: "${userPrompt}".\nИзмени код и верни новую полную версию.`
                        : `${baseInstruction}\nЗапрос пользователя: "${userPrompt}".\nСоздай код с нуля.`;
                },
                async callGemini(prompt, retries = 3, delay = 1000) {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${App.config.apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                            if (response.status < 500 && response.status !== 429) {
                                const errorData = await response.json();
                                throw new Error(errorData.error?.message || `HTTP ошибка: ${response.status}`);
                            }
                            throw new Error(`Server error: ${response.status}`);
                        }
                        const data = await response.json();
                        if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                           throw new Error('Получен неверный ответ от API.');
                        }
                        return data.candidates[0].content.parts[0].text;
                    } catch (error) {
                        if (retries > 0) {
                            console.warn(`Retrying... (${retries} left). Error: ${error.message}`);
                            await new Promise(res => setTimeout(res, delay));
                            return this.callGemini(prompt, retries - 1, delay * 2);
                        } else {
                            throw error;
                        }
                    }
                }
            }
        };
        App.init();
    });
    </script>
</body>
</html>
