<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI Web App Builder</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0; padding: 0; padding-bottom: 80px;
            overscroll-behavior: none;
        }
        .nav-button.active { color: var(--tg-button); }
        .page { display: none; animation: fadeIn 0.3s; height: calc(100vh - 80px); }
        .page.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chat-bubble { max-width: 85%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; }
        .user-bubble { background-color: var(--tg-button); color: var(--tg-button-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: var(--tg-secondary-bg); color: var(--tg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        #prompt-input { background-color: var(--tg-secondary-bg); color: var(--tg-text); }
        #prompt-input::placeholder { color: var(--tg-hint); }
        #generate-button { background-color: var(--tg-button); color: var(--tg-button-text); }
        #generate-button:disabled { opacity: 0.7; cursor: not-allowed; }
        .sub-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); }
    </style>
</head>
<body class="overflow-hidden">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <main>
        <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ß–ê–¢ –° –ò–ò -->
        <div id="chat-page" class="page active">
            <div id="chat-history" class="flex-grow p-4 flex flex-col space-y-2 overflow-y-auto"></div>
            <div class="mt-auto flex items-center space-x-2 p-2 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)]">
                <input id="prompt-input" type="text" placeholder="–í–∞—à –∑–∞–ø—Ä–æ—Å..." class="w-full p-3 rounded-full focus:outline-none">
                <button id="generate-button" class="p-3 rounded-full transition-opacity"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg></button>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 2: –°–û–ó–î–ê–ù–ò–ï (–ö–û–î + –ü–†–ï–í–¨–Æ) -->
        <div id="creation-page" class="page">
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)]">
                <button data-view="code" class="sub-nav-button active w-1/2 p-4 text-center font-semibold">–ö–æ–¥</button>
                <button data-view="preview" class="sub-nav-button w-1/2 p-4 text-center font-semibold">–ü—Ä–µ–≤—å—é</button>
            </div>
            <div id="code-view" class="flex-grow flex flex-col">
                <div class="p-4 flex-shrink-0 flex justify-end items-center bg-[var(--tg-bg)] border-b border-[var(--tg-secondary-bg)]"><div class="flex space-x-2"><button id="explain-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold">–û–±—ä—è—Å–Ω–∏—Ç—å ‚ú®</button><button id="copy-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button></div></div>
                <div class="flex-grow overflow-auto bg-[#2d2d2d] text-white"><pre><code id="code-output" class="text-sm p-4 block whitespace-pre-wrap font-mono"></code></pre></div>
            </div>
            <div id="preview-view" class="flex-grow hidden"><iframe id="preview-iframe" class="w-full h-full border-0"></iframe></div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ü–†–û–§–ò–õ–¨ -->
        <div id="profile-page" class="page p-4 overflow-y-auto">
            <h2 class="text-2xl font-bold mb-4">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="subscription-status" class="bg-[var(--tg-secondary-bg)] p-4 rounded-lg mb-6"></div>
            <div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h3><button id="new-chat-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm">–ù–æ–≤—ã–π —á–∞—Ç</button></div>
            <div id="chat-list" class="space-y-2"></div>
        </div>
    </main>

    <!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <footer class="fixed bottom-0 left-0 right-0 h-20 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)] flex justify-around items-center">
        <button data-page="chat-page" class="nav-button active flex flex-col items-center justify-center w-full h-full"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="text-xs">–ß–∞—Ç</span></button>
        <button data-page="creation-page" class="nav-button flex flex-col items-center justify-center w-full h-full"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg><span class="text-xs">–°–æ–∑–¥–∞–Ω–∏–µ</span></button>
        <button data-page="profile-page" class="nav-button flex flex-col items-center justify-center w-full h-full"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span></button>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            // --- DOM ELEMENTS ---
            const pages = document.querySelectorAll('.page');
            const navButtons = document.querySelectorAll('.nav-button');
            const subNavButtons = document.querySelectorAll('.sub-nav-button');
            const generateButton = document.getElementById('generate-button');
            const promptInput = document.getElementById('prompt-input');
            const chatHistoryEl = document.getElementById('chat-history');
            const codeOutputEl = document.getElementById('code-output');
            const previewIframe = document.getElementById('preview-iframe');
            const copyButton = document.getElementById('copy-button');
            const explainButton = document.getElementById('explain-button');
            const subscriptionStatusEl = document.getElementById('subscription-status');
            const chatListEl = document.getElementById('chat-list');
            const newChatButton = document.getElementById('new-chat-button');
            const codeView = document.getElementById('code-view');
            const previewView = document.getElementById('preview-view');

            const apiKey = 'AIzaSyAg2oUJsSrbo2N9d4S5A0PVUuY9NEcXXRo';
            const MAX_FREE_GENERATIONS = 5;
            const BOT_TOKEN = '8414348285:AAHpTtd6v3wbYVj2yq5DCTD0UKB1eBM9rnI';

            let appState = {};

            // --- STATE MANAGEMENT ---
            function loadState() {
                const defaultState = {
                    activeChatId: 'chat-1',
                    chats: [{ id: 'chat-1', title: '–ù–æ–≤—ã–π —á–∞—Ç', createdAt: new Date().toISOString(), messages: [{ sender: 'ai', text: '–ü—Ä–∏–≤–µ—Ç! üëã –û–ø–∏—à–∏, –∫–∞–∫–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç—ã —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å.' }], generatedCode: '' }],
                    dailyGenerations: { count: 0, lastReset: new Date().setHours(0, 0, 0, 0) },
                    subscription: { isActive: false, endDate: null }
                };
                const savedState = localStorage.getItem('aiWebAppBuilderState_v2');
                appState = savedState ? JSON.parse(savedState) : defaultState;

                const todayStart = new Date().setHours(0, 0, 0, 0);
                if (appState.dailyGenerations.lastReset < todayStart) {
                    appState.dailyGenerations.count = 0;
                    appState.dailyGenerations.lastReset = todayStart;
                }
                
                if (appState.subscription.isActive && new Date(appState.subscription.endDate) < new Date()) {
                    appState.subscription.isActive = false;
                    appState.subscription.endDate = null;
                }
                saveState();
            }

            function saveState() {
                localStorage.setItem('aiWebAppBuilderState_v2', JSON.stringify(appState));
            }

            function getActiveChat() {
                return appState.chats.find(chat => chat.id === appState.activeChatId);
            }

            // --- UI RENDERING ---
            function renderAll() {
                renderActiveChat();
                renderProfilePage();
            }

            function renderActiveChat() {
                const chat = getActiveChat();
                if (!chat) return;
                chatHistoryEl.innerHTML = '';
                chat.messages.forEach(msg => addMessageToChat(msg.text, msg.sender));
                codeOutputEl.textContent = chat.generatedCode;
                previewIframe.srcdoc = chat.generatedCode;
            }

            function renderProfilePage() {
                if (appState.subscription.isActive) {
                    subscriptionStatusEl.innerHTML = `
                        <p class="text-sm text-green-500 font-semibold">PRO –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</p>
                        <p class="text-lg font-bold">–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</p>
                        <p class="text-xs opacity-70 mt-1">–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(appState.subscription.endDate).toLocaleDateString()}</p>`;
                } else {
                    subscriptionStatusEl.innerHTML = `
                        <p class="text-sm">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è:</p>
                        <p class="text-2xl font-bold">${MAX_FREE_GENERATIONS - appState.dailyGenerations.count} / ${MAX_FREE_GENERATIONS}</p>
                        <button id="subscribe-button" class="w-full mt-4 bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –∑–∞ 999 Stars</button>`;
                    document.getElementById('subscribe-button').addEventListener('click', handleSubscription);
                }

                chatListEl.innerHTML = '';
                appState.chats.slice().reverse().forEach(chat => {
                    const chatItem = document.createElement('div');
                    chatItem.className = `p-3 rounded-lg cursor-pointer ${chat.id === appState.activeChatId ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)]' : 'bg-[var(--tg-secondary-bg)]'}`;
                    chatItem.innerHTML = `<h4 class="font-semibold truncate">${chat.title}</h4><p class="text-xs opacity-70">${new Date(chat.createdAt).toLocaleString()}</p>`;
                    chatItem.addEventListener('click', () => {
                        appState.activeChatId = chat.id;
                        saveState();
                        renderAll();
                        navigateToPage('chat-page');
                    });
                    chatListEl.appendChild(chatItem);
                });
            }

            // --- NAVIGATION ---
            function navigateToPage(pageId) {
                pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
            }
            navButtons.forEach(button => button.addEventListener('click', () => navigateToPage(button.dataset.page)));
            subNavButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.dataset.view;
                    subNavButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
                    codeView.classList.toggle('hidden', view !== 'code');
                    previewView.classList.toggle('hidden', view !== 'preview');
                });
            });

            // --- CHAT MANAGEMENT ---
            newChatButton.addEventListener('click', () => {
                const newId = `chat-${Date.now()}`;
                appState.chats.push({ id: newId, title: '–ù–æ–≤—ã–π —á–∞—Ç', createdAt: new Date().toISOString(), messages: [{ sender: 'ai', text: '–ù–æ–≤—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω. –ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?' }], generatedCode: '' });
                appState.activeChatId = newId;
                saveState();
                renderAll();
                navigateToPage('chat-page');
            });

            // --- SUBSCRIPTION & PAYMENT ---
            function handleSubscription() {
                const invoice = {
                    title: 'PRO –ü–æ–¥–ø–∏—Å–∫–∞ (1 –º–µ—Å—è—Ü)',
                    description: '–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º AI Web App Builder –Ω–∞ 30 –¥–Ω–µ–π.',
                    prices: [{ label: 'PRO –ü–æ–¥–ø–∏—Å–∫–∞', amount: 99900 }], // Amount is in the smallest units of the currency (e.g., cents for USD, 1 star = 1 cent)
                    currency: 'XTR',
                    provider_token: BOT_TOKEN, // In a real app, this should be a live payment provider token
                    payload: `monthly_sub_user_${tg.initDataUnsafe.user?.id}_${Date.now()}`
                };
                
                tg.showInvoice(invoice.payload, (status, invoice_id) => {
                    if (status === 'paid') {
                        tg.HapticFeedback.notificationOccurred('success');
                        
                        // --- –í–ê–ñ–ù–û: –°–ï–†–í–ï–†–ù–ê–Ø –í–ê–õ–ò–î–ê–¶–ò–Ø ---
                        // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ù–ï–û–ë–•–û–î–ò–ú–û –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `invoice_id` –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.
                        // –í–∞—à —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å webhook-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç Telegram, —É–±–µ–¥–∏—Ç—å—Å—è,
                        // —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—à–µ–ª, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
                        // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–∞–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É.
                        
                        // --- –°–ò–ú–£–õ–Ø–¶–ò–Ø –î–õ–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò ---
                        // –ú—ã —Å–∏–º—É–ª–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω—É—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.
                        const now = new Date();
                        appState.subscription.isActive = true;
                        appState.subscription.endDate = new Date(now.setDate(now.getDate() + 30)).toISOString();
                        saveState();
                        renderProfilePage(); // –û–±–Ω–æ–≤–ª—è–µ–º UI –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
                        
                    } else if (status === 'failed' || status === 'cancelled') {
                        tg.HapticFeedback.notificationOccurred('error');
                        alert('–ü–ª–∞—Ç–µ–∂ –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
                    }
                });
            }

            // --- CORE GENERATION LOGIC ---
            async function handleGeneration() {
                if (!appState.subscription.isActive && appState.dailyGenerations.count >= MAX_FREE_GENERATIONS) {
                    tg.showPopup({
                        title: '–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω',
                        message: '–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –û—Ñ–æ—Ä–º–∏—Ç–µ PRO –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!',
                        buttons: [{ id: 'subscribe', type: 'default', text: '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è' }, { type: 'cancel' }]
                    }, (buttonId) => {
                        if (buttonId === 'subscribe') {
                            navigateToPage('profile-page');
                            handleSubscription();
                        }
                    });
                    return;
                }
                
                const prompt = promptInput.value.trim();
                if (!prompt || generateButton.disabled) return;

                const chat = getActiveChat();
                chat.messages.push({ sender: 'user', text: prompt });
                if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç') chat.title = prompt;
                addMessageToChat(prompt, 'user');
                promptInput.value = '';
                generateButton.disabled = true;

                const indicator = addMessageToChat('–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∑–∞–ø—Ä–æ—Å...', 'ai', true);
                
                try {
                    const newCode = await generateCodeWithGemini(prompt, chat.generatedCode || null);
                    chat.generatedCode = newCode;
                    chat.messages.push({ sender: 'ai', text: '–ì–æ—Ç–æ–≤–æ! –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω.' });
                    
                    if (!appState.subscription.isActive) {
                        appState.dailyGenerations.count++;
                    }
                    saveState();
                    
                    indicator.remove();
                    renderAll();
                    tg.HapticFeedback.notificationOccurred('success');

                } catch (error) {
                    indicator.remove();
                    addMessageToChat(`–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}.`, 'ai');
                    tg.HapticFeedback.notificationOccurred('error');
                } finally {
                    generateButton.disabled = false;
                }
            }
            generateButton.addEventListener('click', handleGeneration);
            promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleGeneration(); });

            // --- GEMINI API CALLS ---
            async function callGemini(prompt) {
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            async function generateCodeWithGemini(userPrompt, existingCode) {
                const baseInstruction = `–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –¢–û–õ–¨–ö–û HTML-–∫–æ–¥. –ë–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –±–µ–∑ markdown, –±–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.`;
                let fullPrompt = existingCode 
                    ? `${baseInstruction}\n–í–æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:\n\n${existingCode}\n\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}".\n–ò–∑–º–µ–Ω–∏ –∫–æ–¥ –∏ –≤–µ—Ä–Ω–∏ –Ω–æ–≤—É—é –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é.`
                    : `${baseInstruction}\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}".\n–°–æ–∑–¥–∞–π –∫–æ–¥ —Å –Ω—É–ª—è.`;
                return await callGemini(fullPrompt);
            }
            
            // --- HELPER FUNCTIONS ---
            function addMessageToChat(text, sender, isTyping = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-bubble ${sender}-bubble`;
                messageDiv.innerHTML = text;
                if (isTyping) messageDiv.id = 'typing-indicator';
                chatHistoryEl.appendChild(messageDiv);
                chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
                return messageDiv;
            }
            
            copyButton.addEventListener('click', () => {
                navigator.clipboard.writeText(getActiveChat().generatedCode).then(() => tg.HapticFeedback.notificationOccurred('success'));
            });
            
            explainButton.addEventListener('click', async () => {
                const code = getActiveChat().generatedCode;
                if (!code) return;
                tg.showPopup({title: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞', message: '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É –ò–ò...'});
                try {
                    const prompt = `–û–±—ä—è—Å–Ω–∏ —Å–ª–µ–¥—É—é—â–∏–π HTML-–∫–æ–¥ –ø–æ—à–∞–≥–æ–≤–æ, –ø—Ä–æ—Å—Ç—ã–º —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º. –í–æ—Ç –∫–æ–¥:\n\n${code}`;
                    const explanation = await callGemini(prompt);
                    tg.showPopup({title: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞', message: explanation, buttons: [{type: 'ok'}]});
                } catch (error) {
                    tg.showPopup({title: '–û—à–∏–±–∫–∞', message: `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ: ${error.message}`, buttons: [{type: 'ok'}]});
                }
            });

            // --- INITIALIZATION ---
            loadState();
            renderAll();
        });
    </script>
</body>
</html>

