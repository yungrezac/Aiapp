<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI Web App Builder</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –°—Ç–∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <style>
        :root {
            /* –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã Telegram –¥–ª—è —Å–≤–µ—Ç–ª–æ–π –∏ —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --tg-header-bg: var(--tg-theme-header-bg-color, #ffffff);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; /* –û—Ç–∫–ª—é—á–∞–µ—Ç "–ø–æ—Ç—è–≥–∏–≤–∞–Ω–∏–µ" –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü */
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç–µ */
        .chat-bubble { max-width: 85%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; line-height: 1.4; }
        .user-bubble { background-color: var(--tg-button); color: var(--tg-button-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: var(--tg-secondary-bg); color: var(--tg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-button.active { color: var(--tg-button); }
        .sub-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }

        /* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ */
        .btn-transition { transition: background-color 0.2s, opacity 0.2s, transform 0.1s; }
        .btn-transition:active { transform: scale(0.95); }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ */
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-text);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col h-screen">

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü -->
    <main class="flex-grow overflow-hidden flex flex-col">
        <!-- –°–¢–†–ê–ù–ò–¶–ê 1: –ß–ê–¢ –° –ò–ò -->
        <div id="chat-page" class="page active flex-col h-full">
            <div id="chat-history" class="flex-grow p-4 flex flex-col space-y-2 overflow-y-auto"></div>
            <div class="flex-shrink-0 flex items-center space-x-2 p-2 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)]">
                <input id="prompt-input" type="text" placeholder="–í–∞—à –∑–∞–ø—Ä–æ—Å..." class="w-full p-3 rounded-full focus:outline-none bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] placeholder-[var(--tg-hint)]">
                <button id="generate-button" class="p-3 rounded-full transition-opacity btn-transition flex-shrink-0 bg-[var(--tg-button)] text-[var(--tg-button-text)]" aria-label="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" /></svg>
                </button>
            </div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶A 2: –°–û–ó–î–ê–ù–ò–ï (–ö–û–î + –ü–†–ï–í–¨–Æ) -->
        <div id="creation-page" class="page flex-col h-full">
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button data-view="code" class="sub-nav-button active w-1/2 p-4 text-center text-[var(--tg-hint)]">–ö–æ–¥</button>
                <button data-view="preview" class="sub-nav-button w-1/2 p-4 text-center text-[var(--tg-hint)]">–ü—Ä–µ–≤—å—é</button>
            </div>
            <div id="code-view" class="flex-grow flex flex-col overflow-hidden">
                <div class="p-2 flex-shrink-0 flex justify-end items-center space-x-2 bg-[var(--tg-bg)] border-b border-[var(--tg-secondary-bg)]">
                    <button id="explain-button" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg text-sm font-semibold btn-transition">–û–±—ä—è—Å–Ω–∏—Ç—å ‚ú®</button>
                    <button id="copy-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
                <div class="flex-grow overflow-auto bg-[#2d2d2d] text-white">
                    <pre><code id="code-output" class="text-sm p-4 block whitespace-pre-wrap font-mono"></code></pre>
                </div>
            </div>
            <div id="preview-view" class="flex-grow hidden bg-white"><iframe id="preview-iframe" class="w-full h-full border-0"></iframe></div>
        </div>

        <!-- –°–¢–†–ê–ù–ò–¶–ê 3: –ü–†–û–§–ò–õ–¨ -->
        <div id="profile-page" class="page p-4 overflow-y-auto flex-col h-full">
            <h2 class="text-2xl font-bold mb-4 flex-shrink-0">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div id="subscription-status" class="bg-[var(--tg-secondary-bg)] p-4 rounded-lg mb-6 flex-shrink-0"></div>
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h3 class="text-xl font-bold">–ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–æ–≤</h3>
                <button id="new-chat-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">–ù–æ–≤—ã–π —á–∞—Ç</button>
            </div>
            <div id="chat-list" class="space-y-2 overflow-y-auto"></div>
        </div>
    </main>

    <!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–û–ù–ù–ê–Ø –ü–ê–ù–ï–õ–¨ -->
    <footer class="flex-shrink-0 h-20 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)] flex justify-around items-center">
        <button data-page="chat-page" class="nav-button active flex flex-col items-center justify-center w-full h-full" aria-label="–ß–∞—Ç">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
            <span class="text-xs">–ß–∞—Ç</span>
        </button>
        <button data-page="creation-page" class="nav-button flex flex-col items-center justify-center w-full h-full" aria-label="–°–æ–∑–¥–∞–Ω–∏–µ">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg>
            <span class="text-xs">–°–æ–∑–¥–∞–Ω–∏–µ</span>
        </button>
        <button data-page="profile-page" class="nav-button flex flex-col items-center justify-center w-full h-full" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
            <svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            <span class="text-xs">–ü—Ä–æ—Ñ–∏–ª—å</span>
        </button>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        /**
         * =================================================================
         * App: –û—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
         * –ò–Ω–∫–∞–ø—Å—É–ª–∏—Ä—É–µ—Ç –≤—Å—é –ª–æ–≥–∏–∫—É: —Å–æ—Å—Ç–æ—è–Ω–∏–µ, UI, API, —Å–æ–±—ã—Ç–∏—è.
         * =================================================================
         */
        const App = {
            // --- –ö–õ–Æ–ß–ò –ò –ö–û–ù–°–¢–ê–ù–¢–´ (–ù–ï –£–î–ê–õ–Ø–¢–¨) ---
            config: {
                apiKey: 'AIzaSyAg2oUJsSrbo2N9d4S5A0PVUuY9NEcXXRo',
                botToken: '8414348285:AAHpTtd6v3wbYVj2yq5DCTD0UKB1eBM9rnI', // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
                maxFreeGenerations: 5,
                storageKey: 'aiWebAppBuilderState_v3' // –û–±–Ω–æ–≤–ª–µ–Ω –∫–ª—é—á –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —Å–æ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–µ–π
            },

            // --- –°–û–°–¢–û–Ø–ù–ò–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
            state: {
                activeChatId: null,
                chats: [],
                dailyGenerations: { count: 0, lastReset: 0 },
                subscription: { isActive: false, endDate: null },
                isGenerating: false,
            },

            // --- –≠–õ–ï–ú–ï–ù–¢–´ DOM ---
            elements: {},

            // --- TELEGRAM SDK ---
            tg: window.Telegram.WebApp,

            /**
             * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
             */
            init() {
                this.tg.ready();
                this.tg.expand();
                this.cacheDOMElements();
                this.stateManager.load();
                this.ui.renderAll();
                this.eventManager.addEventListeners();
                console.log("App Initialized. User:", this.tg.initDataUnsafe.user);
            },

            /**
             * –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫ –Ω–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
             */
            cacheDOMElements() {
                const ids = [
                    'chat-page', 'creation-page', 'profile-page', 'chat-history', 'prompt-input', 
                    'generate-button', 'code-view', 'preview-view', 'code-output', 'preview-iframe', 
                    'copy-button', 'explain-button', 'subscription-status', 'chat-list', 'new-chat-button'
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.elements[camelCaseId] = document.getElementById(id);
                });
                this.elements.pages = document.querySelectorAll('.page');
                this.elements.navButtons = document.querySelectorAll('.nav-button');
                this.elements.subNavButtons = document.querySelectorAll('.sub-nav-button');
            },

            /**
             * =============================================================
             * stateManager: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–∑–∞–≥—Ä—É–∑–∫–∞, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)
             * =============================================================
             */
            stateManager: {
                parent: this,
                load() {
                    const savedState = localStorage.getItem(this.parent.config.storageKey);
                    if (savedState) {
                        Object.assign(this.parent.state, JSON.parse(savedState));
                    } else {
                        this.setDefaultState();
                    }
                    this.checkDateBasedState();
                    this.save();
                },
                save() {
                    localStorage.setItem(this.parent.config.storageKey, JSON.stringify(this.parent.state));
                },
                setDefaultState() {
                    const initialChatId = `chat-${Date.now()}`;
                    this.parent.state.activeChatId = initialChatId;
                    this.parent.state.chats = [{ 
                        id: initialChatId, 
                        title: '–ù–æ–≤—ã–π —á–∞—Ç', 
                        createdAt: new Date().toISOString(), 
                        messages: [{ sender: 'ai', text: '–ü—Ä–∏–≤–µ—Ç! üëã –û–ø–∏—à–∏, –∫–∞–∫–æ–µ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç—ã —Ö–æ—á–µ—à—å —Å–æ–∑–¥–∞—Ç—å.' }], 
                        generatedCode: '' 
                    }];
                },
                checkDateBasedState() {
                    const todayStart = new Date().setHours(0, 0, 0, 0);
                    if (this.parent.state.dailyGenerations.lastReset < todayStart) {
                        this.parent.state.dailyGenerations = { count: 0, lastReset: todayStart };
                    }
                    if (this.parent.state.subscription.isActive && new Date(this.parent.state.subscription.endDate) < new Date()) {
                        this.parent.state.subscription = { isActive: false, endDate: null };
                    }
                },
                getActiveChat() {
                    return this.parent.state.chats.find(chat => chat.id === this.parent.state.activeChatId);
                }
            },

            /**
             * =============================================================
             * ui: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
             * =============================================================
             */
            ui: {
                parent: this,
                renderAll() {
                    this.renderActiveChat();
                    this.renderProfilePage();
                },
                renderActiveChat() {
                    const chat = this.parent.stateManager.getActiveChat();
                    if (!chat) return;
                    
                    this.parent.elements.chatHistory.innerHTML = '';
                    chat.messages.forEach(msg => this.addMessageToChat(msg.text, msg.sender));
                    
                    this.parent.elements.codeOutput.textContent = chat.generatedCode || "// –ö–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏";
                    this.parent.elements.previewIframe.srcdoc = chat.generatedCode;
                },
                renderProfilePage() {
                    this.renderSubscriptionStatus();
                    this.renderChatList();
                },
                renderSubscriptionStatus() {
                    const { subscription, dailyGenerations } = this.parent.state;
                    const { maxFreeGenerations } = this.parent.config;
                    const el = this.parent.elements.subscriptionStatus;

                    if (subscription.isActive) {
                        el.innerHTML = `
                            <p class="text-sm text-green-500 font-semibold">PRO –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</p>
                            <p class="text-lg font-bold">–ù–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</p>
                            <p class="text-xs opacity-70 mt-1">–ò—Å—Ç–µ–∫–∞–µ—Ç: ${new Date(subscription.endDate).toLocaleDateString()}</p>`;
                    } else {
                        el.innerHTML = `
                            <p class="text-sm">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π —Å–µ–≥–æ–¥–Ω—è:</p>
                            <p class="text-2xl font-bold">${maxFreeGenerations - dailyGenerations.count} / ${maxFreeGenerations}</p>
                            <button id="subscribe-button" class="w-full mt-4 bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg btn-transition">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –∑–∞ 999 Stars</button>`;
                        document.getElementById('subscribe-button').addEventListener('click', () => this.parent.paymentManager.initiateSubscription());
                    }
                },
                renderChatList() {
                    const { chats, activeChatId } = this.parent.state;
                    const el = this.parent.elements.chatList;
                    el.innerHTML = '';
                    
                    chats.slice().reverse().forEach(chat => {
                        const chatItem = document.createElement('div');
                        const isActive = chat.id === activeChatId;
                        chatItem.className = `p-3 rounded-lg cursor-pointer ${isActive ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)]' : 'bg-[var(--tg-secondary-bg)]'}`;
                        chatItem.innerHTML = `<h4 class="font-semibold truncate">${chat.title}</h4><p class="text-xs opacity-70">${new Date(chat.createdAt).toLocaleString()}</p>`;
                        chatItem.addEventListener('click', () => {
                            this.parent.state.activeChatId = chat.id;
                            this.parent.stateManager.save();
                            this.renderAll();
                            this.navigateToPage('chat-page');
                        });
                        el.appendChild(chatItem);
                    });
                },
                addMessageToChat(text, sender, isTyping = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-bubble ${sender}-bubble flex items-center`;
                    
                    if (isTyping) {
                        messageDiv.innerHTML = `<span class="loader mr-2"></span><span>${text}</span>`;
                        messageDiv.id = 'typing-indicator';
                    } else {
                        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç HTML-–∏–Ω—ä–µ–∫—Ü–∏–π
                        const textNode = document.createTextNode(text);
                        messageDiv.appendChild(textNode);
                    }
                    
                    this.parent.elements.chatHistory.appendChild(messageDiv);
                    this.parent.elements.chatHistory.scrollTop = this.parent.elements.chatHistory.scrollHeight;
                    return messageDiv;
                },
                navigateToPage(pageId) {
                    this.parent.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                    this.parent.elements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
                },
                toggleCodePreview(view) {
                    this.parent.elements.subNavButtons.forEach(b => b.classList.toggle('active', b.dataset.view === view));
                    this.parent.elements.codeView.classList.toggle('hidden', view !== 'code');
                    this.parent.elements.previewView.classList.toggle('hidden', view !== 'preview');
                },
                toggleGenerationButton(disabled) {
                    this.parent.state.isGenerating = disabled;
                    this.parent.elements.generateButton.disabled = disabled;
                    this.parent.elements.generateButton.style.opacity = disabled ? '0.7' : '1';
                    this.parent.elements.generateButton.style.cursor = disabled ? 'not-allowed' : 'pointer';
                },
                showPopup(options) {
                    this.parent.tg.showPopup(options);
                }
            },

            /**
             * =============================================================
             * eventManager: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
             * =============================================================
             */
            eventManager: {
                parent: this,
                addEventListeners() {
                    // –ù–∞–≤–∏–≥–∞—Ü–∏—è
                    this.parent.elements.navButtons.forEach(button => button.addEventListener('click', () => this.parent.ui.navigateToPage(button.dataset.page)));
                    this.parent.elements.subNavButtons.forEach(button => button.addEventListener('click', () => this.parent.ui.toggleCodePreview(button.dataset.view)));

                    // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
                    this.parent.elements.generateButton.addEventListener('click', () => this.parent.generationManager.handleGeneration());
                    this.parent.elements.promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.parent.generationManager.handleGeneration(); });
                    this.parent.elements.newChatButton.addEventListener('click', () => this.parent.chatManager.createNewChat());
                    this.parent.elements.copyButton.addEventListener('click', () => this.parent.chatManager.copyCode());
                    this.parent.elements.explainButton.addEventListener('click', () => this.parent.generationManager.explainCode());
                }
            },

            /**
             * =============================================================
             * chatManager: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–∞–º–∏ –∏ –∫–æ–¥–æ–º
             * =============================================================
             */
            chatManager: {
                parent: this,
                createNewChat() {
                    const newId = `chat-${Date.now()}`;
                    this.parent.state.chats.push({ 
                        id: newId, 
                        title: '–ù–æ–≤—ã–π —á–∞—Ç', 
                        createdAt: new Date().toISOString(), 
                        messages: [{ sender: 'ai', text: '–ù–æ–≤—ã–π —á–∞—Ç —Å–æ–∑–¥–∞–Ω. –ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?' }], 
                        generatedCode: '' 
                    });
                    this.parent.state.activeChatId = newId;
                    this.parent.stateManager.save();
                    this.parent.ui.renderAll();
                    this.parent.ui.navigateToPage('chat-page');
                },
                copyCode() {
                    const code = this.parent.stateManager.getActiveChat().generatedCode;
                    if (!code) return;

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º document.execCommand –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –≤ iframe
                    const textarea = document.createElement('textarea');
                    textarea.value = code;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        this.parent.tg.HapticFeedback.notificationOccurred('success');
                        const originalText = this.parent.elements.copyButton.textContent;
                        this.parent.elements.copyButton.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                        setTimeout(() => { this.parent.elements.copyButton.textContent = originalText; }, 2000);
                    } catch (err) {
                        this.parent.tg.HapticFeedback.notificationOccurred('error');
                        this.parent.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥.' });
                    }
                    document.body.removeChild(textarea);
                }
            },
            
            /**
             * =============================================================
             * paymentManager: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π –∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏
             * =============================================================
             */
            paymentManager: {
                parent: this,
                initiateSubscription() {
                    const payload = `monthly_sub_user_${this.parent.tg.initDataUnsafe.user?.id}_${Date.now()}`;
                    
                    this.parent.tg.showInvoice(payload, (status) => {
                         // –í–ê–ñ–ù–û: –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –ù–ï–û–ë–•–û–î–ò–ú–û –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `payload` –∏–ª–∏ –¥—Ä—É–≥–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.
                         // –í–∞—à —Å–µ—Ä–≤–µ—Ä –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∏—Ç—å webhook –æ—Ç Telegram (–∏–ª–∏ –≤–∞—à–µ–≥–æ –ø–ª–∞—Ç–µ–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞),
                         // —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø–ª–∞—Ç–µ–∂ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—à–µ–ª, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö.
                         // –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–∞–º–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É. –≠—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ.
                        if (status === 'paid') {
                            this.parent.tg.HapticFeedback.notificationOccurred('success');
                            this.activateSubscription();
                        } else if (status === 'failed' || status === 'cancelled') {
                            this.parent.tg.HapticFeedback.notificationOccurred('error');
                            this.parent.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: '–ü–ª–∞—Ç–µ–∂ –Ω–µ —É–¥–∞–ª—Å—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.' });
                        }
                    });
                },
                // --- –°–ò–ú–£–õ–Ø–¶–ò–Ø –î–õ–Ø –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–ò ---
                // –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞.
                activateSubscription() {
                    const now = new Date();
                    this.parent.state.subscription.isActive = true;
                    this.parent.state.subscription.endDate = new Date(now.setDate(now.getDate() + 30)).toISOString();
                    this.parent.stateManager.save();
                    this.parent.ui.renderSubscriptionStatus(); 
                }
            },

            /**
             * =============================================================
             * generationManager: –õ–æ–≥–∏–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å API
             * =============================================================
             */
            generationManager: {
                parent: this,
                async handleGeneration() {
                    if (this.parent.state.isGenerating) return;

                    if (!this.parent.state.subscription.isActive && this.parent.state.dailyGenerations.count >= this.parent.config.maxFreeGenerations) {
                        this.parent.ui.showPopup({
                            title: '–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω',
                            message: '–í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è. –û—Ñ–æ—Ä–º–∏—Ç–µ PRO –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞!',
                            buttons: [{ id: 'subscribe', type: 'default', text: '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è' }, { type: 'cancel' }]
                        }, (buttonId) => {
                            if (buttonId === 'subscribe') {
                                this.parent.ui.navigateToPage('profile-page');
                                this.parent.paymentManager.initiateSubscription();
                            }
                        });
                        return;
                    }

                    const prompt = this.parent.elements.promptInput.value.trim();
                    if (!prompt) return;

                    this.parent.ui.toggleGenerationButton(true);

                    const chat = this.parent.stateManager.getActiveChat();
                    chat.messages.push({ sender: 'user', text: prompt });
                    if (chat.title === '–ù–æ–≤—ã–π —á–∞—Ç') chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                    
                    this.parent.ui.addMessageToChat(prompt, 'user');
                    this.parent.elements.promptInput.value = '';
                    
                    const indicator = this.parent.ui.addMessageToChat('–î—É–º–∞—é...', 'ai', true);

                    try {
                        const systemPrompt = this.parent.api.createCodeGenerationPrompt(prompt, chat.generatedCode);
                        const newCode = await this.parent.api.callGemini(systemPrompt);
                        
                        // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–æ–ª—å–∫–æ –±–ª–æ–∫ –∫–æ–¥–∞, –µ—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ markdown
                        const codeMatch = newCode.match(/```html\n([\s\S]*?)\n```/);
                        const finalCode = codeMatch ? codeMatch[1] : newCode;

                        chat.generatedCode = finalCode;
                        chat.messages.push({ sender: 'ai', text: '–ì–æ—Ç–æ–≤–æ! –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω. –í—ã –º–æ–∂–µ—Ç–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –≤–∫–ª–∞–¥–∫–µ "–°–æ–∑–¥–∞–Ω–∏–µ".' });

                        if (!this.parent.state.subscription.isActive) {
                            this.parent.state.dailyGenerations.count++;
                        }
                        
                        this.parent.tg.HapticFeedback.notificationOccurred('success');

                    } catch (error) {
                        console.error('Generation Error:', error);
                        chat.messages.push({ sender: 'ai', text: `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ${error.message}. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.` });
                        this.parent.tg.HapticFeedback.notificationOccurred('error');
                    } finally {
                        indicator.remove();
                        this.parent.stateManager.save();
                        this.parent.ui.renderAll();
                        this.parent.ui.toggleGenerationButton(false);
                    }
                },
                async explainCode() {
                    const code = this.parent.stateManager.getActiveChat().generatedCode;
                    if (!code) {
                         this.parent.ui.showPopup({ title: '–ù–µ—Ç –∫–æ–¥–∞', message: '–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–¥, —á—Ç–æ–±—ã —è –º–æ–≥ –µ–≥–æ –æ–±—ä—è—Å–Ω–∏—Ç—å.' });
                         return;
                    }

                    this.parent.ui.showPopup({ title: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞', message: '–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ —É –ò–ò...' });
                    try {
                        const systemPrompt = this.parent.api.createExplanationPrompt(code);
                        const explanation = await this.parent.api.callGemini(systemPrompt);
                        this.parent.ui.showPopup({ title: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –∫–æ–¥–∞', message: explanation, buttons: [{ type: 'ok' }] });
                    } catch (error) {
                        this.parent.ui.showPopup({ title: '–û—à–∏–±–∫–∞', message: `–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ: ${error.message}`, buttons: [{ type: 'ok' }] });
                    }
                }
            },

            /**
             * =============================================================
             * api: –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å Gemini API
             * =============================================================
             */
            api: {
                parent: this,
                createCodeGenerationPrompt(userPrompt, existingCode) {
                    const baseInstruction = `–¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –±—ã—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–æ–º –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü. –¢—ã –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å –¢–û–õ–¨–ö–û HTML-–∫–æ–¥ –≤ –æ–¥–Ω–æ–º –±–ª–æ–∫–µ \`\`\`html ... \`\`\`.
–ë–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤, –æ–±—ä—è—Å–Ω–µ–Ω–∏–π –∏–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤–Ω–µ –∫–æ–¥–∞. –ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–º –∏ —Å–∞–º–æ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º (–≤–∫–ª—é—á–∞—è HTML, CSS –≤ <style> –∏ JS –≤ <script>). –ò—Å–ø–æ–ª—å–∑—É–π Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–∏–∑–∞—Ü–∏–∏.`;
                    
                    return existingCode
                        ? `${baseInstruction}\n–í–æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥:\n\n${existingCode}\n\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}".\n–ò–∑–º–µ–Ω–∏ –∫–æ–¥ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–ø—Ä–æ—Å–æ–º –∏ –≤–µ—Ä–Ω–∏ –Ω–æ–≤—É—é –ø–æ–ª–Ω—É—é –≤–µ—Ä—Å–∏—é.`
                        : `${baseInstruction}\n–ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: "${userPrompt}".\n–°–æ–∑–¥–∞–π –∫–æ–¥ —Å –Ω—É–ª—è.`;
                },
                createExplanationPrompt(code) {
                    return `–û–±—ä—è—Å–Ω–∏ —Å–ª–µ–¥—É—é—â–∏–π HTML-–∫–æ–¥ –ø–æ—à–∞–≥–æ–≤–æ, –ø—Ä–æ—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º —Ä—É—Å—Å–∫–∏–º —è–∑—ã–∫–æ–º –¥–ª—è –Ω–æ–≤–∏—á–∫–∞. –û–ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É (HTML), —Å—Ç–∏–ª–∏ (CSS) –∏ –ª–æ–≥–∏–∫—É (JavaScript). –í–æ—Ç –∫–æ–¥:\n\n${code}`;
                },
                async callGemini(prompt, retries = 3, delay = 1000) {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${this.parent.config.apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };

                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–æ —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞, –Ω–æ –Ω–µ rate limit
                            if (response.status < 500 && response.status !== 429) {
                                const errorData = await response.json();
                                throw new Error(errorData.error?.message || `HTTP –æ—à–∏–±–∫–∞: ${response.status}`);
                            }
                            // –î–ª—è –æ—à–∏–±–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞ –∏–ª–∏ rate limit, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
                            throw new Error(`Server error: ${response.status}`);
                        }

                        const data = await response.json();
                        if (!data.candidates || !data.candidates[0].content.parts[0].text) {
                           throw new Error('–ü–æ–ª—É—á–µ–Ω –Ω–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç API.');
                        }
                        return data.candidates[0].content.parts[0].text;

                    } catch (error) {
                        if (retries > 0) {
                            console.warn(`Retrying API call... (${retries} retries left). Error: ${error.message}`);
                            await new Promise(res => setTimeout(res, delay));
                            return this.callGemini(prompt, retries - 1, delay * 2); // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
                        } else {
                            throw error; // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–æ–≤–∞–ª–∏–ª–∏—Å—å
                        }
                    }
                }
            }
        };

        // --- –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ---
        App.init();
    });
    </script>
</body>
</html>
