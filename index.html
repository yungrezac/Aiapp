<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AI Web App Builder</title>
    
    <!-- Подключение Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Подключение Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Подключение Prism.js для подсветки синтаксиса -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    
    <!-- Подключение Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Стили приложения -->
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
            --tg-header-bg: var(--tg-theme-header-bg-color, #ffffff);
        }
        body {
            background-color: var(--tg-bg);
            color: var(--tg-text);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            overscroll-behavior: none; 
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .chat-bubble { max-width: 85%; padding: 10px 15px; border-radius: 20px; margin-bottom: 10px; word-wrap: break-word; line-height: 1.4; }
        .user-bubble { background-color: var(--tg-button); color: var(--tg-button-text); align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-bubble { background-color: var(--tg-secondary-bg); color: var(--tg-text); align-self: flex-start; border-bottom-left-radius: 5px; }
        .nav-button.active { color: var(--tg-button); }
        .sub-nav-button.active { border-bottom: 2px solid var(--tg-button); color: var(--tg-button); font-weight: 600; }
        .btn-transition { transition: background-color 0.2s, opacity 0.2s, transform 0.1s; }
        .btn-transition:active { transform: scale(0.95); }
        .loader {
            width: 18px;
            height: 18px;
            border: 2px solid var(--tg-text);
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre[class*="language-"] { background: #2d2d2d; margin: 0; border-radius: 0; }
        code[class*="language-"] { font-size: 14px; line-height: 1.5; }
        #history-modal-overlay, #payment-modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 40; }
        #history-modal-overlay.active, #payment-modal-overlay.active { opacity: 1; visibility: visible; }
        #history-modal-panel, #payment-modal-panel { position: fixed; left: 0; right: 0; bottom: 0; height: 75vh; background-color: var(--tg-bg); border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem; transform: translateY(100%); transition: transform 0.3s ease-in-out; z-index: 50; display: flex; flex-direction: column; padding: 1rem; box-shadow: 0 -10px 25px -5px rgba(0,0,0,0.1), 0 -8px 10px -6px rgba(0,0,0,0.1); }
        #history-modal-panel.active, #payment-modal-panel.active { transform: translateY(0); }
        
        #app-viewer-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--tg-bg);
            z-index: 110;
            transform: translateY(100%);
            transition: transform 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #app-viewer-page.active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="flex flex-col h-screen">

    <div id="global-loader" class="absolute inset-0 bg-[var(--tg-bg)] bg-opacity-80 flex flex-col items-center justify-center z-[120]">
        <div class="loader" style="width: 48px; height: 48px;"></div>
        <p id="loader-message" class="mt-4 text-lg font-semibold text-[var(--tg-text)]">Подключаемся...</p>
    </div>

    <main class="flex-grow overflow-hidden flex flex-col min-h-0">
        <!-- СТРАНИЦА 1: ЧАТ С ИИ -->
        <div id="chat-page" class="page active flex-col h-full">
            <div class="flex-shrink-0 flex justify-between items-center p-2 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button id="history-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="История чатов"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg></button>
                <h1 id="chat-title" class="font-bold text-lg truncate px-2">Чат</h1>
                <button id="page-new-chat-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition" aria-label="Новый чат"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg></button>
            </div>
            <div id="chat-history" class="flex-grow p-4 flex flex-col space-y-2 overflow-y-auto"></div>
            <div class="flex-shrink-0 flex items-center space-x-2 p-2 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)]">
                <input id="prompt-input" type="text" placeholder="Ваш запрос..." class="w-full p-3 rounded-full focus:outline-none bg-[var(--tg-secondary-bg)] text-[var(--tg-text)] placeholder-[var(--tg-hint)] transition-transform">
                <button id="generate-button" class="p-3 rounded-full transition-opacity btn-transition flex-shrink-0 bg-[var(--tg-button)] text-[var(--tg-button-text)]" aria-label="Сгенерировать"><svg class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24" stroke="none"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>

        <!-- СТРАНИЦA 2: СОЗДАНИЕ (КОД + ПРЕВЬЮ) -->
        <div id="creation-page" class="page flex-col h-full">
            <div class="flex-shrink-0 flex border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <button data-view="code" class="sub-nav-button active w-1/2 p-4 text-center text-[var(--tg-hint)]">Код</button>
                <button data-view="preview" class="sub-nav-button w-1/2 p-4 text-center text-[var(--tg-hint)]">Превью</button>
            </div>
            <div id="code-view" class="flex-grow flex flex-col overflow-hidden">
                <div class="p-2 flex-shrink-0 flex justify-end items-center space-x-2 bg-[var(--tg-bg)] border-b border-[var(--tg-secondary-bg)]">
                    <button id="copy-button" class="bg-[var(--tg-button)] text-[var(--tg-button-text)] px-4 py-2 rounded-lg text-sm btn-transition">Копировать</button>
                </div>
                <div class="flex-grow overflow-auto bg-[#2d2d2d]"><pre><code id="code-output" class="language-html text-sm p-4 block whitespace-pre-wrap font-mono"></code></pre></div>
            </div>
            <div id="preview-view" class="flex-grow hidden bg-white relative">
                <iframe id="preview-iframe" class="w-full h-full border-0"></iframe>
                <button id="refresh-preview-button" class="absolute top-4 right-4 p-2 rounded-full bg-[var(--tg-button)] text-[var(--tg-button-text)] shadow-lg btn-transition" aria-label="Обновить превью"><svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 4l5 5M20 20l-5-5" /></svg></button>
            </div>
        </div>

        <!-- СТРАНИЦА 3: МОЁ -->
        <div id="my-stuff-page" class="page flex-col h-full">
             <div class="flex-shrink-0 p-3 border-b border-[var(--tg-secondary-bg)] bg-[var(--tg-bg)]">
                <h2 class="text-xl font-bold text-center">Мои приложения</h2>
            </div>
            <div id="my-apps-list" class="flex-grow overflow-y-auto p-4 space-y-3">
                <!-- Список будет рендериться здесь -->
            </div>
        </div>

        <!-- СТРАНИЦА 4: ПРОФИЛЬ -->
        <div id="profile-page" class="page p-4 overflow-y-auto flex-col h-full space-y-4">
            <div id="user-profile-card" class="flex items-center space-x-4 p-4 bg-[var(--tg-secondary-bg)] rounded-xl">
                <img id="user-avatar" src="https://placehold.co/80x80/EFEFEF/333333?text=User" class="w-20 h-20 rounded-full object-cover bg-gray-300">
                <div class="flex-grow">
                    <h2 id="user-fullname" class="text-xl font-bold">Имя пользователя</h2>
                    <p id="user-username" class="text-sm text-[var(--tg-hint)]">@username</p>
                </div>
            </div>
            <div id="subscription-status" class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl"></div>
            <div class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl space-y-3">
                <h3 class="text-lg font-bold">Пригласите друзей</h3>
                <p class="text-sm text-[var(--tg-hint)]">Пригласите друга и получите бонус! Вы получите **1 генерацию** за каждого нового пользователя и **10 генераций**, если он оформит подписку. Ваш друг получит **1 бонусную генерацию** сразу после перехода по ссылке.</p>
                <div class="flex items-center space-x-2">
                    <input id="referral-link-input" type="text" readonly class="w-full p-2 rounded-lg focus:outline-none bg-[var(--tg-bg)] text-sm">
                    <button id="copy-referral-link-button" class="p-2 rounded-lg bg-[var(--tg-button)] text-[var(--tg-button-text)] btn-transition flex-shrink-0"><svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg></button>
                </div>
                <button id="invite-friend-button" class="w-full mt-2 bg-[var(--tg-button)] text-[var(--tg-button-text)] font-bold py-2 px-4 rounded-lg btn-transition">Пригласить</button>
            </div>
            <div id="referral-list-section" class="bg-[var(--tg-secondary-bg)] p-4 rounded-xl space-y-3">
                <div class="flex items-center justify-between">
                     <h3 class="text-lg font-bold">Приглашенные вами</h3>
                     <span id="referral-count" class="text-sm font-bold bg-[var(--tg-button)] text-[var(--tg-button-text)] px-2 py-1 rounded-full">0</span>
                </div>
                <div id="referral-list" class="space-y-2 max-h-150 overflow-y-auto">
                    <p class="text-sm text-[var(--tg-hint)]">У вас пока нет рефералов.</p>
                </div>
            </div>
        </div>
    </main>

    <footer id="main-footer" class="flex-shrink-0 h-20 bg-[var(--tg-bg)] border-t border-[var(--tg-secondary-bg)] flex justify-around items-center transition-transform">
        <button data-page="chat-page" class="nav-button active flex flex-col items-center justify-center p-2 h-full" aria-label="Чат"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg><span class="text-xs">Чат</span></button>
        <button data-page="creation-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="Создание"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" /></svg><span class="text-xs">Создание</span></button>
        <button data-page="my-stuff-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="Моё"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg><span class="text-xs">Моё</span></button>
        <button data-page="profile-page" class="nav-button flex flex-col items-center justify-center p-2 h-full" aria-label="Профиль"><svg class="h-6 w-6 mb-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg><span class="text-xs">Профиль</span></button>
    </footer>

    <div id="history-modal-overlay"></div>
    <div id="history-modal-panel">
        <h3 class="text-xl font-bold mb-4 flex-shrink-0">История чатов</h3>
        <div id="chat-list" class="space-y-2 overflow-y-auto flex-grow"></div>
    </div>
    
    <div id="payment-modal-overlay"></div>
    <div id="payment-modal-panel" style="height: 70vh; padding: 0;">
        <iframe id="payment-iframe" class="w-full h-full border-0 rounded-t-2xl"></iframe>
    </div>

    <div id="app-viewer-page">
        <div id="app-viewer-header" class="flex-shrink-0 p-2 flex justify-between items-center bg-[var(--tg-header-bg)] border-b border-[var(--tg-secondary-bg)]">
            <h3 id="app-viewer-title" class="font-bold text-lg truncate px-2">Просмотр</h3>
            <button id="app-viewer-close-button" class="p-2 rounded-full hover:bg-[var(--tg-secondary-bg)] btn-transition">
                <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
        </div>
        <iframe id="app-viewer-iframe" class="w-full h-full border-0 flex-grow"></iframe>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            config: {
                apiKey: 'AIzaSyBuXjShdZFvr76OKsl7FaL789Dxl3i6bgc', // Вставьте ваш ключ от Gemini
                botUsername: 'yr_dev_bot', // Вставьте username вашего бота
                appName: 'aiyrf', // Вставьте имя вашего Mini App
                supabaseUrl: 'https://mhwzgpexajfqqtlgivfc.supabase.co',
                supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1od3pncGV4YWpmcXF0bGdpdmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMzU1ODAsImV4cCI6MjA2OTYxMTU4MH0.jmmkJ2gsfRMVOo3KVTHYS2u8IIoBUH7D5ZemZowwpzE',
                maxFreeGenerations: 5,
            },
            state: {
                userProfile: null,
                chats: [],
                activeChat: null,
                isGenerating: false,
            },
            elements: {},
            tg: window.Telegram.WebApp,
            supabase: null,

            async init() {
                try {
                    this.tg.ready();
                    this.tg.expand();
                    this.cacheDOMElements();
                    this.eventManager.addEventListeners();

                    this.supabase = supabase.createClient(this.config.supabaseUrl, this.config.supabaseAnonKey);
                    
                    if (!this.tg.initDataUnsafe.user?.id) {
                        throw new Error("Не удалось получить данные пользователя Telegram.");
                    }

                    this.elements.loaderMessage.textContent = 'Загрузка данных...';
                    await this.dataManager.loadInitialDataAndChats();
                    
                    const startParam = this.tg.initDataUnsafe.start_param;
                    if (startParam && startParam.startsWith('view_')) {
                        const chatId = startParam.replace('view_', '');
                        await this.viewer.loadAndShowSharedApp(chatId);
                    } else {
                        await this.referralManager.processNewReferral(startParam);
                        await this.ui.showWelcomePopupIfNeeded();
                    }

                    this.ui.renderAll();
                    this.elements.globalLoader.style.display = 'none';
                } catch (error) {
                    console.error("Initialization failed:", error);
                    this.elements.loaderMessage.textContent = `Ошибка: ${error.message}`;
                    this.tg.HapticFeedback.notificationOccurred('error');
                    this.ui.showPopup({ title: 'Критическая ошибка', message: 'Не удалось загрузить приложение. ' + error.message });
                }
            },

            cacheDOMElements() {
                const ids = [
                    'chat-page', 'creation-page', 'my-stuff-page', 'profile-page', 'chat-history', 'prompt-input', 
                    'generate-button', 'code-view', 'preview-view', 'code-output', 'preview-iframe', 
                    'copy-button', 'subscription-status', 'chat-list', 'chat-title',
                    'history-button', 'page-new-chat-button', 'refresh-preview-button',
                    'history-modal-overlay', 'history-modal-panel',
                    'my-apps-list', 'main-footer',
                    'user-profile-card', 'user-avatar', 'user-fullname', 'user-username',
                    'copy-referral-link-button', 'referral-link-input', 'invite-friend-button',
                    'referral-list-section', 'referral-list', 'referral-count',
                    'global-loader', 'loader-message',
                    'payment-modal-overlay', 'payment-modal-panel', 'payment-iframe',
                    'app-viewer-page', 'app-viewer-header', 'app-viewer-title', 'app-viewer-close-button', 'app-viewer-iframe'
                ];
                ids.forEach(id => {
                    const camelCaseId = id.replace(/-(\w)/g, (_, c) => c.toUpperCase());
                    this.elements[camelCaseId] = document.getElementById(id);
                });
                this.elements.pages = document.querySelectorAll('main > .page');
                this.elements.navButtons = document.querySelectorAll('.nav-button');
                this.elements.subNavButtons = document.querySelectorAll('#creation-page .sub-nav-button');
            },
            
            dataManager: {
                async loadInitialDataAndChats() {
                    const user = App.tg.initDataUnsafe.user;
                    const userId = user.id;

                    let { data: profile, error: profileError } = await App.supabase
                        .from('profiles')
                        .select('*')
                        .eq('id', userId)
                        .single();

                    if (profileError && profileError.code !== 'PGRST116') {
                        throw new Error(`Failed to load profile: ${profileError.message}`);
                    }
                    
                    if (!profile) {
                        profile = await this.createNewUserProfile(user);
                    }

                    App.state.userProfile = profile;

                    const { data: chats, error: chatsError } = await App.supabase
                        .from('chats')
                        .select('id, title, created_at, generated_code')
                        .eq('user_id', userId)
                        .order('created_at', { ascending: false });

                    if (chatsError) throw new Error(`Failed to load chats: ${chatsError.message}`);
                    App.state.chats = chats || [];

                    if (App.state.chats.length === 0) {
                        const newChat = await this.createNewChatInDB(userId);
                        App.state.chats.unshift(newChat);
                    }

                    const activeChatId = App.state.chats[0].id;
                    await this.loadActiveChat(activeChatId);
                },

                async createNewUserProfile(user) {
                    const { data, error } = await App.supabase
                        .from('profiles')
                        .insert({
                            id: user.id,
                            username: user.username,
                            full_name: `${user.first_name || ''} ${user.last_name || ''}`.trim(),
                            photo_url: user.photo_url,
                            updated_at: new Date().toISOString(),
                            bonus_generations: App.tg.initDataUnsafe.start_param ? 1 : 0,
                            has_seen_welcome_popup: false
                        })
                        .select()
                        .single();

                    if (error) throw new Error(`Failed to create profile: ${error.message}`);
                    return data;
                },

                async loadActiveChat(chatId) {
                    const chat = App.state.chats.find(c => c.id === chatId);
                    if (chat) {
                        App.state.activeChat = chat;
                    } else {
                        console.error(`Chat with id ${chatId} not found in local state.`);
                    }
                },

                async createNewChatInDB(userId) {
                    const { data, error } = await App.supabase
                        .from('chats')
                        .insert({
                            user_id: userId,
                            title: 'Новый чат',
                            messages: [{ sender: 'ai', text: 'Привет! 👋 Опиши, какое веб-приложение ты хочешь создать.' }],
                            generated_code: ''
                        })
                        .select('id, title, created_at, generated_code')
                        .single();
                    
                    if (error) {
                         console.error('Failed to create new chat:', error);
                         throw error;
                    }
                    return data;
                },
                
                async saveActiveChat() {
                    if (!App.state.activeChat) return;
                    const { id, title, messages, generated_code } = App.state.activeChat;
                    const { error } = await App.supabase
                        .from('chats')
                        .update({ title, messages, generated_code })
                        .eq('id', id);
                    
                    if (error) console.error('Failed to save chat:', error);
                },

                async updateUserProfile(updates) {
                    const { data, error } = await App.supabase
                        .from('profiles')
                        .update(updates)
                        .eq('id', App.state.userProfile.id)
                        .select()
                        .single();

                    if (error) {
                        console.error('Failed to update profile:', error);
                        return;
                    }
                    App.state.userProfile = data;
                    App.ui.renderProfilePage();
                }
            },
            
            ui: {
                renderAll() {
                    this.renderActiveChat();
                    this.renderProfilePage();
                    this.renderChatList();
                },
                renderActiveChat() {
                    const chat = App.state.activeChat;
                    if (!chat) return;
                    
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.chatHistory.innerHTML = '';
                    chat.messages.forEach(msg => this.addMessageToChat(msg.text, msg.sender));
                    
                    App.elements.codeOutput.textContent = chat.generated_code || "// Код появится здесь после генерации";
                    Prism.highlightElement(App.elements.codeOutput);

                    App.elements.previewIframe.srcdoc = chat.generated_code;
                },
                renderProfilePage() {
                    this.renderUserProfile();
                    this.renderSubscriptionStatus();
                    this.renderReferralSection();
                    this.renderReferralList();
                },
                renderUserProfile() {
                    const user = App.tg.initDataUnsafe.user;
                    if (!user) return;

                    App.elements.userAvatar.src = user.photo_url || `https://placehold.co/80x80/EFEFEF/333333?text=${user.first_name.charAt(0)}`;
                    App.elements.userFullname.textContent = `${user.first_name || ''} ${user.last_name || ''}`.trim() || 'Anonymous';
                    App.elements.userUsername.textContent = user.username ? `@${user.username}` : 'No username';
                },
                renderSubscriptionStatus() {
                    const profile = App.state.userProfile;
                    if (!profile) return;

                    const { subscription_is_active, subscription_end_date, daily_generations_count, bonus_generations } = profile;
                    const { maxFreeGenerations } = App.config;
                    const el = App.elements.subscriptionStatus;

                    if (subscription_is_active && new Date(subscription_end_date) > new Date()) {
                        el.innerHTML = `<p class="text-sm text-green-500 font-semibold">PRO Подписка активна</p><p class="text-lg font-bold">Неограниченно генераций</p><p class="text-xs opacity-70 mt-1">Истекает: ${new Date(subscription_end_date).toLocaleDateString()}</p>`;
                    } else {
                        const remaining = maxFreeGenerations - daily_generations_count;
                        el.innerHTML = `
                            <p class="text-sm">Бесплатных генераций сегодня:</p>
                            <p class="text-2xl font-bold">${remaining < 0 ? 0 : remaining} / ${maxFreeGenerations}</p>
                            ${bonus_generations > 0 ? `<p class="text-sm text-blue-500 mt-1">Бонусных генераций: ${bonus_generations}</p>` : ''}
                            <button id="subscribe-button" class="w-full mt-4 bg-yellow-400 text-black font-bold py-2 px-4 rounded-lg btn-transition">Подписаться за 999 ₽</button>`;
                        document.getElementById('subscribe-button')?.addEventListener('click', () => App.paymentManager.initiateSubscription());
                    }
                },
                async renderReferralList() {
                    const userId = App.state.userProfile?.id;
                    if (!userId) return;

                    const { data: referrals, error: referralsError } = await App.supabase.from('referrals').select('referred_id').eq('referrer_id', userId);
                    if (referralsError) return;

                    const listEl = App.elements.referralList;
                    const countEl = App.elements.referralCount;
                    listEl.innerHTML = '';
                    countEl.textContent = referrals.length;

                    if (referrals.length === 0) {
                        listEl.innerHTML = `<p class="text-sm text-[var(--tg-hint)]">У вас пока нет рефералов.</p>`;
                        return;
                    }

                    const referredIds = referrals.map(r => r.referred_id);
                    const { data: profiles, error: profilesError } = await App.supabase.from('profiles').select('id, full_name, username, photo_url').in('id', referredIds);
                    if (profilesError) return;

                    const profilesMap = new Map(profiles?.map(p => [p.id, p]));
                    referrals.forEach(ref => {
                        const profile = profilesMap.get(ref.referred_id);
                        const referredId = ref.referred_id;
                        const item = document.createElement('div');
                        item.className = 'flex items-center space-x-3 p-2 rounded-lg';
                        const name = profile?.username ? `@${profile.username}` : (profile?.full_name || `Пользователь #${referredId}`);
                        const subtext = profile?.username ? (profile.full_name || `ID: ${referredId}`) : `ID: ${referredId}`;
                        const avatar = profile?.photo_url || `https://placehold.co/40x40/EFEFEF/333333?text=${(name || 'ID').charAt(0).toUpperCase()}`;
                        item.innerHTML = `<img src="${avatar}" class="w-10 h-10 rounded-full bg-gray-300"><div class="flex-grow"><p class="font-semibold">${name}</p><p class="text-xs text-[var(--tg-hint)]">${subtext}</p></div>`;
                        listEl.appendChild(item);
                    });
                },
                renderReferralSection() {
                    const link = App.referralManager.generateReferralLink();
                    App.elements.referralLinkInput.value = link;
                },
                renderChatList() {
                    const { chats } = App.state;
                    const activeChatId = App.state.activeChat?.id;
                    const el = App.elements.chatList;
                    el.innerHTML = '';
                    
                    chats.forEach(chat => {
                        const chatItem = document.createElement('div');
                        const isActive = chat.id === activeChatId;
                        chatItem.className = `p-3 rounded-lg cursor-pointer ${isActive ? 'bg-[var(--tg-button)] text-[var(--tg-button-text)]' : 'bg-[var(--tg-secondary-bg)]'}`;
                        chatItem.innerHTML = `<h4 class="font-semibold truncate">${chat.title}</h4><p class="text-xs opacity-70">${new Date(chat.created_at).toLocaleString()}</p>`;
                        chatItem.addEventListener('click', async () => {
                            if (chat.id === App.state.activeChat?.id) {
                                this.closeHistoryModal();
                                return;
                            }
                            await App.dataManager.loadActiveChat(chat.id);
                            this.renderAll();
                            this.closeHistoryModal();
                        });
                        el.appendChild(chatItem);
                    });
                },
                async renderMyAppsList() {
                    const listEl = App.elements.myAppsList;
                    listEl.innerHTML = `<div class="flex justify-center items-center h-full"><div class="loader"></div></div>`;

                    const myApps = App.state.chats.filter(chat => chat.generated_code && chat.generated_code.trim() !== '');
                    
                    listEl.innerHTML = '';

                    if (myApps.length === 0) {
                        listEl.innerHTML = `
                            <div class="text-center py-10 px-4">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c.252 0 .487.02.718.057m-2.258 4.087a2.25 2.25 0 00-1.132.659L4.25 12.5M9.75 3.104a2.25 2.25 0 012.25 2.25v4.136m-2.25-4.136L7.5 12.5m3-9.396c.68.028 1.34.08 1.98.162m-1.98-.162L12 6.375m0-3.271a2.25 2.25 0 012.25 2.25v4.136m0 0L12 12.5m0 0l-2.25 2.25M12 12.5l2.25 2.25M12 12.5l2.25-2.25M12 12.5l-2.25-2.25" /></svg>
                                <h3 class="mt-2 text-sm font-medium text-[var(--tg-text)]">Нет созданных приложений</h3>
                                <p class="mt-1 text-sm text-[var(--tg-hint)]">Создайте что-нибудь в чате, и оно появится здесь.</p>
                            </div>`;
                        return;
                    }

                    myApps.forEach(chat => {
                        const item = document.createElement('div');
                        item.className = 'bg-[var(--tg-secondary-bg)] p-4 rounded-xl';
                        item.innerHTML = `
                            <h4 class="font-bold truncate">${chat.title}</h4>
                            <p class="text-xs text-[var(--tg-hint)] mt-1">Создано: ${new Date(chat.created_at).toLocaleDateString()}</p>
                            <div class="flex space-x-2 mt-3">
                                <button data-chat-id="${chat.id}" class="view-my-app-btn w-1/2 bg-[var(--tg-button)] text-[var(--tg-button-text)] font-bold py-2 px-4 rounded-lg btn-transition">Посмотреть</button>
                                <button data-chat-id="${chat.id}" class="share-my-app-btn w-1/2 bg-transparent border border-[var(--tg-button)] text-[var(--tg-button)] font-bold py-2 px-4 rounded-lg btn-transition">Поделиться</button>
                            </div>
                        `;
                        listEl.appendChild(item);
                    });

                    document.querySelectorAll('.view-my-app-btn').forEach(btn => btn.addEventListener('click', (e) => App.viewer.viewApp(e.currentTarget.dataset.chatId)));
                    document.querySelectorAll('.share-my-app-btn').forEach(btn => btn.addEventListener('click', (e) => App.sharing.shareLink(e.currentTarget.dataset.chatId)));
                },
                addMessageToChat(text, sender, isTyping = false) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chat-bubble ${sender}-bubble flex items-center`;
                    if (isTyping) {
                        messageDiv.innerHTML = `<span class="loader mr-2"></span><span>${text}</span>`;
                        messageDiv.id = 'typing-indicator';
                    } else {
                        messageDiv.textContent = text;
                    }
                    App.elements.chatHistory.appendChild(messageDiv);
                    App.elements.chatHistory.scrollTop = App.elements.chatHistory.scrollHeight;
                },
                navigateToPage(pageId) {
                    App.elements.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                    App.elements.navButtons.forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
                    if (pageId === 'my-stuff-page') {
                        this.renderMyAppsList();
                    }
                },
                toggleGenerationButton(disabled) {
                    App.state.isGenerating = disabled;
                    App.elements.generateButton.disabled = disabled;
                    App.elements.generateButton.style.opacity = disabled ? '0.7' : '1';
                },
                showPopup(options, callback) {
                    App.tg.showPopup(options, callback);
                },
                async showWelcomePopupIfNeeded() {
                    if (App.state.userProfile && !App.state.userProfile.has_seen_welcome_popup) {
                        return new Promise(resolve => {
                            App.ui.showPopup({
                                title: 'Добро пожаловать!',
                                message: 'Привет я fullstack разработчик YR, а это мой ИИ для создания HTML приложений, блоков, компонетов и тд. Кстати ты можешь его купить за 150 т.р',
                                buttons: [{ id: 'buy', type: 'default', text: 'Купить' }, { id: 'chat', type: 'default', text: 'Чат' }, { type: 'close' }]
                            }, async (buttonId) => {
                                if (buttonId === 'buy') App.tg.openTelegramLink('https://t.me/yung_rezac');
                                if (buttonId === 'chat') App.tg.openTelegramLink('https://t.me/+2_hEfzuqRIpjYTEy');
                                await App.dataManager.updateUserProfile({ has_seen_welcome_popup: true });
                                App.state.userProfile.has_seen_welcome_popup = true;
                                resolve(); 
                            });
                        });
                    }
                    return Promise.resolve();
                },
                openHistoryModal() {
                    this.renderChatList();
                    App.elements.historyModalOverlay.classList.add('active');
                    App.elements.historyModalPanel.classList.add('active');
                },
                closeHistoryModal() {
                    App.elements.historyModalOverlay.classList.remove('active');
                    App.elements.historyModalPanel.classList.remove('active');
                },
            },

            eventManager: {
                addEventListeners() {
                    App.elements.navButtons.forEach(button => button.addEventListener('click', () => App.ui.navigateToPage(button.dataset.page)));
                    App.elements.generateButton.addEventListener('click', () => App.generationManager.handleGeneration());
                    App.elements.promptInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') App.generationManager.handleGeneration(); });
                    App.elements.copyButton.addEventListener('click', () => App.chatManager.copyCode());
                    App.elements.historyButton.addEventListener('click', () => App.ui.openHistoryModal());
                    App.elements.historyModalOverlay.addEventListener('click', () => App.ui.closeHistoryModal());
                    App.elements.pageNewChatButton.addEventListener('click', () => App.chatManager.createNewChat());
                    App.elements.appViewerCloseButton.addEventListener('click', () => App.viewer.close());
                }
            },

            viewer: {
                show(code, title) {
                    if (code === null || typeof code === 'undefined') return;
                    App.elements.appViewerTitle.textContent = title || 'Просмотр';
                    App.elements.appViewerIframe.srcdoc = code;
                    App.elements.appViewerPage.classList.add('active');
                    App.elements.mainFooter.style.transform = 'translateY(100%)';
                    App.tg.BackButton.show();
                    App.tg.onEvent('backButtonClicked', this.close);
                },
                close() {
                    App.elements.appViewerPage.classList.remove('active');
                    App.elements.appViewerIframe.srcdoc = '';
                    App.elements.mainFooter.style.transform = 'translateY(0)';
                    App.tg.BackButton.hide();
                    App.tg.offEvent('backButtonClicked', this.close);
                },
                viewApp(chatId) {
                    const chat = App.state.chats.find(c => c.id.toString() === chatId);
                    if (chat) {
                        this.show(chat.generated_code, chat.title);
                    } else {
                        App.ui.showPopup({title: 'Ошибка', message: 'Не удалось найти это приложение.'});
                    }
                },
                async loadAndShowSharedApp(chatId) {
                    App.elements.loaderMessage.textContent = 'Загрузка приложения...';
                    App.elements.globalLoader.style.display = 'flex';
                    try {
                        const { data, error } = await App.api.invokeFunction('get-shared-app', { chatId });
                        if (error) throw new Error(error.message);
                        if (!data) throw new Error('Приложение не найдено или было удалено.');
                        
                        // Показываем просмотрщик до того, как скроем глобальный лоадер
                        this.show(data.code, data.title);
                    } catch (error) {
                        console.error("Failed to load shared app:", error);
                        App.ui.showPopup({title: 'Ошибка загрузки', message: error.message});
                    } finally {
                        // Глобальный лоадер скрывается в любом случае после попытки
                        App.elements.globalLoader.style.display = 'none';
                    }
                }
            },

            sharing: {
                shareLink(chatId) {
                    const shareUrl = `https://t.me/${App.config.botUsername}/${App.config.appName}?startapp=view_${chatId}`;
                    const chat = App.state.chats.find(c => c.id.toString() === chatId);
                    const text = `Оцени приложение "${chat?.title || 'Без названия'}", которое я создал в YR://DEV!`;
                    
                    App.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(text)}`);
                }
            },
            
            chatManager: {
                async createNewChat() {
                    const newChat = await App.dataManager.createNewChatInDB(App.state.userProfile.id);
                    App.state.chats.unshift(newChat);
                    await App.dataManager.loadActiveChat(newChat.id);
                    App.ui.renderAll();
                    App.ui.closeHistoryModal();
                },
                copyCode() {
                    const code = App.state.activeChat?.generated_code;
                    if (!code) return;
                    navigator.clipboard.writeText(code).then(() => {
                        App.tg.HapticFeedback.notificationOccurred('success');
                        const originalText = App.elements.copyButton.textContent;
                        App.elements.copyButton.textContent = 'Скопировано!';
                        setTimeout(() => { App.elements.copyButton.textContent = originalText; }, 2000);
                    }).catch(() => {
                        App.tg.HapticFeedback.notificationOccurred('error');
                    });
                }
            },

            referralManager: {
                async processNewReferral(startParam) {
                    if (!startParam) return;
                    const referrerId = startParam;
                    const currentUser = App.state.userProfile;

                    if (referrerId && !currentUser.referrer_id && currentUser.id.toString() !== referrerId) {
                        try {
                            const { data: referrerProfile, error: referrerError } = await App.supabase.from('profiles').select('bonus_generations').eq('id', referrerId).single();
                            if (referrerError) throw new Error(`Could not find referrer: ${referrerError.message}`);
                            await App.supabase.from('profiles').update({ bonus_generations: (referrerProfile.bonus_generations || 0) + 1 }).eq('id', referrerId);
                            await App.supabase.from('profiles').update({ referrer_id: referrerId }).eq('id', currentUser.id);
                            await App.supabase.from('referrals').insert({ referrer_id: referrerId, referred_id: currentUser.id });
                            App.state.userProfile.referrer_id = referrerId;
                            App.ui.showPopup({ title: 'Бонус!', message: 'Вы перешли по приглашению и получили 1 бонусную генерацию! Ваш друг также получил бонус.' });
                        } catch (error) {
                            console.error("Failed to process referral:", error);
                        }
                    }
                },
                generateReferralLink() {
                    const userId = App.state.userProfile?.id;
                    if (!userId) return 'Не удалось сгенерировать ссылку.';
                    return `https://t.me/${App.config.botUsername}/${App.config.appName}?startapp=${userId}`;
                },
                shareReferralLink() {
                    const link = this.generateReferralLink();
                    const text = `Привет получи 1 генерацию веб приложения от меня в YR://DEV`;
                    App.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
                }
            },

            generationManager: {
                async handleGeneration() {
                    if (App.state.isGenerating) return;
                    const prompt = App.elements.promptInput.value.trim();
                    if (!prompt) return;
                    
                    App.ui.toggleGenerationButton(true);
                    
                    const chat = App.state.activeChat;
                    chat.messages.push({ sender: 'user', text: prompt });
                    if (chat.title === 'Новый чат') {
                        chat.title = prompt.substring(0, 30) + (prompt.length > 30 ? '...' : '');
                    }
                    
                    App.ui.addMessageToChat(prompt, 'user');
                    App.elements.chatTitle.textContent = chat.title;
                    App.elements.promptInput.value = '';
                    
                    const indicator = App.ui.addMessageToChat('Пишу код...', 'ai', true);

                    try {
                        const systemPrompt = App.api.createCodeGenerationPrompt(prompt, chat.generated_code);
                        const newCode = await App.api.callGemini(systemPrompt);
                        const codeMatch = newCode.match(/```(?:html|css|javascript|)\n([\s\S]*?)\n```/s);
                        const finalCode = codeMatch ? codeMatch[1] : newCode;

                        indicator.remove();
                        App.ui.navigateToPage('creation-page');
                        
                        chat.generated_code = finalCode;
                        App.state.activeChat.generated_code = finalCode; // Ensure local state is updated
                        
                        App.ui.renderActiveChat(); // Re-render to show new code
                        
                        const aiResponseText = 'Готово! Код обновлен.';
                        App.ui.addMessageToChat(aiResponseText, 'ai');
                        chat.messages.push({ sender: 'ai', text: aiResponseText });
                        
                        await App.dataManager.saveActiveChat();
                        App.tg.HapticFeedback.notificationOccurred('success');

                    } catch (error) {
                        console.error('Generation Error:', error);
                        indicator.remove();
                        const errorMessage = `Произошла ошибка: ${error.message}.`;
                        App.ui.addMessageToChat(errorMessage, 'ai');
                        chat.messages.push({ sender: 'ai', text: errorMessage });
                        await App.dataManager.saveActiveChat();
                        App.tg.HapticFeedback.notificationOccurred('error');
                    } finally {
                        App.ui.toggleGenerationButton(false);
                    }
                }
            },

            api: {
                async invokeFunction(name, body) {
                    const { data, error } = await App.supabase.functions.invoke(name, { body: body });
                    if (error) throw new Error(error.message || 'Function invocation failed');
                    return data;
                },
                createCodeGenerationPrompt(userPrompt, existingCode) {
                    const baseInstruction = `Твоя задача - быть экспертом по созданию html-приложений. Ты должен вернуть ТОЛЬКО HTML-код в одном блоке \`\`\`html ... \`\`\`. Без лишних слов, объяснений или комментариев вне кода. Код должен быть полным и самодостаточным (включая HTML, CSS в <style> и JS в <script>). Используй Tailwind CSS для стилизации.`;
                    return existingCode
                        ? `${baseInstruction}\nВот существующий код:\n\n${existingCode}\n\nЗапрос пользователя: "${userPrompt}".\nИзмени код и верни новую полную версию.`
                        : `${baseInstruction}\nЗапрос пользователя: "${userPrompt}".\nСоздай код с нуля.`;
                },
                async callGemini(prompt) {
                    const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${App.config.apiKey}`;
                    const payload = { contents: [{ parts: [{ text: prompt }] }] };
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error?.message || `HTTP ошибка: ${response.status}`);
                    }
                    const data = await response.json();
                    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                       throw new Error('Получен неверный или пустой ответ от API.');
                    }
                    return data.candidates[0].content.parts[0].text;
                }
            }
        };
        App.init();
    });
    </script>
</body>
</html>
